{"version":3,"file":"pebula-ngrid-material-sort.js","sources":["ng://@pebula/ngrid-material/sort/lib/mat-sort.directive.ts","ng://@pebula/ngrid-material/sort/lib/mat-sort-component-extension.ts","ng://@pebula/ngrid-material/sort/lib/mat-sort.module.ts"],"sourcesContent":["import { Directive, OnDestroy } from '@angular/core';\nimport { Sort, MatSort, MatSortHeader, SortDirection } from '@angular/material/sort';\n\nimport { PblNgridComponent, PblNgridPluginController, PblNgridSortDefinition, PblDataSource, utils } from '@pebula/ngrid';\n\ndeclare module '@pebula/ngrid/lib/ext/types' {\n  interface PblNgridPluginExtension {\n    matSort?: PblNgridMatSortDirective;\n  }\n}\nexport const PLUGIN_KEY: 'matSort' = 'matSort';\n\n@Directive({ selector: 'pbl-ngrid[matSort]', exportAs: 'pblMatSort' })\nexport class PblNgridMatSortDirective implements OnDestroy {\n  private _removePlugin: (table: PblNgridComponent<any>) => void;\n\n  constructor(public table: PblNgridComponent<any>, private pluginCtrl: PblNgridPluginController, public sort: MatSort) {\n    this._removePlugin = pluginCtrl.setPlugin(PLUGIN_KEY, this);\n\n    let origin: 'ds' | 'click' = 'click';\n    this.sort.sortChange\n      .pipe(utils.unrx(this))\n      .subscribe( s => {\n        this.onSort(s, origin);\n        origin = 'click';\n      });\n\n    const handleDataSourceSortChange = (sortChange: PblDataSource['sort']) => {\n      const { column } = sortChange;\n      const order = sortChange.sort ? sortChange.sort.order : undefined;\n\n      if (this.sort && column) {\n        if (this.sort.active === column.id && this.sort.direction === (order || '')) { return; }\n        const sortable: MatSortHeader = this.sort.sortables.get(column.id) as any;\n        if (sortable) {\n          origin = 'ds';\n          this.sort.active = undefined;\n          sortable.start = order || 'asc';\n          sortable._handleClick();\n        }\n      } else if (this.sort.active) { // clear mode (hit from code, not click).\n        const sortable: MatSortHeader = this.sort.sortables.get(this.sort.active) as any;\n        if (sortable ) {\n          if (!sortable.disableClear) {\n            let nextSortDir: SortDirection;\n            while (nextSortDir = this.sort.getNextSortDirection(sortable)) {\n              this.sort.direction = nextSortDir;\n            }\n          }\n          origin = 'ds';\n          sortable._handleClick();\n        }\n      }\n    }\n\n    pluginCtrl.events\n      .subscribe( e => {\n        if (e.kind === 'onInvalidateHeaders') {\n          const hasActiveSort = this.sort && this.sort.active;\n          if (table.ds && table.ds.sort) {\n            if (!table.ds.sort.column && hasActiveSort) {\n              this.onSort({ active: this.sort.active, direction: this.sort.direction || 'asc' }, origin);\n            } else if (table.ds.sort.column && !hasActiveSort) {\n              setTimeout(() => handleDataSourceSortChange(table.ds.sort));\n            }\n          }\n        }\n        if (e.kind === 'onDataSource') {\n          utils.unrx.kill(this, e.prev);\n          if (this.sort && this.sort.active) {\n            this.onSort({ active: this.sort.active, direction: this.sort.direction || 'asc' }, origin);\n          }\n          table.ds.sortChange\n            .pipe(utils.unrx(this, e.curr))\n            .subscribe( event => { handleDataSourceSortChange(event); });\n        }\n      });\n  }\n\n  ngOnDestroy(): void {\n    this._removePlugin(this.table);\n    utils.unrx.kill(this);\n  }\n\n  private onSort(sort: Sort, origin: 'ds' | 'click'): void {\n    const table = this.table;\n    const column = table.columnApi.visibleColumns.find(c => c.id === sort.active);\n\n    if ( origin !== 'click' || !column || !column.sort ) {\n      return;\n    } else {\n      const newSort: PblNgridSortDefinition = { };\n      const sortFn = typeof column.sort === 'function' && column.sort;\n      if (sort.direction) {\n        newSort.order = sort.direction;\n      }\n      if (sortFn) {\n        newSort.sortFn = sortFn;\n      }\n      const currentSort = table.ds.sort;\n      if (column === currentSort.column) {\n        const _sort = currentSort.sort || {};\n        if (newSort.order === _sort.order) {\n          return;\n        }\n      }\n      table.ds.setSort(column, newSort);\n    }\n  }\n\n}\n","import { ComponentFactory, ComponentRef, ComponentFactoryResolver } from '@angular/core';\nimport { MatSort, MatSortHeader } from '@angular/material/sort';\n\nimport { PblNgridMultiComponentRegistry, PblNgridDataHeaderExtensionContext } from '@pebula/ngrid';\n\nexport class MatSortExtension extends PblNgridMultiComponentRegistry<MatSortHeader, 'dataHeaderExtensions'> {\n  readonly name: 'sortContainer' = 'sortContainer';\n  readonly kind: 'dataHeaderExtensions' = 'dataHeaderExtensions';\n  readonly projectContent = true;\n\n  constructor(private cfr: ComponentFactoryResolver) {\n    super();\n  }\n\n  shouldRender(context: PblNgridDataHeaderExtensionContext): boolean {\n    return !!context.col.sort && !!context.injector.get(MatSort, false);\n  }\n\n  getFactory(context: PblNgridDataHeaderExtensionContext): ComponentFactory<MatSortHeader> {\n    return this.cfr.resolveComponentFactory(MatSortHeader);\n  }\n\n  onCreated(context: PblNgridDataHeaderExtensionContext, cmpRef: ComponentRef<MatSortHeader>): void {\n    // We assign the ID and also verify that it does not exist on the `MatSort` container\n    // It might exists on specific scenarios when a header is removed and added instantly but the \"add\" part happens before the teardown so the `MatSort` will throw.\n    this.deregisterId(context, cmpRef.instance.id = context.col.id);\n    cmpRef.changeDetectorRef.markForCheck();\n  }\n\n  /**\n   * Check that the current `MatSort` does not already have a sortable header with the provided id.\n   */\n  private deregisterId(context: PblNgridDataHeaderExtensionContext, id: any) {\n    const matSort = context.injector.get<MatSort>(MatSort);\n    const matSortHeader = matSort.sortables.get(id)\n    if (matSortHeader) {\n      matSort.deregister(matSortHeader);\n    }\n  }\n}\n","import { NgModule, ComponentFactoryResolver } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { MatSortModule, MatSortHeader } from '@angular/material/sort';\nimport { MatButtonModule } from '@angular/material/button';\n\nimport { PblNgridModule, PblNgridRegistryService, ngridPlugin } from '@pebula/ngrid';\nimport { PblNgridMatSortDirective, PLUGIN_KEY } from './mat-sort.directive';\nimport { MatSortExtension } from './mat-sort-component-extension';\n\n@NgModule({\n  imports: [ CommonModule, MatButtonModule, MatSortModule, PblNgridModule ],\n  declarations: [ PblNgridMatSortDirective ],\n  exports: [ PblNgridMatSortDirective, MatSortModule ],\n  // TODO: remove when ViewEngine is no longer supported by angular (V11 ???)\n  entryComponents: [ MatSortHeader ],\n})\nexport class PblNgridMatSortModule {\n  static readonly NGRID_PLUGIN = ngridPlugin({ id: PLUGIN_KEY }, PblNgridMatSortDirective);\n\n  constructor(private registry: PblNgridRegistryService, cfr: ComponentFactoryResolver) {\n    registry.addMulti('dataHeaderExtensions', new MatSortExtension(cfr));\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;IAUa,UAAU,GAAc;;IAMnC,kCAAmB,KAA6B,EAAU,UAAoC,EAAS,IAAa;QAApH,iBA6DC;QA7DkB,UAAK,GAAL,KAAK,CAAwB;QAAU,eAAU,GAAV,UAAU,CAA0B;QAAS,SAAI,GAAJ,IAAI,CAAS;QAClH,IAAI,CAAC,aAAa,GAAG,UAAU,CAAC,SAAS,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;;YAExD,MAAM,GAAmB,OAAO;QACpC,IAAI,CAAC,IAAI,CAAC,UAAU;aACjB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;aACtB,SAAS;;;;QAAE,UAAA,CAAC;YACX,KAAI,CAAC,MAAM,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC;YACvB,MAAM,GAAG,OAAO,CAAC;SAClB,EAAC,CAAC;;YAEC,0BAA0B;;;;QAAG,UAAC,UAAiC;YAC3D,IAAA,0BAAM;;gBACR,KAAK,GAAG,UAAU,CAAC,IAAI,GAAG,UAAU,CAAC,IAAI,CAAC,KAAK,GAAG,SAAS;YAEjE,IAAI,KAAI,CAAC,IAAI,IAAI,MAAM,EAAE;gBACvB,IAAI,KAAI,CAAC,IAAI,CAAC,MAAM,KAAK,MAAM,CAAC,EAAE,IAAI,KAAI,CAAC,IAAI,CAAC,SAAS,MAAM,KAAK,IAAI,EAAE,CAAC,EAAE;oBAAE,OAAO;iBAAE;;oBAClF,QAAQ,sBAAkB,KAAI,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,EAAO;gBACzE,IAAI,QAAQ,EAAE;oBACZ,MAAM,GAAG,IAAI,CAAC;oBACd,KAAI,CAAC,IAAI,CAAC,MAAM,GAAG,SAAS,CAAC;oBAC7B,QAAQ,CAAC,KAAK,GAAG,KAAK,IAAI,KAAK,CAAC;oBAChC,QAAQ,CAAC,YAAY,EAAE,CAAC;iBACzB;aACF;iBAAM,IAAI,KAAI,CAAC,IAAI,CAAC,MAAM,EAAE;;;oBACrB,QAAQ,sBAAkB,KAAI,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,KAAI,CAAC,IAAI,CAAC,MAAM,CAAC,EAAO;gBAChF,IAAI,QAAQ,EAAG;oBACb,IAAI,CAAC,QAAQ,CAAC,YAAY,EAAE;;4BACtB,WAAW,SAAe;wBAC9B,OAAO,WAAW,GAAG,KAAI,CAAC,IAAI,CAAC,oBAAoB,CAAC,QAAQ,CAAC,EAAE;4BAC7D,KAAI,CAAC,IAAI,CAAC,SAAS,GAAG,WAAW,CAAC;yBACnC;qBACF;oBACD,MAAM,GAAG,IAAI,CAAC;oBACd,QAAQ,CAAC,YAAY,EAAE,CAAC;iBACzB;aACF;SACF,CAAA;QAED,UAAU,CAAC,MAAM;aACd,SAAS;;;;QAAE,UAAA,CAAC;YACX,IAAI,CAAC,CAAC,IAAI,KAAK,qBAAqB,EAAE;;oBAC9B,aAAa,GAAG,KAAI,CAAC,IAAI,IAAI,KAAI,CAAC,IAAI,CAAC,MAAM;gBACnD,IAAI,KAAK,CAAC,EAAE,IAAI,KAAK,CAAC,EAAE,CAAC,IAAI,EAAE;oBAC7B,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,MAAM,IAAI,aAAa,EAAE;wBAC1C,KAAI,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,KAAI,CAAC,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,KAAI,CAAC,IAAI,CAAC,SAAS,IAAI,KAAK,EAAE,EAAE,MAAM,CAAC,CAAC;qBAC5F;yBAAM,IAAI,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,aAAa,EAAE;wBACjD,UAAU;;;wBAAC,cAAM,OAAA,0BAA0B,CAAC,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,GAAA,EAAC,CAAC;qBAC7D;iBACF;aACF;YACD,IAAI,CAAC,CAAC,IAAI,KAAK,cAAc,EAAE;gBAC7B,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,KAAI,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC;gBAC9B,IAAI,KAAI,CAAC,IAAI,IAAI,KAAI,CAAC,IAAI,CAAC,MAAM,EAAE;oBACjC,KAAI,CAAC,MAAM,CAAC,EAAE,MAAM,EAAE,KAAI,CAAC,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,KAAI,CAAC,IAAI,CAAC,SAAS,IAAI,KAAK,EAAE,EAAE,MAAM,CAAC,CAAC;iBAC5F;gBACD,KAAK,CAAC,EAAE,CAAC,UAAU;qBAChB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAI,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC;qBAC9B,SAAS;;;;gBAAE,UAAA,KAAK,IAAM,0BAA0B,CAAC,KAAK,CAAC,CAAC,EAAE,EAAC,CAAC;aAChE;SACF,EAAC,CAAC;KACN;;;;IAED,8CAAW;;;IAAX;QACE,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC/B,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;KACvB;;;;;;;IAEO,yCAAM;;;;;;IAAd,UAAe,IAAU,EAAE,MAAsB;;YACzC,KAAK,GAAG,IAAI,CAAC,KAAK;;YAClB,MAAM,GAAG,KAAK,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI;;;;QAAC,UAAA,CAAC,IAAI,OAAA,CAAC,CAAC,EAAE,KAAK,IAAI,CAAC,MAAM,GAAA,EAAC;QAE7E,IAAK,MAAM,KAAK,OAAO,IAAI,CAAC,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,EAAG;YACnD,OAAO;SACR;aAAM;;gBACC,OAAO,GAA2B,EAAG;;gBACrC,MAAM,GAAG,OAAO,MAAM,CAAC,IAAI,KAAK,UAAU,IAAI,MAAM,CAAC,IAAI;YAC/D,IAAI,IAAI,CAAC,SAAS,EAAE;gBAClB,OAAO,CAAC,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC;aAChC;YACD,IAAI,MAAM,EAAE;gBACV,OAAO,CAAC,MAAM,GAAG,MAAM,CAAC;aACzB;;gBACK,WAAW,GAAG,KAAK,CAAC,EAAE,CAAC,IAAI;YACjC,IAAI,MAAM,KAAK,WAAW,CAAC,MAAM,EAAE;;oBAC3B,KAAK,GAAG,WAAW,CAAC,IAAI,IAAI,EAAE;gBACpC,IAAI,OAAO,CAAC,KAAK,KAAK,KAAK,CAAC,KAAK,EAAE;oBACjC,OAAO;iBACR;aACF;YACD,KAAK,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;SACnC;KACF;;gBAhGF,SAAS,SAAC,EAAE,QAAQ,EAAE,oBAAoB,EAAE,QAAQ,EAAE,YAAY,EAAE;;;;gBAT5D,iBAAiB;gBAAE,wBAAwB;gBAFrC,OAAO;;IA6GtB,+BAAC;CAlGD,IAkGC;;;;;;IAhGC,iDAA+D;;IAEnD,yCAAoC;;;;;IAAE,8CAA4C;;IAAE,wCAAoB;;;;;;;;ACXtH;IAAsC,oCAAqE;IAKzG,0BAAoB,GAA6B;QAAjD,YACE,iBAAO,SACR;QAFmB,SAAG,GAAH,GAAG,CAA0B;QAJxC,UAAI,GAAoB,eAAe,CAAC;QACxC,UAAI,GAA2B,sBAAsB,CAAC;QACtD,oBAAc,GAAG,IAAI,CAAC;;KAI9B;;;;;IAED,uCAAY;;;;IAAZ,UAAa,OAA2C;QACtD,OAAO,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,IAAI,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;KACrE;;;;;IAED,qCAAU;;;;IAAV,UAAW,OAA2C;QACpD,OAAO,IAAI,CAAC,GAAG,CAAC,uBAAuB,CAAC,aAAa,CAAC,CAAC;KACxD;;;;;;IAED,oCAAS;;;;;IAAT,UAAU,OAA2C,EAAE,MAAmC;;;QAGxF,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE,MAAM,CAAC,QAAQ,CAAC,EAAE,GAAG,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;QAChE,MAAM,CAAC,iBAAiB,CAAC,YAAY,EAAE,CAAC;KACzC;;;;;;;;;;;IAKO,uCAAY;;;;;;;IAApB,UAAqB,OAA2C,EAAE,EAAO;;YACjE,OAAO,GAAG,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAU,OAAO,CAAC;;YAChD,aAAa,GAAG,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,EAAE,CAAC;QAC/C,IAAI,aAAa,EAAE;YACjB,OAAO,CAAC,UAAU,CAAC,aAAa,CAAC,CAAC;SACnC;KACF;IACH,uBAAC;AAAD,CAlCA,CAAsC,8BAA8B,GAkCnE;;;IAjCC,gCAAiD;;IACjD,gCAA+D;;IAC/D,0CAA+B;;;;;IAEnB,+BAAqC;;;;;;;;;ICSjD,+BAAoB,QAAiC,EAAE,GAA6B;QAAhE,aAAQ,GAAR,QAAQ,CAAyB;QACnD,QAAQ,CAAC,QAAQ,CAAC,sBAAsB,EAAE,IAAI,gBAAgB,CAAC,GAAG,CAAC,CAAC,CAAC;KACtE;IAJe,kCAAY,GAAG,WAAW,CAAC,EAAE,EAAE,EAAE,UAAU,EAAE,EAAE,wBAAwB,CAAC,CAAC;;gBAR1F,QAAQ,SAAC;oBACR,OAAO,EAAE,CAAE,YAAY,EAAE,eAAe,EAAE,aAAa,EAAE,cAAc,CAAE;oBACzE,YAAY,EAAE,CAAE,wBAAwB,CAAE;oBAC1C,OAAO,EAAE,CAAE,wBAAwB,EAAE,aAAa,CAAE;;oBAEpD,eAAe,EAAE,CAAE,aAAa,CAAE;iBACnC;;;;gBAVwB,uBAAuB;gBAL7B,wBAAwB;;IAsB3C,4BAAC;CAbD,IAaC;;;IALC,mCAAyF;;;;;IAE7E,yCAAyC;;;;;;;;;;;;;;;;;"}