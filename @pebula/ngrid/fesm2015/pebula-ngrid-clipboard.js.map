{"version":3,"file":"pebula-ngrid-clipboard.js","sources":["ng://@pebula/ngrid/clipboard/lib/clipboard.service.ts","ng://@pebula/ngrid/clipboard/lib/clipboard.plugin.ts","ng://@pebula/ngrid/clipboard/lib/clipboard.module.ts"],"sourcesContent":["/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {DOCUMENT} from '@angular/common';\nimport {Inject, Injectable} from '@angular/core';\n\n /**\n * A service for copying text to the clipboard.\n *\n * Example usage:\n *\n * clipboard.copy(\"copy this text\");\n */\n@Injectable({providedIn: 'root'})\nexport class Clipboard {\n  private _document: Document;\n\n   constructor(@Inject(DOCUMENT) document: any) {\n    this._document = document;\n  }\n\n   /**\n   * Copies the provided text into the user's clipboard.\n   *\n   * @param text The string to copy.\n   * @returns Whether the operation was successful.\n   */\n  copy(text: string): boolean {\n    const pendingCopy = this.beginCopy(text);\n    const successful = pendingCopy.copy();\n    pendingCopy.destroy();\n\n     return successful;\n  }\n\n   /**\n   * Prepares a string to be copied later. This is useful for large strings\n   * which take too long to successfully render and be copied in the same tick.\n   *\n   * The caller must call `destroy` on the returned `PendingCopy`.\n   *\n   * @param text The string to copy.\n   * @returns the pending copy operation.\n   */\n  beginCopy(text: string): PendingCopy {\n    return new PendingCopy(text, this._document);\n  }\n}\n\n /**\n * A pending copy-to-clipboard operation.\n *\n * The implementation of copying text to the clipboard modifies the DOM and\n * forces a relayout. This relayout can take too long if the string is large,\n * causing the execCommand('copy') to happen too long after the user clicked.\n * This results in the browser refusing to copy. This object lets the\n * relayout happen in a separate tick from copying by providing a copy function\n * that can be called later.\n *\n * Destroy must be called when no longer in use, regardless of whether `copy` is\n * called.\n */\nexport class PendingCopy {\n  private _textarea: HTMLTextAreaElement|undefined;\n\n   constructor(text: string, private readonly _document: Document) {\n    const textarea = this._textarea = this._document.createElement('textarea');\n\n     // Hide the element for display and accessibility.\n    textarea.setAttribute('style', 'opacity: 0;');\n    textarea.setAttribute('aria-hidden', 'true');\n\n     textarea.value = text;\n    this._document.body.appendChild(textarea);\n  }\n\n   /** Finishes copying the text. */\n  copy(): boolean {\n    const textarea = this._textarea;\n    let successful = false;\n\n     try {  // Older browsers could throw if copy is not supported.\n      if (textarea) {\n        const currentFocus = document.activeElement;\n\n         textarea.select();\n        successful = this._document.execCommand('copy');\n\n         if (currentFocus instanceof HTMLElement) {\n          currentFocus.focus();\n        }\n      }\n    } catch {\n      // Discard error.\n      // Initial setting of {@code successful} will represent failure here.\n    }\n\n     return successful;\n  }\n\n   /** Cleans up DOM changes used to perform the copy operation. */\n  destroy() {\n    if (this._textarea) {\n      this._document.body.removeChild(this._textarea);\n      this._textarea = undefined;\n    }\n  }\n}\n","import { filter } from 'rxjs/operators';\nimport { Directive, Injector, OnDestroy, Input } from '@angular/core';\n\n// import { Clipboard } from '@angular/cdk-experimental/clipboard';\n// TODO: remove internal implementation in the next version of cdk-experimental (right after 8.1.3)\nimport { Clipboard } from './clipboard.service';\n\nimport { UnRx } from '@pebula/utils';\nimport { PblNgridComponent, PblNgridPluginController, NgridPlugin, PblNgridConfigService } from '@pebula/ngrid';\n\ndeclare module '@pebula/ngrid/lib/ext/types' {\n  interface PblNgridPluginExtension {\n    clipboard?: PblNgridClipboardPlugin;\n  }\n  interface PblNgridPluginExtensionFactories {\n    clipboard: keyof typeof PblNgridClipboardPlugin;\n  }\n}\n\ndeclare module '@pebula/ngrid/lib/grid/services/config' {\n  interface PblNgridConfig {\n    clipboard?: {\n      /** When set to true will enable the clipboard plugin on all grid instances by default. */\n      autoEnable?: boolean;\n      /**\n       * The separator to use when multiple cells are copied\n       * @default \\t\n       */\n      cellSeparator?: string;\n      /**\n       * The separator to use when multiple rows are copied\n       * @default \\n\n       */\n      rowSeparator?: string;\n    };\n  }\n}\n\nconst IS_OSX = /^mac/.test(navigator.platform.toLowerCase())\nconst DEFAULT_CELL_SEP = '\\t';\nconst DEFAULT_ROW_SEP = '\\n';\n\nexport const PLUGIN_KEY: 'clipboard' = 'clipboard';\n\n@NgridPlugin({ id: PLUGIN_KEY, factory: 'create' })\n@Directive({ selector: 'pbl-ngrid[clipboard]', exportAs: 'pblNgridClipboard' })\n@UnRx()\nexport class PblNgridClipboardPlugin implements OnDestroy {\n\n  static create(grid: PblNgridComponent, injector: Injector): PblNgridClipboardPlugin {\n    const pluginCtrl = PblNgridPluginController.find(grid);\n    return new PblNgridClipboardPlugin(grid, injector, pluginCtrl);\n  }\n\n  /**\n   * The separator to use when multiple cells are copied.\n   * If not set, taken from `PblNgridConfig.clipboard.cellSeparator`\n   * @default \\t\n   */\n  @Input() clpCellSep: string;\n\n  /**\n   * The separator to use when multiple rows are copied\n   * If not set, taken from `PblNgridConfig.clipboard.rowSeparator`\n   * @default \\n\n   */\n  @Input() clpRowSep: string;\n\n  private config: PblNgridConfigService;\n  private clipboard: Clipboard;\n  private _removePlugin: (grid: PblNgridComponent) => void;\n\n  constructor(public grid: PblNgridComponent<any>, protected injector: Injector, protected pluginCtrl: PblNgridPluginController) {\n    this.config = injector.get(PblNgridConfigService)\n    this.clipboard = injector.get(Clipboard);\n    this.init();\n  }\n\n  ngOnDestroy(): void {\n    this._removePlugin(this.grid);\n  }\n\n  protected isCopyEvent(event: Event): boolean {\n    if (event instanceof KeyboardEvent && event.key === 'c') {\n      if ((!IS_OSX && event.ctrlKey) || (IS_OSX && event.metaKey)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  protected doCopy(): void {\n    const { cellSeparator, rowSeparator } = this.config.get('clipboard', {});\n    const { rows, minIndex } = this.getSelectedRowData(this.grid);\n    const createRow = (row: any[]) => row.slice(minIndex).join(this.clpCellSep || cellSeparator || DEFAULT_CELL_SEP);\n    // For each row (collection of items), slice the initial items that are not copied across all selections\n\n    this.clipboard.copy(rows.map(createRow).join(this.clpRowSep || rowSeparator || DEFAULT_ROW_SEP));\n    // TODO: Consider using `beginCopy` to support large copy operations\n  }\n\n  protected getSelectedRowData(grid: PblNgridComponent) {\n    const { columnApi, contextApi } = grid;\n    const data = new Map<any, any[]>();\n\n    // The minIndex represents the first column being copied out of all visible columns (0 being the first visible column).\n    // For every selected cell, the column is tracked and it's index is being set to `minIndex` if it is lower then the current `minIndex` (Math.Min).\n    // We start with the biggest int but right away get a valid column index...\n    // Later on, each row is sliced to remove the items in indices lower then the `minIndex`.\n    //\n    // All of this is to make the paste start without leading cell separators.\n    let minIndex = Number.MAX_SAFE_INTEGER;\n\n    for (const point of contextApi.selectedCells) {\n      const col = columnApi.columns[point.colIndex];\n      if (col) {\n        const colIndex = columnApi.renderIndexOf(col);\n        if (colIndex > -1) {\n          const rowIndex = contextApi.findRowInCache(point.rowIdent).dataIndex;\n          const dataItem = col.getValue(grid.ds.source[rowIndex]);\n          const row = data.get(point.rowIdent) || [];\n          row[colIndex] = dataItem;\n          data.set(point.rowIdent, row);\n          minIndex = Math.min(minIndex, colIndex);\n        }\n      }\n    }\n\n    return {\n      minIndex,\n      rows: Array.from(data.values()),\n    };\n  }\n\n  private init(): void {\n    this._removePlugin = this.pluginCtrl.setPlugin(PLUGIN_KEY, this);\n\n    if (!this.pluginCtrl.hasPlugin('targetEvents')) {\n      this.pluginCtrl.createPlugin('targetEvents');\n    }\n\n    const targetEvents = this.pluginCtrl.getPlugin('targetEvents');\n    targetEvents.keyDown\n      .pipe(\n        filter( event => this.isCopyEvent(event.source) ),\n        UnRx(this)\n      )\n      .subscribe( event => this.doCopy() );\n  }\n}\n","import { first, filter } from 'rxjs/operators';\nimport { NgModule, Optional, SkipSelf } from '@angular/core';\nimport { CommonModule } from '@angular/common';\n\nimport { PblNgridModule, PblNgridConfigService, PblNgridPluginController } from '@pebula/ngrid';\nimport { PblNgridTargetEventsModule } from '@pebula/ngrid/target-events';\n\nimport { PLUGIN_KEY, PblNgridClipboardPlugin } from './clipboard.plugin';\n\n@NgModule({\n  imports: [ CommonModule, PblNgridModule, PblNgridTargetEventsModule ],\n  declarations: [ PblNgridClipboardPlugin ],\n  exports: [ PblNgridClipboardPlugin ],\n})\nexport class PblNgridClipboardPluginModule {\n  constructor(@Optional() @SkipSelf() parentModule: PblNgridClipboardPluginModule,\n              configService: PblNgridConfigService) {\n\n    if (parentModule) {\n      return;\n    }\n    PblNgridPluginController.created\n      .subscribe( event => {\n        const config = configService.get(PLUGIN_KEY, {});\n        if (config.autoEnable === true) {\n          const pluginCtrl = event.controller;\n          pluginCtrl.events\n            .pipe(\n              filter( e => e.kind === 'onInit' ),\n              first(),\n            )\n            .subscribe( e => {\n              if (!pluginCtrl.hasPlugin(PLUGIN_KEY)) {\n                pluginCtrl.createPlugin(PLUGIN_KEY);\n              }\n            });\n        }\n      });\n  }\n}\n"],"names":[],"mappings":"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"}