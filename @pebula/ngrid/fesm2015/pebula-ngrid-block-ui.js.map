{"version":3,"file":"pebula-ngrid-block-ui.js","sources":["ng://@pebula/ngrid/block-ui/lib/block-ui/directives.ts","ng://@pebula/ngrid/block-ui/lib/block-ui/block-ui-plugin.ts","ng://@pebula/ngrid/block-ui/lib/table-block-ui.module.ts"],"sourcesContent":["// tslint:disable:use-host-property-decorator\nimport { Directive, TemplateRef } from '@angular/core';\nimport { PblNgridComponent, PblNgridRegistryService, PblNgridSingleTemplateRegistry } from '@pebula/ngrid';\n\ndeclare module '@pebula/ngrid/lib/table/services/table-registry.service' {\n  interface PblNgridSingleRegistryMap {\n    blocker?: PblNgridBlockUiDefDirective;\n  }\n}\n\n/**\n * Marks the element as the display element when the form is busy.\n */\n@Directive({ selector: '[pblNgridBlockUiDef]' })\nexport class PblNgridBlockUiDefDirective extends PblNgridSingleTemplateRegistry<{ $implicit: PblNgridComponent<any> }, 'blocker'> {\n  readonly kind = 'blocker';\n  constructor(tRef: TemplateRef<{ $implicit: PblNgridComponent<any> }>, registry: PblNgridRegistryService) { super(tRef, registry); }\n}\n","import { Observable, isObservable } from 'rxjs';\nimport { Directive, EmbeddedViewRef, Input, OnDestroy } from '@angular/core';\nimport { coerceBooleanProperty } from '@angular/cdk/coercion';\n\nimport { UnRx } from '@pebula/utils';\nimport { PblNgridComponent, PblNgridPluginController, TablePlugin } from '@pebula/ngrid';\n\ndeclare module '@pebula/ngrid/lib/ext/types' {\n  interface PblNgridPluginExtension {\n    blockUi?: { blockUi: boolean | 'auto' | Observable<boolean> };\n  }\n}\n\nconst PLUGIN_KEY: 'blockUi' = 'blockUi';\n\n@TablePlugin({ id: PLUGIN_KEY })\n@Directive({ selector: 'pbl-ngrid[blockUi]', exportAs: 'blockUi' })\n@UnRx()\nexport class PblNgridBlockUiPluginDirective<T> implements OnDestroy {\n\n  /**\n   * Blocks the UI with the template defined via `PblNgridBlockUiDefDirective`.\n   * If a template does not exist blocking is ignored.\n   *\n   * There are 3 operation modes, the modes are set based on the input value:\n   *   - Auto mode (INPUT: 'auto')\n   *     The UI will be blocked automatically based on datasource changes.\n   *\n   *    - Manual mode (INPUT: boolean)\n   *     The UI will be block is toggled based on the value, i.e. `true` will block and false will unblock.\n   *\n   *   - Notification mode (INPUT: Observable<boolean>)\n   *     Similar to Manual mode but controlled by a stream boolean value.\n   *\n   * **Note about Notification mode**\n   * Notification mode accepts an observable, at the point where the value is set the block state does not change (if it was \"on\" it will stay \"on\" and vice versa)\n   * It will only change on the first emission, this is important to understand.\n   *\n   * For example, if the current block state is off and we pass a `Subject`, the state remains off until the next emission\n   * of the `Subject` is `true`. If it already emitted `true` before the assignment it will not be taken into account. This is why\n   * using `BehaviouralSubject` is preferred.\n   *\n   * Also note that when sending an observable it is treated as \"notifier\", do not send cold observable as they get subscribed to.\n   * For example, sending the returned value from `HttpClient` will probably result in 2 HTTP calls, if you already subscribed to it\n   * > The default value is `auto` which means that `<pbl-ngrid blockUi>` is similar to `<pbl-ngrid blockUi=\"auto\">`\n   */\n  @Input() get blockUi(): boolean | 'auto' | Observable<boolean> { return this._blockUi; }\n  set blockUi(value: boolean | 'auto' | Observable<boolean>) {\n    let coerced: boolean | 'auto' = coerceBooleanProperty(value);\n    if (coerced && (value === 'auto' || (value as any) === '')) {\n      coerced = 'auto';\n    }\n\n    if (isObservable(value) && this._blockUi !== value) {\n      if (isObservable(this._blockUi)) {\n        UnRx.kill(this, this._blockUi);\n      }\n      this._blockUi = value;\n      value.pipe(UnRx(this, this._blockUi)).subscribe( state => {\n        this._blockInProgress = state;\n        this.setupBlocker();\n      });\n    } else if (this._blockUi !== coerced) {\n      this._blockUi = coerced;\n      if (coerced !== 'auto') {\n        this._blockInProgress = coerced;\n        this.setupBlocker();\n      }\n    }\n  }\n\n  private _blockInProgress: boolean = false;\n  private _blockUi: boolean | 'auto' | Observable<boolean>;\n  private _blockerEmbeddedVRef: EmbeddedViewRef<any>;\n  private _removePlugin: (table: PblNgridComponent<any>) => void;\n\n  constructor(private table: PblNgridComponent<any>, pluginCtrl: PblNgridPluginController<T>) {\n    this._removePlugin = pluginCtrl.setPlugin(PLUGIN_KEY, this);\n\n    table.registry.changes.subscribe( changes => {\n      for (const c of changes) {\n        switch (c.type) {\n          case 'blocker':\n            this.setupBlocker();\n            break;\n        }\n      }\n    });\n\n    pluginCtrl.events\n      .subscribe( event => {\n        if (event.kind === 'onDataSource') {\n          const { prev, curr } = event;\n          if (prev) {\n            UnRx.kill(this, prev);\n          }\n          curr.onSourceChanging\n            .pipe(UnRx(this, curr))\n            .subscribe( () => {\n              if (this._blockUi === 'auto') {\n                this._blockInProgress = true;\n                this.setupBlocker();\n              }\n            });\n          curr.onSourceChanged\n            .pipe(UnRx(this, curr))\n            .subscribe( () => {\n              if (this._blockUi === 'auto') {\n                this._blockInProgress = false;\n                this.setupBlocker();\n              }\n            });\n        }\n      });\n  }\n\n\n  ngOnDestroy(): void {\n    this._removePlugin(this.table);\n  }\n\n  private setupBlocker(): void {\n    const state = this._blockInProgress;\n    if (state) {\n      if (!this._blockerEmbeddedVRef) {\n        const blockerTemplate = this.table.registry.getSingle('blocker');\n        if (blockerTemplate) {\n          this._blockerEmbeddedVRef = this.table.createView('afterContent', blockerTemplate.tRef, { $implicit: this.table });\n          this._blockerEmbeddedVRef.detectChanges();\n        }\n      }\n    } else if (this._blockerEmbeddedVRef) {\n      this.table.removeView(this._blockerEmbeddedVRef, 'afterContent');\n      this._blockerEmbeddedVRef = undefined;\n    }\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\n\nimport { CdkTableModule } from '@angular/cdk/table';\nimport { PblNgridModule } from '@pebula/ngrid';\nimport { PblNgridBlockUiDefDirective } from './block-ui/directives';\nimport { PblNgridBlockUiPluginDirective } from './block-ui/block-ui-plugin';\n\n@NgModule({\n  imports: [ CommonModule, CdkTableModule, PblNgridModule ],\n  declarations: [ PblNgridBlockUiDefDirective, PblNgridBlockUiPluginDirective ],\n  exports: [  PblNgridBlockUiDefDirective, PblNgridBlockUiPluginDirective  ]\n})\nexport class PblNgridBlockUiModule { }\n"],"names":[],"mappings":"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"}