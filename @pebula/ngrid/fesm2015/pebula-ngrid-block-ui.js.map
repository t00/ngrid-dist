{"version":3,"file":"pebula-ngrid-block-ui.js","sources":["../../../../libs/ngrid/block-ui/src/lib/block-ui/directives.ts","../../../../libs/ngrid/block-ui/src/lib/block-ui/block-ui-plugin.ts","../../../../libs/ngrid/block-ui/src/lib/table-block-ui.module.ts","../../../../libs/ngrid/block-ui/src/pebula-ngrid-block-ui.ts"],"sourcesContent":["// tslint:disable:use-host-property-decorator\nimport { Directive, TemplateRef } from '@angular/core';\nimport { PblNgridComponent, PblNgridRegistryService, PblNgridSingleTemplateRegistry } from '@pebula/ngrid';\n\ndeclare module '@pebula/ngrid/core/lib/registry/types' {\n  interface PblNgridSingleRegistryMap {\n    blocker?: PblNgridBlockUiDefDirective;\n  }\n}\n\n/**\n * Marks the element as the display element when the form is busy.\n */\n@Directive({ selector: '[pblNgridBlockUiDef]' })\nexport class PblNgridBlockUiDefDirective extends PblNgridSingleTemplateRegistry<{ $implicit: PblNgridComponent<any> }, 'blocker'> {\n  readonly kind = 'blocker';\n  constructor(tRef: TemplateRef<{ $implicit: PblNgridComponent<any> }>, registry: PblNgridRegistryService) { super(tRef, registry); }\n}\n","import { Observable, isObservable } from 'rxjs';\nimport { Directive, EmbeddedViewRef, Input, OnDestroy } from '@angular/core';\nimport { coerceBooleanProperty, BooleanInput } from '@angular/cdk/coercion';\n\nimport { unrx } from '@pebula/ngrid/core';\nimport { PblNgridComponent, PblNgridPluginController } from '@pebula/ngrid';\n\ndeclare module '@pebula/ngrid/lib/ext/types' {\n  interface PblNgridPluginExtension {\n    blockUi?: { blockUi: BooleanInput | 'auto' | Observable<boolean> };\n  }\n}\n\nexport const PLUGIN_KEY: 'blockUi' = 'blockUi';\n\n@Directive({ selector: 'pbl-ngrid[blockUi]', exportAs: 'blockUi' })\nexport class PblNgridBlockUiPluginDirective<T> implements OnDestroy {\n\n  /**\n   * Blocks the UI with the template defined via `PblNgridBlockUiDefDirective`.\n   * If a template does not exist blocking is ignored.\n   *\n   * There are 3 operation modes, the modes are set based on the input value:\n   *   - Auto mode (INPUT: 'auto')\n   *     The UI will be blocked automatically based on datasource changes.\n   *\n   *    - Manual mode (INPUT: boolean)\n   *     The UI will be block is toggled based on the value, i.e. `true` will block and false will unblock.\n   *\n   *   - Notification mode (INPUT: Observable<boolean>)\n   *     Similar to Manual mode but controlled by a stream boolean value.\n   *\n   * **Note about Notification mode**\n   * Notification mode accepts an observable, at the point where the value is set the block state does not change (if it was \"on\" it will stay \"on\" and vice versa)\n   * It will only change on the first emission, this is important to understand.\n   *\n   * For example, if the current block state is off and we pass a `Subject`, the state remains off until the next emission\n   * of the `Subject` is `true`. If it already emitted `true` before the assignment it will not be taken into account. This is why\n   * using `BehaviouralSubject` is preferred.\n   *\n   * Also note that when sending an observable it is treated as \"notifier\", do not send cold observable as they get subscribed to.\n   * For example, sending the returned value from `HttpClient` will probably result in 2 HTTP calls, if you already subscribed to it\n   * > The default value is `auto` which means that `<pbl-ngrid blockUi>` is similar to `<pbl-ngrid blockUi=\"auto\">`\n   */\n  @Input() get blockUi(): BooleanInput | 'auto' | Observable<boolean> { return this._blockUi; }\n  set blockUi(value: BooleanInput | 'auto' | Observable<boolean>) {\n    let coerced: boolean | 'auto' = coerceBooleanProperty(value);\n    if (coerced && (value === 'auto' || (value as any) === '')) {\n      coerced = 'auto';\n    }\n\n    if (isObservable(value) && this._blockUi !== value) {\n      if (isObservable(this._blockUi)) {\n        unrx.kill(this, this._blockUi);\n      }\n      this._blockUi = value;\n      value\n        .pipe(unrx(this, this._blockUi))\n        .subscribe( state => {\n          this._blockInProgress = state;\n          this.setupBlocker();\n        });\n    } else if (this._blockUi !== coerced) {\n      this._blockUi = coerced;\n      if (coerced !== 'auto') {\n        this._blockInProgress = coerced;\n        this.setupBlocker();\n      }\n    }\n  }\n\n  private _blockInProgress = false;\n  private _blockUi: boolean | 'auto' | Observable<boolean>;\n  private _blockerEmbeddedVRef: EmbeddedViewRef<any>;\n  private _removePlugin: (grid: PblNgridComponent<any>) => void;\n\n  constructor(private grid: PblNgridComponent<any>, pluginCtrl: PblNgridPluginController<T>) {\n    this._removePlugin = pluginCtrl.setPlugin(PLUGIN_KEY, this);\n\n    grid.registry.changes.subscribe( changes => {\n      for (const c of changes) {\n        switch (c.type) {\n          case 'blocker':\n            this.setupBlocker();\n            break;\n        }\n      }\n    });\n\n    pluginCtrl.onInit()\n      .subscribe( isInitNow => {\n        if (isInitNow && this._blockUi && typeof this._blockUi === 'boolean') {\n          this.setupBlocker();\n        }\n      });\n\n    pluginCtrl.events\n      .subscribe( event => {\n        if (event.kind === 'onDataSource') {\n          const { prev, curr } = event;\n          if (prev) {\n            unrx.kill(this, prev);\n          }\n          curr.onSourceChanging\n            .pipe(unrx(this, curr))\n            .subscribe( () => {\n              if (this._blockUi === 'auto') {\n                this._blockInProgress = true;\n                this.setupBlocker();\n              }\n            });\n          curr.onSourceChanged\n            .pipe(unrx(this, curr))\n            .subscribe( () => {\n              if (this._blockUi === 'auto') {\n                this._blockInProgress = false;\n                this.setupBlocker();\n              }\n            });\n        }\n      });\n  }\n\n  ngOnDestroy(): void {\n    unrx.kill(this);\n    this._removePlugin(this.grid);\n  }\n\n  private setupBlocker(): void {\n    if (this.grid.isInit) {\n      const state = this._blockInProgress;\n      if (state) {\n        if (!this._blockerEmbeddedVRef) {\n          const blockerTemplate = this.grid.registry.getSingle('blocker');\n          if (blockerTemplate) {\n            this._blockerEmbeddedVRef = this.grid.createView('afterContent', blockerTemplate.tRef, { $implicit: this.grid });\n            this._blockerEmbeddedVRef.detectChanges();\n          }\n        }\n      } else if (this._blockerEmbeddedVRef) {\n        this.grid.removeView(this._blockerEmbeddedVRef, 'afterContent');\n        this._blockerEmbeddedVRef = undefined;\n      }\n    }\n  }\n\n  static ngAcceptInputType_blockUi: BooleanInput;\n}\n","import { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\n\nimport { CdkTableModule } from '@angular/cdk/table';\nimport { PblNgridModule, ngridPlugin } from '@pebula/ngrid';\nimport { PblNgridBlockUiDefDirective } from './block-ui/directives';\nimport { PblNgridBlockUiPluginDirective, PLUGIN_KEY } from './block-ui/block-ui-plugin';\n\n@NgModule({\n  imports: [ CommonModule, CdkTableModule, PblNgridModule ],\n  declarations: [ PblNgridBlockUiDefDirective, PblNgridBlockUiPluginDirective ],\n  exports: [  PblNgridBlockUiDefDirective, PblNgridBlockUiPluginDirective  ]\n})\nexport class PblNgridBlockUiModule {\n  static readonly NGRID_PLUGIN = ngridPlugin({ id: PLUGIN_KEY }, PblNgridBlockUiPluginDirective);\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":";;;;;;;;;;AAAA;AAUA;;;MAIa,2BAA4B,SAAQ,8BAAgF;IAE/H,YAAY,IAAwD,EAAE,QAAiC;QAAI,KAAK,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;QADxH,SAAI,GAAG,SAAS,CAAC;KACyG;;2IAFxH,2BAA2B;+HAA3B,2BAA2B;2FAA3B,2BAA2B;kBADvC,SAAS;mBAAC,EAAE,QAAQ,EAAE,sBAAsB,EAAE;;;ACAxC,MAAM,UAAU,GAAc,SAAS,CAAC;MAGlC,8BAA8B;IA4DzC,YAAoB,IAA4B,EAAE,UAAuC;QAArE,SAAI,GAAJ,IAAI,CAAwB;QALxC,qBAAgB,GAAG,KAAK,CAAC;QAM/B,IAAI,CAAC,aAAa,GAAG,UAAU,CAAC,SAAS,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;QAE5D,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAE,OAAO;YACtC,KAAK,MAAM,CAAC,IAAI,OAAO,EAAE;gBACvB,QAAQ,CAAC,CAAC,IAAI;oBACZ,KAAK,SAAS;wBACZ,IAAI,CAAC,YAAY,EAAE,CAAC;wBACpB,MAAM;iBACT;aACF;SACF,CAAC,CAAC;QAEH,UAAU,CAAC,MAAM,EAAE;aAChB,SAAS,CAAE,SAAS;YACnB,IAAI,SAAS,IAAI,IAAI,CAAC,QAAQ,IAAI,OAAO,IAAI,CAAC,QAAQ,KAAK,SAAS,EAAE;gBACpE,IAAI,CAAC,YAAY,EAAE,CAAC;aACrB;SACF,CAAC,CAAC;QAEL,UAAU,CAAC,MAAM;aACd,SAAS,CAAE,KAAK;YACf,IAAI,KAAK,CAAC,IAAI,KAAK,cAAc,EAAE;gBACjC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,KAAK,CAAC;gBAC7B,IAAI,IAAI,EAAE;oBACR,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;iBACvB;gBACD,IAAI,CAAC,gBAAgB;qBAClB,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;qBACtB,SAAS,CAAE;oBACV,IAAI,IAAI,CAAC,QAAQ,KAAK,MAAM,EAAE;wBAC5B,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC;wBAC7B,IAAI,CAAC,YAAY,EAAE,CAAC;qBACrB;iBACF,CAAC,CAAC;gBACL,IAAI,CAAC,eAAe;qBACjB,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;qBACtB,SAAS,CAAE;oBACV,IAAI,IAAI,CAAC,QAAQ,KAAK,MAAM,EAAE;wBAC5B,IAAI,CAAC,gBAAgB,GAAG,KAAK,CAAC;wBAC9B,IAAI,CAAC,YAAY,EAAE,CAAC;qBACrB;iBACF,CAAC,CAAC;aACN;SACF,CAAC,CAAC;KACN;;;;;;;;;;;;;;;;;;;;;;;;;;;IA7ED,IAAa,OAAO,KAAkD,OAAO,IAAI,CAAC,QAAQ,CAAC,EAAE;IAC7F,IAAI,OAAO,CAAC,KAAkD;QAC5D,IAAI,OAAO,GAAqB,qBAAqB,CAAC,KAAK,CAAC,CAAC;QAC7D,IAAI,OAAO,KAAK,KAAK,KAAK,MAAM,IAAK,KAAa,KAAK,EAAE,CAAC,EAAE;YAC1D,OAAO,GAAG,MAAM,CAAC;SAClB;QAED,IAAI,YAAY,CAAC,KAAK,CAAC,IAAI,IAAI,CAAC,QAAQ,KAAK,KAAK,EAAE;YAClD,IAAI,YAAY,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE;gBAC/B,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;aAChC;YACD,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;YACtB,KAAK;iBACF,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;iBAC/B,SAAS,CAAE,KAAK;gBACf,IAAI,CAAC,gBAAgB,GAAG,KAAK,CAAC;gBAC9B,IAAI,CAAC,YAAY,EAAE,CAAC;aACrB,CAAC,CAAC;SACN;aAAM,IAAI,IAAI,CAAC,QAAQ,KAAK,OAAO,EAAE;YACpC,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;YACxB,IAAI,OAAO,KAAK,MAAM,EAAE;gBACtB,IAAI,CAAC,gBAAgB,GAAG,OAAO,CAAC;gBAChC,IAAI,CAAC,YAAY,EAAE,CAAC;aACrB;SACF;KACF;IAsDD,WAAW;QACT,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAChB,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;KAC/B;IAEO,YAAY;QAClB,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;YACpB,MAAM,KAAK,GAAG,IAAI,CAAC,gBAAgB,CAAC;YACpC,IAAI,KAAK,EAAE;gBACT,IAAI,CAAC,IAAI,CAAC,oBAAoB,EAAE;oBAC9B,MAAM,eAAe,GAAG,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;oBAChE,IAAI,eAAe,EAAE;wBACnB,IAAI,CAAC,oBAAoB,GAAG,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,cAAc,EAAE,eAAe,CAAC,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC;wBACjH,IAAI,CAAC,oBAAoB,CAAC,aAAa,EAAE,CAAC;qBAC3C;iBACF;aACF;iBAAM,IAAI,IAAI,CAAC,oBAAoB,EAAE;gBACpC,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,oBAAoB,EAAE,cAAc,CAAC,CAAC;gBAChE,IAAI,CAAC,oBAAoB,GAAG,SAAS,CAAC;aACvC;SACF;KACF;;8IAhIU,8BAA8B;kIAA9B,8BAA8B;2FAA9B,8BAA8B;kBAD1C,SAAS;mBAAC,EAAE,QAAQ,EAAE,oBAAoB,EAAE,QAAQ,EAAE,SAAS,EAAE;+IA6BnD,OAAO;sBAAnB,KAAK;;;MC/BK,qBAAqB;;AAChB,kCAAY,GAAG,WAAW,CAAC,EAAE,EAAE,EAAE,UAAU,EAAE,EAAE,8BAA8B,CAAC,CAAC;qIADpF,qBAAqB;sIAArB,qBAAqB,iBAHhB,2BAA2B,EAAE,8BAA8B,aADhE,YAAY,EAAE,cAAc,EAAE,cAAc,aAE3C,2BAA2B,EAAE,8BAA8B;sIAE5D,qBAAqB,YAJvB,CAAE,YAAY,EAAE,cAAc,EAAE,cAAc,CAAE;2FAI9C,qBAAqB;kBALjC,QAAQ;mBAAC;oBACR,OAAO,EAAE,CAAE,YAAY,EAAE,cAAc,EAAE,cAAc,CAAE;oBACzD,YAAY,EAAE,CAAE,2BAA2B,EAAE,8BAA8B,CAAE;oBAC7E,OAAO,EAAE,CAAG,2BAA2B,EAAE,8BAA8B,CAAG;iBAC3E;;;ACZD;;;;;;"}