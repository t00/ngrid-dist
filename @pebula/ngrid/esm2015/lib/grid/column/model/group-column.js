import { PblMetaColumn } from './meta-column';
const PBL_NGRID_COLUMN_GROUP_MARK = Symbol('PblColumnGroup');
const CLONE_PROPERTIES = [];
export function isPblColumnGroup(def) {
    return def instanceof PblColumnGroup || (def && def[PBL_NGRID_COLUMN_GROUP_MARK] === true);
}
function getId(value) {
    return typeof value === 'string' ? value : value.id;
}
export class PblColumnGroupStore {
    constructor() {
        this.store = new Map();
        this._all = [];
    }
    get all() { return this._all; }
    /**
     * Attach a column to a group.
     */
    attach(group, column) {
        const g = this._find(group);
        if (g) {
            g.activeColumns.add(getId(column));
            return true;
        }
        return false;
    }
    /**
     * Detach a column from a group.
     */
    detach(group, column) {
        const g = this._find(group);
        if (g) {
            return g.activeColumns.delete(getId(column));
        }
        return false;
    }
    /**
     * Returns a list of `PblColumnGroup` that does not have columns attached.
     */
    findGhosts() {
        return Array.from(this.store.values())
            .filter(item => item.activeColumns.size === 0)
            .map(item => item.group);
    }
    add(group) {
        this.store.set(group.id, { group, activeColumns: new Set() });
        this.updateAll();
    }
    remove(group) {
        const g = this.find(group);
        if (g && this.store.delete(g.id)) {
            this.updateAll();
            return true;
        }
        return false;
    }
    find(group) {
        const g = this._find(group);
        if (g) {
            return g.group;
        }
    }
    clone() {
        const c = new PblColumnGroupStore();
        c.store = new Map(this.store);
        c.updateAll();
        return c;
    }
    _find(group) {
        return this.store.get(getId(group));
    }
    updateAll() {
        this._all = Array.from(this.store.values()).map(item => item.group);
    }
}
export class PblColumnGroup extends PblMetaColumn {
    constructor(def, columns, placeholder = false) {
        super(isPblColumnGroup(def)
            ? def
            : Object.assign({ id: `group-${def.columnIds.join('.')}-row-${def.rowIndex}`, kind: 'header' }, def));
        this.placeholder = placeholder;
        this[PBL_NGRID_COLUMN_GROUP_MARK] = true;
        this.columnIds = def.columnIds;
        this.columns = columns;
        for (const c of columns) {
            c.markInGroup(this);
        }
        for (const prop of CLONE_PROPERTIES) {
            if (prop in def) {
                this[prop] = def[prop];
            }
        }
    }
    //#endregion PblColumnGroupDefinition
    /**
     * Returns the visible state of the column.
     * The column is visible if AT LEAST ONE child column is visible (i.e. not hidden)
     */
    get isVisible() {
        return this.columns.some(c => !c.hidden);
    }
    static extendProperty(name) {
        if (CLONE_PROPERTIES.indexOf(name) === -1) {
            CLONE_PROPERTIES.push(name);
        }
    }
    createSlave(columns = []) {
        const slave = new PblColumnGroup(Object.assign(Object.assign({}, this), { id: this.id + '-slave' + Date.now() }), columns);
        slave.slaveOf = this;
        Object.defineProperty(slave, 'template', { get: function () { return this.slaveOf.template; }, set: function (value) { } });
        return slave;
    }
    replace(newColumn) {
        const { id } = newColumn;
        const idx = this.columns.findIndex(c => c.id === id);
        if (idx > -1) {
            this.columns.splice(idx, 1, newColumn);
            return true;
        }
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JvdXAtY29sdW1uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3JpZC9zcmMvbGliL2dyaWQvY29sdW1uL21vZGVsL2dyb3VwLWNvbHVtbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzlDLE1BQU0sMkJBQTJCLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDN0QsTUFBTSxnQkFBZ0IsR0FBZ0MsRUFBRSxDQUFDO0FBRXpELE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxHQUFRO0lBQ3ZDLE9BQU8sR0FBRyxZQUFZLGNBQWMsSUFBSSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsMkJBQTJCLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztBQUM3RixDQUFDO0FBRUQsU0FBUyxLQUFLLENBQUMsS0FBOEI7SUFDM0MsT0FBTyxPQUFPLEtBQUssS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztBQUN0RCxDQUFDO0FBRUQsTUFBTSxPQUFPLG1CQUFtQjtJQUFoQztRQUdVLFVBQUssR0FBRyxJQUFJLEdBQUcsRUFBa0UsQ0FBQztRQUNsRixTQUFJLEdBQXFCLEVBQUUsQ0FBQztJQXFFdEMsQ0FBQztJQXhFQyxJQUFJLEdBQUcsS0FBdUIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUtqRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxLQUE4QixFQUFFLE1BQTBCO1FBQy9ELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLEVBQUU7WUFDTCxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNuQyxP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QUFFLEVBQUUsR0FBRyxFQUFFLGNBQWEsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsVUFBUyxLQUFLLElBQUcsQ0FBQyxFQUFFLENBQUUsQ0FBQztRQUMxSCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCxPQUFPLENBQUMsU0FBb0I7UUFDMUIsTUFBTSxFQUFFLEVBQUUsRUFBRSxHQUFHLFNBQVMsQ0FBQztRQUN6QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFFLENBQUM7UUFDdkQsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDWixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZDLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBibENvbHVtbkdyb3VwRGVmaW5pdGlvbiB9IGZyb20gJ0BwZWJ1bGEvbmdyaWQvY29yZSc7XG5pbXBvcnQgeyBQYmxNZXRhQ29sdW1uIH0gZnJvbSAnLi9tZXRhLWNvbHVtbic7XG5pbXBvcnQgeyBQYmxDb2x1bW4gfSBmcm9tICcuL2NvbHVtbic7XG5cbmNvbnN0IFBCTF9OR1JJRF9DT0xVTU5fR1JPVVBfTUFSSyA9IFN5bWJvbCgnUGJsQ29sdW1uR3JvdXAnKTtcbmNvbnN0IENMT05FX1BST1BFUlRJRVM6IEFycmF5PGtleW9mIFBibENvbHVtbkdyb3VwPiA9IFtdO1xuXG5leHBvcnQgZnVuY3Rpb24gaXNQYmxDb2x1bW5Hcm91cChkZWY6IGFueSk6IGRlZiBpcyBQYmxDb2x1bW5Hcm91cCB7XG4gIHJldHVybiBkZWYgaW5zdGFuY2VvZiBQYmxDb2x1bW5Hcm91cCB8fCAoZGVmICYmIGRlZltQQkxfTkdSSURfQ09MVU1OX0dST1VQX01BUktdID09PSB0cnVlKTtcbn1cblxuZnVuY3Rpb24gZ2V0SWQodmFsdWU6IHN0cmluZyB8IHsgaWQ6IHN0cmluZyB9KTogc3RyaW5nIHtcbiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyB2YWx1ZSA6IHZhbHVlLmlkO1xufVxuXG5leHBvcnQgY2xhc3MgUGJsQ29sdW1uR3JvdXBTdG9yZSB7XG4gIGdldCBhbGwoKTogUGJsQ29sdW1uR3JvdXBbXSB7IHJldHVybiB0aGlzLl9hbGw7IH1cblxuICBwcml2YXRlIHN0b3JlID0gbmV3IE1hcDxzdHJpbmcsIHsgZ3JvdXA6IFBibENvbHVtbkdyb3VwOyBhY3RpdmVDb2x1bW5zOiBTZXQ8c3RyaW5nPjsgfT4oKTtcbiAgcHJpdmF0ZSBfYWxsOiBQYmxDb2x1bW5Hcm91cFtdID0gW107XG5cbiAgLyoqXG4gICAqIEF0dGFjaCBhIGNvbHVtbiB0byBhIGdyb3VwLlxuICAgKi9cbiAgYXR0YWNoKGdyb3VwOiBzdHJpbmcgfCBQYmxDb2x1bW5Hcm91cCwgY29sdW1uOiBzdHJpbmcgfCBQYmxDb2x1bW4pOiBib29sZWFuIHtcbiAgICBjb25zdCBnID0gdGhpcy5fZmluZChncm91cCk7XG4gICAgaWYgKGcpIHtcbiAgICAgIGcuYWN0aXZlQ29sdW1ucy5hZGQoZ2V0SWQoY29sdW1uKSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGFjaCBhIGNvbHVtbiBmcm9tIGEgZ3JvdXAuXG4gICAqL1xuICBkZXRhY2goZ3JvdXA6IHN0cmluZyB8IFBibENvbHVtbkdyb3VwLCBjb2x1bW46IHN0cmluZyB8IFBibENvbHVtbik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGcgPSB0aGlzLl9maW5kKGdyb3VwKTtcbiAgICBpZiAoZykge1xuICAgICAgcmV0dXJuIGcuYWN0aXZlQ29sdW1ucy5kZWxldGUoZ2V0SWQoY29sdW1uKSk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgbGlzdCBvZiBgUGJsQ29sdW1uR3JvdXBgIHRoYXQgZG9lcyBub3QgaGF2ZSBjb2x1bW5zIGF0dGFjaGVkLlxuICAgKi9cbiAgZmluZEdob3N0cygpOiBQYmxDb2x1bW5Hcm91cFtdIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLnN0b3JlLnZhbHVlcygpKVxuICAgICAgLmZpbHRlciggaXRlbSA9PiBpdGVtLmFjdGl2ZUNvbHVtbnMuc2l6ZSA9PT0gMCApXG4gICAgICAubWFwKCBpdGVtID0+IGl0ZW0uZ3JvdXAgKTtcbiAgfVxuXG4gIGFkZChncm91cDogUGJsQ29sdW1uR3JvdXApOiB2b2lkIHtcbiAgICB0aGlzLnN0b3JlLnNldChncm91cC5pZCwgeyBncm91cCwgYWN0aXZlQ29sdW1uczogbmV3IFNldDxzdHJpbmc+KCkgfSk7XG4gICAgdGhpcy51cGRhdGVBbGwoKTtcbiAgfVxuXG4gIHJlbW92ZShncm91cDogc3RyaW5nIHwgUGJsQ29sdW1uR3JvdXApOiBib29sZWFuIHtcbiAgICBjb25zdCBnID0gdGhpcy5maW5kKGdyb3VwKTtcbiAgICBpZiAoZyAmJiB0aGlzLnN0b3JlLmRlbGV0ZShnLmlkKSkge1xuICAgICAgdGhpcy51cGRhdGVBbGwoKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBmaW5kKGdyb3VwOiBzdHJpbmcgfCBQYmxDb2x1bW5Hcm91cCk6IFBibENvbHVtbkdyb3VwIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBnID0gdGhpcy5fZmluZChncm91cCk7XG4gICAgaWYgKGcpIHtcbiAgICAgIHJldHVybiBnLmdyb3VwO1xuICAgIH1cbiAgfVxuXG4gIGNsb25lKCk6IFBibENvbHVtbkdyb3VwU3RvcmUge1xuICAgIGNvbnN0IGMgPSBuZXcgUGJsQ29sdW1uR3JvdXBTdG9yZSgpO1xuICAgIGMuc3RvcmUgPSBuZXcgTWFwPHN0cmluZywgeyBncm91cDogUGJsQ29sdW1uR3JvdXA7IGFjdGl2ZUNvbHVtbnM6IFNldDxzdHJpbmc+OyB9Pih0aGlzLnN0b3JlKTtcbiAgICBjLnVwZGF0ZUFsbCgpO1xuICAgIHJldHVybiBjO1xuICB9XG5cbiAgcHJpdmF0ZSBfZmluZChncm91cDogc3RyaW5nIHwgUGJsQ29sdW1uR3JvdXApOiB7IGdyb3VwOiBQYmxDb2x1bW5Hcm91cDsgYWN0aXZlQ29sdW1uczogU2V0PHN0cmluZz47IH0gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLmdldChnZXRJZChncm91cCkpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVBbGwoKTogdm9pZCB7XG4gICAgdGhpcy5fYWxsID0gQXJyYXkuZnJvbSh0aGlzLnN0b3JlLnZhbHVlcygpKS5tYXAoIGl0ZW0gPT4gaXRlbS5ncm91cCApO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQYmxDb2x1bW5Hcm91cCBleHRlbmRzIFBibE1ldGFDb2x1bW4gaW1wbGVtZW50cyBQYmxDb2x1bW5Hcm91cERlZmluaXRpb24ge1xuXG4gIGNvbHVtbklkczogc3RyaW5nW107XG4gIC8vI2VuZHJlZ2lvbiBQYmxDb2x1bW5Hcm91cERlZmluaXRpb25cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgdmlzaWJsZSBzdGF0ZSBvZiB0aGUgY29sdW1uLlxuICAgKiBUaGUgY29sdW1uIGlzIHZpc2libGUgaWYgQVQgTEVBU1QgT05FIGNoaWxkIGNvbHVtbiBpcyB2aXNpYmxlIChpLmUuIG5vdCBoaWRkZW4pXG4gICAqL1xuICBnZXQgaXNWaXNpYmxlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmNvbHVtbnMuc29tZSggYyA9PiAhYy5oaWRkZW4gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXaGVuIHNldCwgdGhpcyBjb2x1bW4gaXMgYSBjbG9uZWQgY29sdW1uIG9mIGFuIGV4aXN0aW5nIGNvbHVtbiBjYXVzZWQgYnkgYSBzcGxpdC5cbiAgICogQGludGVybmFsXG4gICAqL1xuICBzbGF2ZU9mPzogUGJsQ29sdW1uR3JvdXA7XG5cbiAgLyoqIEBpbnRlcm5hbCAqL1xuICByZWFkb25seSBjb2x1bW5zOiBQYmxDb2x1bW5bXTtcblxuICBjb25zdHJ1Y3RvcihkZWY6IFBibENvbHVtbkdyb3VwIHwgUGJsQ29sdW1uR3JvdXBEZWZpbml0aW9uLCBjb2x1bW5zOiBQYmxDb2x1bW5bXSwgcHVibGljIHJlYWRvbmx5IHBsYWNlaG9sZGVyID0gZmFsc2UpIHtcbiAgICBzdXBlcihpc1BibENvbHVtbkdyb3VwKGRlZilcbiAgICAgID8gZGVmXG4gICAgICA6IHsgaWQ6IGBncm91cC0ke2RlZi5jb2x1bW5JZHMuam9pbignLicpfS1yb3ctJHtkZWYucm93SW5kZXh9YCwga2luZDogJ2hlYWRlcicgYXMgJ2hlYWRlcicsIC4uLihkZWYgYXMgYW55KSB9XG4gICAgKTtcbiAgICB0aGlzW1BCTF9OR1JJRF9DT0xVTU5fR1JPVVBfTUFSS10gPSB0cnVlO1xuICAgIHRoaXMuY29sdW1uSWRzID0gZGVmLmNvbHVtbklkcztcbiAgICB0aGlzLmNvbHVtbnMgPSBjb2x1bW5zO1xuXG4gICAgZm9yIChjb25zdCBjIG9mIGNvbHVtbnMpIHtcbiAgICAgIGMubWFya0luR3JvdXAodGhpcyk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBwcm9wIG9mIENMT05FX1BST1BFUlRJRVMpIHtcbiAgICAgIGlmIChwcm9wIGluIGRlZikge1xuICAgICAgICB0aGlzW3Byb3AgYXMgYW55XSA9IGRlZltwcm9wXVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBleHRlbmRQcm9wZXJ0eShuYW1lOiBrZXlvZiBQYmxDb2x1bW5Hcm91cCk6IHZvaWQge1xuICAgIGlmIChDTE9ORV9QUk9QRVJUSUVTLmluZGV4T2YobmFtZSkgPT09IC0xKSB7XG4gICAgICBDTE9ORV9QUk9QRVJUSUVTLnB1c2gobmFtZSk7XG4gICAgfVxuICB9XG5cbiAgY3JlYXRlU2xhdmUoY29sdW1uczogUGJsQ29sdW1uW10gPSBbXSk6IFBibENvbHVtbkdyb3VwIHtcbiAgICBjb25zdCBzbGF2ZSA9IG5ldyBQYmxDb2x1bW5Hcm91cCh7Li4udGhpcywgaWQ6IHRoaXMuaWQgKyAnLXNsYXZlJyArIERhdGUubm93KCl9LCBjb2x1bW5zKTtcbiAgICBzbGF2ZS5zbGF2ZU9mID0gdGhpcztcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc2xhdmUsICd0ZW1wbGF0ZScsIHsgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuc2xhdmVPZi50ZW1wbGF0ZTsgfSwgc2V0OiBmdW5jdGlvbih2YWx1ZSkge30gfSApO1xuICAgIHJldHVybiBzbGF2ZTtcbiAgfVxuXG4gIHJlcGxhY2UobmV3Q29sdW1uOiBQYmxDb2x1bW4pOiBib29sZWFuIHtcbiAgICBjb25zdCB7IGlkIH0gPSBuZXdDb2x1bW47XG4gICAgY29uc3QgaWR4ID0gdGhpcy5jb2x1bW5zLmZpbmRJbmRleCggYyA9PiBjLmlkID09PSBpZCApO1xuICAgIGlmIChpZHggPiAtMSkge1xuICAgICAgdGhpcy5jb2x1bW5zLnNwbGljZShpZHgsIDEsIG5ld0NvbHVtbik7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG4iXX0=