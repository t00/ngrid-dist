import { Inject, Injectable } from '@angular/core';
import { EXT_API_TOKEN } from '../../ext/grid-ext-api';
import { rowContextBridge } from '../row/row-to-repeater-bridge';
import * as i0 from "@angular/core";
export class PblNgridBaseRowViewRepeaterStrategy {
    constructor(extApi) {
        this.extApi = extApi;
        this.workaroundEnabled = false;
        this._cachedRenderDefMap = new Map();
        extApi
            .onConstructed(() => {
            const cdkTable = extApi.cdkTable;
            this.renderer = cdkTable;
            this.workaroundEnabled = !cdkTable['_cachedRenderDefMap'] && typeof this.renderer._renderCellTemplateForItem === 'function';
        });
    }
    applyChanges(changes, vcRef, itemContextFactory, itemValueResolver, itemViewChanged) {
        const createEmbeddedView = (record, adjustedPreviousIndex, currentIndex) => {
            const itemArgs = itemContextFactory(record, adjustedPreviousIndex, currentIndex);
            itemArgs.context = this.extApi.contextApi._createRowContext(itemArgs.context.$implicit, itemArgs.index);
            return rowContextBridge.bridgeContext(itemArgs, () => vcRef.createEmbeddedView(itemArgs.templateRef, itemArgs.context, itemArgs.index));
        };
        const baseState = { vcRef, createEmbeddedView, itemValueResolver };
        changes.forEachOperation((record, adjustedPreviousIndex, currentIndex) => {
            const state = Object.create(baseState);
            state.record = record;
            if (record.previousIndex == null) {
                this.addItem(adjustedPreviousIndex, currentIndex, state);
                if (state.op === 1 /* INSERTED */) {
                }
            }
            else if (currentIndex == null) {
                this.removeItem(adjustedPreviousIndex, state);
            }
            else {
                this.moveItem(adjustedPreviousIndex, currentIndex, state);
            }
            if (this.workaroundEnabled) {
                this.patch20765afterOp(state);
            }
            this.afterOperation(state);
        });
        if (this.workaroundEnabled) {
            this.patch20765(changes, baseState);
        }
    }
    detach() { }
    addItem(adjustedPreviousIndex, currentIndex, state) { }
    removeItem(removeAt, state) { }
    moveItem(moveFrom, moveTo, state) { }
    afterOperation(state) { }
    // See https://github.com/angular/components/pull/20765
    patch20765(changes, baseState) {
        changes.forEachIdentityChange = (fn) => {
            changes.constructor.prototype.forEachIdentityChange.call(changes, (record) => {
                fn(record);
                if (this._cachedRenderDefMap.get(record.currentIndex) !== record.item.rowDef) {
                    baseState.vcRef.remove(record.currentIndex);
                    baseState.createEmbeddedView(record, null, record.currentIndex);
                    this._cachedRenderDefMap.set(record.currentIndex, record.item.rowDef);
                }
            });
        };
    }
    patch20765afterOp(state) {
        switch (state.op) {
            case 0 /* REPLACED */:
            case 1 /* INSERTED */:
            case 2 /* MOVED */:
                this._cachedRenderDefMap.set(state.record.currentIndex, state.record.item.rowDef);
                break;
            case 3 /* REMOVED */:
                this._cachedRenderDefMap.delete(state.record.previousIndex);
                break;
        }
    }
}
/** @nocollapse */ PblNgridBaseRowViewRepeaterStrategy.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.0", ngImport: i0, type: PblNgridBaseRowViewRepeaterStrategy, deps: [{ token: EXT_API_TOKEN }], target: i0.ɵɵFactoryTarget.Injectable });
/** @nocollapse */ PblNgridBaseRowViewRepeaterStrategy.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.0.0", ngImport: i0, type: PblNgridBaseRowViewRepeaterStrategy });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.0", ngImport: i0, type: PblNgridBaseRowViewRepeaterStrategy, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [EXT_API_TOKEN]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmdyaWQtYmFzZS1yb3ctdmlldy1yZXBlYXRlci1zdHJhdGVneS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmdyaWQvc3JjL2xpYi9ncmlkL3BibC1jZGstdGFibGUvbmdyaWQtYmFzZS1yb3ctdmlldy1yZXBlYXRlci1zdHJhdGVneS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQW1CLE1BQU0sRUFBRSxVQUFVLEVBQTJELE1BQU0sZUFBZSxDQUFDO0FBYTdILE9BQU8sRUFBRSxhQUFhLEVBQWdDLE1BQU0sd0JBQXdCLENBQUM7QUFFckYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sK0JBQStCLENBQUM7O0FBZWpFLE1BQU0sT0FBTyxtQ0FBbUM7SUFLOUMsWUFBNkMsTUFBdUM7UUFBdkMsV0FBTSxHQUFOLE1BQU0sQ0FBaUM7UUFKMUUsc0JBQWlCLEdBQUcsS0FBSyxDQUFDO1FBRTFCLHdCQUFtQixHQUFHLElBQUksR0FBRyxFQUF3QixDQUFDO1FBRzlELE1BQU07YUFDSCxhQUFhLENBQUMsR0FBRyxFQUFFO1lBQ2xCLE1BQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUM7WUFDakMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFlLENBQUM7WUFDaEMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLENBQUMsUUFBUSxDQUFDLHFCQUFxQixDQUFDLElBQUksT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLDBCQUEwQixLQUFLLFVBQVUsQ0FBQztRQUM5SCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxZQUFZLENBQUMsT0FBMkIsRUFDM0IsS0FBdUIsRUFDdkIsa0JBQTRELEVBQzVELGlCQUF1RCxFQUN2RCxlQUFnRDtRQUUzRCxNQUFNLGtCQUFrQixHQUFHLENBQUMsTUFBK0IsRUFDL0IscUJBQW9DLEVBQ3BDLFlBQTJCLEVBQUUsRUFBRTtZQUN6RCxNQUFNLFFBQVEs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LENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDdkU7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQTtJQUNILENBQUM7SUFFUyxpQkFBaUIsQ0FBQyxLQUFvQztRQUM5RCxRQUFRLEtBQUssQ0FBQyxFQUFFLEVBQUU7WUFDaEIsc0JBQXFDO1lBQ3JDLHNCQUFxQztZQUNyQztnQkFDRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNsRixNQUFNO1lBQ1I7Z0JBQ0UsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUM1RCxNQUFNO1NBQ1Q7SUFDSCxDQUFDOzttSkExRlUsbUNBQW1DLGtCQUsxQixhQUFhO3VKQUx0QixtQ0FBbUM7MkZBQW5DLG1DQUFtQztrQkFEL0MsVUFBVTs7MEJBTUksTUFBTTsyQkFBQyxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW1iZWRkZWRWaWV3UmVmLCBJbmplY3QsIEluamVjdGFibGUsIEl0ZXJhYmxlQ2hhbmdlUmVjb3JkLCBJdGVyYWJsZUNoYW5nZXMsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIF9WaWV3UmVwZWF0ZXIsXG4gIF9WaWV3UmVwZWF0ZXJJdGVtQ2hhbmdlLFxuICBfVmlld1JlcGVhdGVySXRlbUNoYW5nZWQsXG4gIF9WaWV3UmVwZWF0ZXJJdGVtQ29udGV4dCxcbiAgX1ZpZXdSZXBlYXRlckl0ZW1Db250ZXh0RmFjdG9yeSxcbiAgX1ZpZXdSZXBlYXRlckl0ZW1JbnNlcnRBcmdzLFxuICBfVmlld1JlcGVhdGVySXRlbVZhbHVlUmVzb2x2ZXIsXG4gIF9WaWV3UmVwZWF0ZXJPcGVyYXRpb24sXG59IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2xsZWN0aW9ucyc7XG5pbXBvcnQgeyBDZGtSb3dEZWYsIFJlbmRlclJvdywgQmFzZVJvd0RlZiwgUm93Q29udGV4dCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay90YWJsZSc7XG5cbmltcG9ydCB7IEVYVF9BUElfVE9LRU4sIFBibE5ncmlkSW50ZXJuYWxFeHRlbnNpb25BcGkgfSBmcm9tICcuLi8uLi9leHQvZ3JpZC1leHQtYXBpJztcbmltcG9ydCB7IFBibFJvd0NvbnRleHQgfSBmcm9tICcuLi9jb250ZXh0L3Jvdyc7XG5pbXBvcnQgeyByb3dDb250ZXh0QnJpZGdlIH0gZnJvbSAnLi4vcm93L3Jvdy10by1yZXBlYXRlci1icmlkZ2UnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEJhc2VDaGFuZ2VPcGVyYXRpb25TdGF0ZTxULCBSIGV4dGVuZHMgUmVuZGVyUm93PFQ+LCBDIGV4dGVuZHMgUGJsUm93Q29udGV4dDxUPj4ge1xuICB2Y1JlZjogVmlld0NvbnRhaW5lclJlZjtcbiAgY3JlYXRlRW1iZWRkZWRWaWV3OiAocmVjb3JkOiBJdGVyYWJsZUNoYW5nZVJlY29yZDxSPiwgYWRqdXN0ZWRQcmV2aW91c0luZGV4OiBudW1iZXIgfCBudWxsLCBjdXJyZW50SW5kZXg6IG51bWJlciB8IG51bGwpID0+IEVtYmVkZGVkVmlld1JlZjxDPjtcbiAgaXRlbVZhbHVlUmVzb2x2ZXI6IF9WaWV3UmVwZWF0ZXJJdGVtVmFsdWVSZXNvbHZlcjxULCBSPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDaGFuZ2VPcGVyYXRpb25TdGF0ZTxULCBSIGV4dGVuZHMgUmVuZGVyUm93PFQ+LCBDIGV4dGVuZHMgUGJsUm93Q29udGV4dDxUPj4gZXh0ZW5kcyBCYXNlQ2hhbmdlT3BlcmF0aW9uU3RhdGU8VCwgUiwgQz4ge1xuICByZWNvcmQ6IEl0ZXJhYmxlQ2hhbmdlUmVjb3JkPFI+O1xuICB2aWV3PzogRW1iZWRkZWRWaWV3UmVmPEM+IHwgdW5kZWZpbmVkO1xuICBvcD86IF9WaWV3UmVwZWF0ZXJPcGVyYXRpb247XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQYmxOZ3JpZEJhc2VSb3dWaWV3UmVwZWF0ZXJTdHJhdGVneTxULCBSIGV4dGVuZHMgUmVuZGVyUm93PFQ+LCBDIGV4dGVuZHMgUGJsUm93Q29udGV4dDxUPj4gaW1wbGVtZW50cyBfVmlld1JlcGVhdGVyPFQsIFIsIEM+IHtcbiAgcHJvdGVjdGVkIHdvcmthcm91bmRFbmFibGVkID0gZmFsc2U7XG4gIHByb3RlY3RlZCByZW5kZXJlcjogeyBfcmVuZGVyQ2VsbFRlbXBsYXRlRm9ySXRlbTogKHJvd0RlZjogQmFzZVJvd0RlZiwgY29udGV4dDogUm93Q29udGV4dDxUPikgPT4gdm9pZDsgfTtcbiAgcHJvdGVjdGVkIF9jYWNoZWRSZW5kZXJEZWZNYXAgPSBuZXcgTWFwPG51bWJlciwgQ2RrUm93RGVmPFQ+PigpO1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoRVhUX0FQSV9UT0tFTikgcHJvdGVjdGVkIGV4dEFwaTogUGJsTmdyaWRJbnRlcm5hbEV4dGVuc2lvbkFwaTxUPikge1xuICAgIGV4dEFwaVxuICAgICAgLm9uQ29uc3RydWN0ZWQoKCkgPT4ge1xuICAgICAgICBjb25zdCBjZGtUYWJsZSA9IGV4dEFwaS5jZGtUYWJsZTtcbiAgICAgICAgdGhpcy5yZW5kZXJlciA9IGNka1RhYmxlIGFzIGFueTtcbiAgICAgICAgdGhpcy53b3JrYXJvdW5kRW5hYmxlZCA9ICFjZGtUYWJsZVsnX2NhY2hlZFJlbmRlckRlZk1hcCddICYmIHR5cGVvZiB0aGlzLnJlbmRlcmVyLl9yZW5kZXJDZWxsVGVtcGxhdGVGb3JJdGVtID09PSAnZnVuY3Rpb24nO1xuICAgICAgfSk7XG4gIH1cblxuICBhcHBseUNoYW5nZXMoY2hhbmdlczogSXRlcmFibGVDaGFuZ2VzPFI+LFxuICAgICAgICAgICAgICAgdmNSZWY6IFZpZXdDb250YWluZXJSZWYsXG4gICAgICAgICAgICAgICBpdGVtQ29udGV4dEZhY3Rvcnk6IF9WaWV3UmVwZWF0ZXJJdGVtQ29udGV4dEZhY3Rvcnk8VCwgUiwgQz4sXG4gICAgICAgICAgICAgICBpdGVtVmFsdWVSZXNvbHZlcjogX1ZpZXdSZXBlYXRlckl0ZW1WYWx1ZVJlc29sdmVyPFQsIFI+LFxuICAgICAgICAgICAgICAgaXRlbVZpZXdDaGFuZ2VkPzogX1ZpZXdSZXBlYXRlckl0ZW1DaGFuZ2VkPFIsIEM+KSB7XG5cbiAgICBjb25zdCBjcmVhdGVFbWJlZGRlZFZpZXcgPSAocmVjb3JkOiBJdGVyYWJsZUNoYW5nZVJlY29yZDxSPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRqdXN0ZWRQcmV2aW91c0luZGV4OiBudW1iZXIgfCBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXg6IG51bWJlciB8IG51bGwpID0+IHtcbiAgICAgIGNvbnN0IGl0ZW1BcmdzID0gaXRlbUNvbnRleHRGYWN0b3J5KHJlY29yZCwgYWRqdXN0ZWRQcmV2aW91c0luZGV4LCBjdXJyZW50SW5kZXgpO1xuICAgICAgaXRlbUFyZ3MuY29udGV4dCA9IHRoaXMuZXh0QXBpLmNvbnRleHRBcGkuX2NyZWF0ZVJvd0NvbnRleHQoaXRlbUFyZ3MuY29udGV4dC4kaW1wbGljaXQsIGl0ZW1BcmdzLmluZGV4KSBhcyBhbnk7XG4gICAgICByZXR1cm4gcm93Q29udGV4dEJyaWRnZS5icmlkZ2VDb250ZXh0PEM+KGl0ZW1BcmdzLCAoKSA9PiB2Y1JlZi5jcmVhdGVFbWJlZGRlZFZpZXcoaXRlbUFyZ3MudGVtcGxhdGVSZWYsIGl0ZW1BcmdzLmNvbnRleHQsIGl0ZW1BcmdzLmluZGV4KSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGJhc2VTdGF0ZTogQmFzZUNoYW5nZU9wZXJhdGlvblN0YXRlPFQsIFIsIEM+ID0geyB2Y1JlZiwgY3JlYXRlRW1iZWRkZWRWaWV3LCBpdGVtVmFsdWVSZXNvbHZlciB9O1xuICAgIGNoYW5nZXMuZm9yRWFjaE9wZXJhdGlvbigocmVjb3JkOiBJdGVyYWJsZUNoYW5nZVJlY29yZDxSPiwgYWRqdXN0ZWRQcmV2aW91c0luZGV4OiBudW1iZXIgfCBudWxsLCBjdXJyZW50SW5kZXg6IG51bWJlciB8IG51bGwpID0+IHtcbiAgICAgIGNvbnN0IHN0YXRlOiBDaGFuZ2VPcGVyYXRpb25TdGF0ZTxULCBSLCBDPiA9IE9iamVjdC5jcmVhdGUoYmFzZVN0YXRlKTtcbiAgICAgIHN0YXRlLnJlY29yZCA9IHJlY29yZDtcbiAgICAgIGlmIChyZWNvcmQucHJldmlvdXNJbmRleCA9PSBudWxsKSB7XG4gICAgICAgIHRoaXMuYWRkSXRlbShhZGp1c3RlZFByZXZpb3VzSW5kZXgsIGN1cnJlbnRJbmRleCwgc3RhdGUpO1xuICAgICAgICBpZiAoc3RhdGUub3AgPT09IF9WaWV3UmVwZWF0ZXJPcGVyYXRpb24uSU5TRVJURUQpIHtcblxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRJbmRleCA9PSBudWxsKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlSXRlbShhZGp1c3RlZFByZXZpb3VzSW5kZXgsIHN0YXRlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubW92ZUl0ZW0oYWRqdXN0ZWRQcmV2aW91c0luZGV4LCBjdXJyZW50SW5kZXgsIHN0YXRlKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMud29ya2Fyb3VuZEVuYWJsZWQpIHtcbiAgICAgICAgdGhpcy5wYXRjaDIwNzY1YWZ0ZXJPcChzdGF0ZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYWZ0ZXJPcGVyYXRpb24oc3RhdGUpO1xuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMud29ya2Fyb3VuZEVuYWJsZWQpIHtcbiAgICAgIHRoaXMucGF0Y2gyMDc2NShjaGFuZ2VzLCBiYXNlU3RhdGUpO1xuICAgIH1cbiAgfVxuXG4gIGRldGFjaCgpOiB2b2lkIHsgfVxuXG4gIHByb3RlY3RlZCBhZGRJdGVtKGFkanVzdGVkUHJldmlvdXNJbmRleDogbnVtYmVyIHwgbnVsbCwgY3VycmVudEluZGV4OiBudW1iZXIgfCBudWxsLCBzdGF0ZTogQ2hhbmdlT3BlcmF0aW9uU3RhdGU8VCwgUiwgQz4pIHsgfVxuXG4gIHByb3RlY3RlZCByZW1vdmVJdGVtKHJlbW92ZUF0OiBudW1iZXIsIHN0YXRlOiBDaGFuZ2VPcGVyYXRpb25TdGF0ZTxULCBSLCBDPikgeyB9XG5cbiAgcHJvdGVjdGVkIG1vdmVJdGVtKG1vdmVGcm9tOiBudW1iZXIsIG1vdmVUbzogbnVtYmVyLCBzdGF0ZTogQ2hhbmdlT3BlcmF0aW9uU3RhdGU8VCwgUiwgQz4pIHsgfVxuXG4gIHByb3RlY3RlZCBhZnRlck9wZXJhdGlvbihzdGF0ZTogQ2hhbmdlT3BlcmF0aW9uU3RhdGU8VCwgUiwgQz4pIHsgIH1cblxuICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvY29tcG9uZW50cy9wdWxsLzIwNzY1XG4gIHByb3RlY3RlZCBwYXRjaDIwNzY1KGNoYW5nZXM6IEl0ZXJhYmxlQ2hhbmdlczxSPiwgYmFzZVN0YXRlOiBCYXNlQ2hhbmdlT3BlcmF0aW9uU3RhdGU8VCwgUiwgQz4pIHtcbiAgICBjaGFuZ2VzLmZvckVhY2hJZGVudGl0eUNoYW5nZSA9IChmbjogKHJlY29yZDogSXRlcmFibGVDaGFuZ2VSZWNvcmQ8Uj4pID0+IHZvaWQpID0+IHtcbiAgICAgIGNoYW5nZXMuY29uc3RydWN0b3IucHJvdG90eXBlLmZvckVhY2hJZGVudGl0eUNoYW5nZS5jYWxsKGNoYW5nZXMsIChyZWNvcmQ6IEl0ZXJhYmxlQ2hhbmdlUmVjb3JkPFI+KSA9PiB7XG4gICAgICAgIGZuKHJlY29yZCk7XG4gICAgICAgIGlmICh0aGlzLl9jYWNoZWRSZW5kZXJEZWZNYXAuZ2V0KHJlY29yZC5jdXJyZW50SW5kZXgpICE9PSByZWNvcmQuaXRlbS5yb3dEZWYpIHtcbiAgICAgICAgICBiYXNlU3RhdGUudmNSZWYucmVtb3ZlKHJlY29yZC5jdXJyZW50SW5kZXgpO1xuICAgICAgICAgIGJhc2VTdGF0ZS5jcmVhdGVFbWJlZGRlZFZpZXcocmVjb3JkLCBudWxsLCByZWNvcmQuY3VycmVudEluZGV4KTtcbiAgICAgICAgICB0aGlzLl9jYWNoZWRSZW5kZXJEZWZNYXAuc2V0KHJlY29yZC5jdXJyZW50SW5kZXgsIHJlY29yZC5pdGVtLnJvd0RlZik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBwYXRjaDIwNzY1YWZ0ZXJPcChzdGF0ZTogQ2hhbmdlT3BlcmF0aW9uU3RhdGU8VCwgUiwgQz4pIHtcbiAgICBzd2l0Y2ggKHN0YXRlLm9wKSB7XG4gICAgICBjYXNlIF9WaWV3UmVwZWF0ZXJPcGVyYXRpb24uUkVQTEFDRUQ6XG4gICAgICBjYXNlIF9WaWV3UmVwZWF0ZXJPcGVyYXRpb24uSU5TRVJURUQ6XG4gICAgICBjYXNlIF9WaWV3UmVwZWF0ZXJPcGVyYXRpb24uTU9WRUQ6XG4gICAgICAgIHRoaXMuX2NhY2hlZFJlbmRlckRlZk1hcC5zZXQoc3RhdGUucmVjb3JkLmN1cnJlbnRJbmRleCwgc3RhdGUucmVjb3JkLml0ZW0ucm93RGVmKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIF9WaWV3UmVwZWF0ZXJPcGVyYXRpb24uUkVNT1ZFRDpcbiAgICAgICAgdGhpcy5fY2FjaGVkUmVuZGVyRGVmTWFwLmRlbGV0ZShzdGF0ZS5yZWNvcmQucHJldmlvdXNJbmRleCk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=