import { PblCellContext } from './cell';
export class PblRowContext {
    constructor(_data, dsIndex, extApi) {
        this.extApi = extApi;
        this.external = {};
        this.dsIndex = dsIndex;
        this._$implicit = _data;
        this.identity = this.extApi.contextApi.getRowIdentity(dsIndex, _data);
        this.grid = extApi.grid;
        this._rebuildCells(this.extApi.grid.columnApi.columns);
    }
    /** Data for the row that this cell is located within. */
    get $implicit() { return this._$implicit; }
    set $implicit(value) {
        if (this._$implicit !== value) {
            this._$implicit = value;
            this.updateRowData();
        }
    }
    ;
    /** Index of the data object in the provided data array. */
    get dataIndex() { return this.index; }
    set dataIndex(value) { this.index = value; }
    /**
     * Returns the length of cells context stored in this row
     */
    get length() { var _a, _b; return (_b = (_a = this.cells) === null || _a === void 0 ? void 0 : _a.length) !== null && _b !== void 0 ? _b : 0; }
    static defaultState(identity, dsIndex, cellsCount) {
        const cells = [];
        for (let i = 0; i < cellsCount; i++) {
            cells.push(PblCellContext.defaultState());
        }
        return { identity, dsIndex, cells, firstRender: true, external: {} };
    }
    getExternal(key) {
        return this.external[key];
    }
    setExternal(key, value, saveState = false) {
        this.external[key] = value;
        if (saveState) {
            this.saveState();
        }
    }
    getState() {
        return {
            identity: this.identity,
            dsIndex: this.dsIndex,
            firstRender: this.firstRender,
            cells: this.cells.map(c => c.getState()),
            external: this.external,
        };
    }
    fromState(state) {
        this.firstRender = state.firstRender;
        this.dsIndex = state.dsIndex;
        this.external = state.external;
        for (let i = 0, len = this.cells.length; i < len; i++) {
            this.cells[i].fromState(state.cells[i], this);
        }
    }
    saveState() {
        this.extApi.contextApi.saveState(this);
    }
    /**
     * Returns the cell context for the column at the specified position.
     * > The position is relative to ALL columns (NOT RENDERED COLUMNS)
     */
    cell(index) {
        const idx = typeof index === 'number' ? index : this.grid.columnApi.indexOf(index);
        return this.cells[idx];
    }
    getCells() {
        return (this.cells && this.cells.slice()) || [];
    }
    updateCell(cell) {
        this.cells[cell.index] = cell.clone();
    }
    attachRow(row) {
        this.detachRow(this._attachedRow);
        this._attachedRow = row;
        if (this._updatePending) {
            this.updateRowData();
        }
    }
    detachRow(row) {
        if (row && this._attachedRow === row) {
            this.saveState();
            this._attachedRow = undefined;
        }
    }
    _rebuildCells(columns) {
        const cells = this.cells = [];
        const len = columns.length;
        for (let columnIndex = 0; columnIndex < len; columnIndex++) {
            const cellContext = PblCellContext.create(this, columns[columnIndex], this.extApi);
            cells.push(cellContext);
        }
    }
    updateRowData() {
        if (this._attachedRow) {
            this._updatePending = false;
            this.extApi.contextApi._updateRowContext(this, this._attachedRow.rowIndex);
            this._attachedRow.updateRow();
        }
        else {
            this._updatePending = !!this._$implicit;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm93LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3JpZC9zcmMvbGliL2dyaWQvY29udGV4dC9yb3cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUd4QyxNQUFNLE9BQU8sYUFBYTtJQWlEeEIsWUFBWSxLQUFRLEVBQUUsT0FBZSxFQUFVLE1BQStCO1FBQS9CLFdBQU0sR0FBTixNQUFNLENBQXlCO1FBWnRFLGFBQVEsR0FBUSxFQUFFLENBQUM7UUFhekIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFDeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXRFLElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUN4QixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBdkRELHlEQUF5RDtJQUN6RCxJQUFJLFNBQVMsS0FBb0IsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUMxRCxJQUFJLFNBQVMsQ0FBQyxLQUFvQjtRQUNoQyxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssS0FBSyxFQUFFO1lBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUN0QjtJQUNILENBQUM7SUFBQSxDQUFDO0lBSUYsMkRBQTJEO0lBQzNELElBQUksU0FBUyxLQUFLLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDdEMs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QUFJLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMzRSxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQy9CO2FBQU07WUFDTCxJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1NBQ3pDO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgX1BibE5ncmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vdG9rZW5zJztcbmltcG9ydCB7IFBibENvbHVtbiB9IGZyb20gJy4uL2NvbHVtbi9tb2RlbCc7XG5pbXBvcnQgeyBQYmxOZ3JpZEV4dGVuc2lvbkFwaSB9IGZyb20gJy4uLy4uL2V4dC9ncmlkLWV4dC1hcGknO1xuaW1wb3J0IHsgQ2VsbENvbnRleHRTdGF0ZSwgUm93Q29udGV4dFN0YXRlLCBQYmxOZ3JpZFJvd0NvbnRleHQsIEV4dGVybmFsUm93Q29udGV4dFN0YXRlIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBQYmxDZWxsQ29udGV4dCB9IGZyb20gJy4vY2VsbCc7XG5pbXBvcnQgeyBQYmxOZ3JpZFJvd0NvbXBvbmVudCB9IGZyb20gJy4uL3Jvdy9yb3cuY29tcG9uZW50JztcblxuZXhwb3J0IGNsYXNzIFBibFJvd0NvbnRleHQ8VD4gaW1wbGVtZW50cyBQYmxOZ3JpZFJvd0NvbnRleHQ8VD4ge1xuICAvKiogRGF0YSBmb3IgdGhlIHJvdyB0aGF0IHRoaXMgY2VsbCBpcyBsb2NhdGVkIHdpdGhpbi4gKi9cbiAgZ2V0ICRpbXBsaWNpdCgpOiBUIHwgdW5kZWZpbmVkIHsgcmV0dXJuIHRoaXMuXyRpbXBsaWNpdDsgfVxuICBzZXQgJGltcGxpY2l0KHZhbHVlOiBUIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHRoaXMuXyRpbXBsaWNpdCAhPT0gdmFsdWUpIHtcbiAgICAgIHRoaXMuXyRpbXBsaWNpdCA9IHZhbHVlO1xuICAgICAgdGhpcy51cGRhdGVSb3dEYXRhKCk7XG4gICAgfVxuICB9O1xuXG4gIC8qKiBJbmRleCBvZiB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHByb3ZpZGVkIGRhdGEgYXJyYXkuICovXG4gIGluZGV4PzogbnVtYmVyO1xuICAvKiogSW5kZXggb2YgdGhlIGRhdGEgb2JqZWN0IGluIHRoZSBwcm92aWRlZCBkYXRhIGFycmF5LiAqL1xuICBnZXQgZGF0YUluZGV4KCkgeyByZXR1cm4gdGhpcy5pbmRleDsgfVxuICBzZXQgZGF0YUluZGV4KHZhbHVlOiBudW1iZXIpIHsgdGhpcy5pbmRleCA9IHZhbHVlOyB9XG5cbiAgLyoqIEluZGV4IGxvY2F0aW9uIG9mIHRoZSByZW5kZXJlZCByb3cgdGhhdCB0aGlzIGNlbGwgaXMgbG9jYXRlZCB3aXRoaW4uICovXG4gIHJlbmRlckluZGV4PzogbnVtYmVyO1xuICAvKiogTGVuZ3RoIG9mIHRoZSBudW1iZXIgb2YgdG90YWwgcm93cy4gKi9cbiAgY291bnQ/OiBudW1iZXI7XG4gIC8qKiBUcnVlIGlmIHRoaXMgY2VsbCBpcyBjb250YWluZWQgaW4gdGhlIGZpcnN0IHJvdy4gKi9cbiAgZmlyc3Q/OiBib29sZWFuO1xuICAvKiogVHJ1ZSBpZiB0aGlzIGNlbGwgaXMgY29udGFpbmVkIGluIHRoZSBsYXN0IHJvdy4gKi9cbiAgbGFzdD86IGJvb2xlYW47XG4gIC8qKiBUcnVlIGlmIHRoaXMgY2VsbCBpcyBjb250YWluZWQgaW4gYSByb3cgd2l0aCBhbiBldmVuLW51bWJlcmVkIGluZGV4LiAqL1xuICBldmVuPzogYm9vbGVhbjtcbiAgLyoqIFRydWUgaWYgdGhpcyBjZWxsIGlzIGNvbnRhaW5lZCBpbiBhIHJvdyB3aXRoIGFuIG9kZC1udW1iZXJlZCBpbmRleC4gKi9cbiAgb2RkPzogYm9vbGVhbjtcblxuICAvKiogVGhlIGluZGV4IGF0IHRoZSBkYXRhc291cmNlICovXG4gIGRzSW5kZXg6IG51bWJlcjtcbiAgaWRlbnRpdHk6IGFueTtcbiAgZmlyc3RSZW5kZXI6IGJvb2xlYW47XG4gIG91dE9mVmlldzogYm9vbGVhbjtcblxuICByZWFkb25seSBncmlkOiBfUGJsTmdyaWRDb21wb25lbnQ8VD47XG4gIHByaXZhdGUgX2F0dGFjaGVkUm93OiBQYmxOZ3JpZFJvd0NvbXBvbmVudDxUPjtcbiAgcHJpdmF0ZSBleHRlcm5hbDogYW55ID0ge307XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGxlbmd0aCBvZiBjZWxscyBjb250ZXh0IHN0b3JlZCBpbiB0aGlzIHJvd1xuICAgKi9cbiAgZ2V0IGxlbmd0aCgpOiBudW1iZXIgeyByZXR1cm4gdGhpcy5jZWxscz8ubGVuZ3RoID8/IDA7IH1cblxuICBwcml2YXRlIGNlbGxzOiBQYmxDZWxsQ29udGV4dDxUPltdO1xuXG4gIHByaXZhdGUgXyRpbXBsaWNpdD86IFQ7XG4gIHByaXZhdGUgX3VwZGF0ZVBlbmRpbmc6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoX2RhdGE6IFQsIGRzSW5kZXg6IG51bWJlciwgcHJpdmF0ZSBleHRBcGk6IFBibE5ncmlkRXh0ZW5zaW9uQXBpPFQ+KSB7XG4gICAgdGhpcy5kc0luZGV4ID0gZHNJbmRleDtcbiAgICB0aGlzLl8kaW1wbGljaXQgPSBfZGF0YTtcbiAgICB0aGlzLmlkZW50aXR5ID0gdGhpcy5leHRBcGkuY29udGV4dEFwaS5nZXRSb3dJZGVudGl0eShkc0luZGV4LCBfZGF0YSk7XG5cbiAgICB0aGlzLmdyaWQgPSBleHRBcGkuZ3JpZDtcbiAgICB0aGlzLl9yZWJ1aWxkQ2VsbHModGhpcy5leHRBcGkuZ3JpZC5jb2x1bW5BcGkuY29sdW1ucyk7XG4gIH1cblxuICBzdGF0aWMgZGVmYXVsdFN0YXRlPFQgPSBhbnk+KGlkZW50aXR5OiBhbnksIGRzSW5kZXg6IG51bWJlciwgY2VsbHNDb3VudDogbnVtYmVyKTogUm93Q29udGV4dFN0YXRlPFQ+IHtcbiAgICBjb25zdCBjZWxsczogQ2VsbENvbnRleHRTdGF0ZTxUPltdID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjZWxsc0NvdW50OyBpKyspIHtcbiAgICAgIGNlbGxzLnB1c2goUGJsQ2VsbENvbnRleHQuZGVmYXVsdFN0YXRlKCkpO1xuICAgIH1cbiAgICByZXR1cm4geyBpZGVudGl0eSwgZHNJbmRleCwgY2VsbHMsIGZpcnN0UmVuZGVyOiB0cnVlLCBleHRlcm5hbDoge30gfTtcbiAgfVxuXG4gIGdldEV4dGVybmFsPFAgZXh0ZW5kcyBrZXlvZiBFeHRlcm5hbFJvd0NvbnRleHRTdGF0ZT4oa2V5OiBQKTogRXh0ZXJuYWxSb3dDb250ZXh0U3RhdGVbUF0ge1xuICAgIHJldHVybiB0aGlzLmV4dGVybmFsW2tleV07XG4gIH1cblxuICBzZXRFeHRlcm5hbDxQIGV4dGVuZHMga2V5b2YgRXh0ZXJuYWxSb3dDb250ZXh0U3RhdGU+KGtleTogUCwgdmFsdWU6IEV4dGVybmFsUm93Q29udGV4dFN0YXRlW1BdLCBzYXZlU3RhdGUgPSBmYWxzZSkge1xuICAgIHRoaXMuZXh0ZXJuYWxba2V5XSA9IHZhbHVlO1xuICAgIGlmIChzYXZlU3RhdGUpIHtcbiAgICAgIHRoaXMuc2F2ZVN0YXRlKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0U3RhdGUoKTogUm93Q29udGV4dFN0YXRlPFQ+IHtcbiAgICByZXR1cm4ge1xuICAgICAgaWRlbnRpdHk6IHRoaXMuaWRlbnRpdHksXG4gICAgICBkc0luZGV4OiB0aGlzLmRzSW5kZXgsXG4gICAgICBmaXJzdFJlbmRlcjogdGhpcy5maXJzdFJlbmRlcixcbiAgICAgIGNlbGxzOiB0aGlzLmNlbGxzLm1hcCggYyA9PiBjLmdldFN0YXRlKCkgKSxcbiAgICAgIGV4dGVybmFsOiB0aGlzLmV4dGVybmFsLFxuICAgIH07XG4gIH1cblxuICBmcm9tU3RhdGUoc3RhdGU6IFJvd0NvbnRleHRTdGF0ZTxUPik6IHZvaWQge1xuICAgIHRoaXMuZmlyc3RSZW5kZXIgPSBzdGF0ZS5maXJzdFJlbmRlcjtcbiAgICB0aGlzLmRzSW5kZXggPSBzdGF0ZS5kc0luZGV4O1xuICAgIHRoaXMuZXh0ZXJuYWwgPSBzdGF0ZS5leHRlcm5hbDtcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gdGhpcy5jZWxscy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgdGhpcy5jZWxsc1tpXS5mcm9tU3RhdGUoc3RhdGUuY2VsbHNbaV0sIHRoaXMpO1xuICAgIH1cbiAgfVxuXG4gIHNhdmVTdGF0ZSgpIHtcbiAgICB0aGlzLmV4dEFwaS5jb250ZXh0QXBpLnNhdmVTdGF0ZSh0aGlzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBjZWxsIGNvbnRleHQgZm9yIHRoZSBjb2x1bW4gYXQgdGhlIHNwZWNpZmllZCBwb3NpdGlvbi5cbiAgICogPiBUaGUgcG9zaXRpb24gaXMgcmVsYXRpdmUgdG8gQUxMIGNvbHVtbnMgKE5PVCBSRU5ERVJFRCBDT0xVTU5TKVxuICAgKi9cbiAgY2VsbChpbmRleDogbnVtYmVyIHwgUGJsQ29sdW1uKTogUGJsQ2VsbENvbnRleHQ8VD4gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGlkeCA9IHR5cGVvZiBpbmRleCA9PT0gJ251bWJlcicgPyBpbmRleCA6IHRoaXMuZ3JpZC5jb2x1bW5BcGkuaW5kZXhPZihpbmRleCk7XG4gICAgcmV0dXJuIHRoaXMuY2VsbHNbaWR4XTtcbiAgfVxuXG4gIGdldENlbGxzKCk6IFBibENlbGxDb250ZXh0PFQ+W10ge1xuICAgIHJldHVybiAodGhpcy5jZWxscyAmJiB0aGlzLmNlbGxzLnNsaWNlKCkpIHx8IFtdO1xuICB9XG5cbiAgdXBkYXRlQ2VsbChjZWxsOiBQYmxDZWxsQ29udGV4dDxUPik6IHZvaWQge1xuICAgIHRoaXMuY2VsbHNbY2VsbC5pbmRleF0gPSBjZWxsLmNsb25lKCk7XG4gIH1cblxuICBhdHRhY2hSb3cocm93OiBQYmxOZ3JpZFJvd0NvbXBvbmVudDxUPikge1xuICAgIHRoaXMuZGV0YWNoUm93KHRoaXMuX2F0dGFjaGVkUm93KTtcbiAgICB0aGlzLl9hdHRhY2hlZFJvdyA9IHJvdztcbiAgICBpZiAodGhpcy5fdXBkYXRlUGVuZGluZykge1xuICAgICAgdGhpcy51cGRhdGVSb3dEYXRhKCk7XG4gICAgfVxuICB9XG5cbiAgZGV0YWNoUm93KHJvdzogUGJsTmdyaWRSb3dDb21wb25lbnQ8VD4pIHtcbiAgICBpZiAocm93ICYmIHRoaXMuX2F0dGFjaGVkUm93ID09PSByb3cpIHtcbiAgICAgIHRoaXMuc2F2ZVN0YXRlKCk7XG4gICAgICB0aGlzLl9hdHRhY2hlZFJvdyA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBfcmVidWlsZENlbGxzKGNvbHVtbnM6IFBibENvbHVtbltdKSB7XG4gICAgY29uc3QgY2VsbHMgPSB0aGlzLmNlbGxzID0gW107XG4gICAgY29uc3QgbGVuID0gY29sdW1ucy5sZW5ndGg7XG5cbiAgICBmb3IgKGxldCBjb2x1bW5JbmRleCA9IDA7IGNvbHVtbkluZGV4IDwgbGVuOyBjb2x1bW5JbmRleCsrKSB7XG4gICAgICBjb25zdCBjZWxsQ29udGV4dCA9IFBibENlbGxDb250ZXh0LmNyZWF0ZTxUPih0aGlzLCBjb2x1bW5zW2NvbHVtbkluZGV4XSwgdGhpcy5leHRBcGkpO1xuICAgICAgY2VsbHMucHVzaChjZWxsQ29udGV4dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVSb3dEYXRhKCkge1xuICAgIGlmICh0aGlzLl9hdHRhY2hlZFJvdykge1xuICAgICAgdGhpcy5fdXBkYXRlUGVuZGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5leHRBcGkuY29udGV4dEFwaS5fdXBkYXRlUm93Q29udGV4dCh0aGlzLCB0aGlzLl9hdHRhY2hlZFJvdy5yb3dJbmRleCk7XG4gICAgICB0aGlzLl9hdHRhY2hlZFJvdy51cGRhdGVSb3coKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fdXBkYXRlUGVuZGluZyA9ICEhdGhpcy5fJGltcGxpY2l0O1xuICAgIH1cbiAgfVxufVxuIl19