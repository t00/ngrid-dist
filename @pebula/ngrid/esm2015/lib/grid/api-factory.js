import { of, Subject, EMPTY } from 'rxjs';
import { ChangeDetectorRef, ElementRef, Injector, IterableDiffers, ViewContainerRef } from '@angular/core';
import { ON_DESTROY, ON_CONSTRUCTED } from '@pebula/ngrid/core';
import { PblNgridPluginContext } from '../ext/plugin-control';
import { ColumnApi, PblColumnStore } from './column/management';
import { PblNgridColumnWidthCalc } from './column/width-logic/column-width-calc';
import { PblRowsApi } from './row/rows-api';
import { PblNgridCellFactoryResolver } from './row/cell-factory.service';
import { ContextApi } from './context/api';
import { bindGridToDataSource } from './bind-grid-to-datasource';
import { logicap } from './logicap/index';
export function createApis(grid, tokens) {
    return new InternalExtensionApi(grid, tokens);
}
class InternalExtensionApi {
    constructor(grid, tokens) {
        this.grid = grid;
        this.propChanged = this._propChanged = new Subject();
        this.config = tokens.config;
        this.registry = tokens.registry;
        this.element = tokens.elRef.nativeElement;
        if (tokens.dir) {
            this.dir = tokens.dir;
        }
        const { plugin, init } = this.createPlugin(tokens);
        this._create = init;
        this.plugin = plugin;
        this.events = plugin.events;
        this.columnStore = new PblColumnStore(this, tokens.injector.get(IterableDiffers));
        this.widthCalc = new PblNgridColumnWidthCalc(this);
        const cellFactory = tokens.injector.get(PblNgridCellFactoryResolver);
        this.rowsApi = new PblRowsApi(this, tokens.ngZone, cellFactory);
        this.columnApi = ColumnApi.create(this);
        this._contextApi = new ContextApi(this);
        this.logicaps = logicap(this);
        bindGridToDataSource(this);
        this.events.pipe(ON_DESTROY).subscribe(e => this._propChanged.complete());
        this.widthCalc
            .onWidthCalc
            .subscribe(rowWidth => {
            this._cdkTable.minWidth = rowWidth.minimumRowWidth;
            tokens.ngZone.run(() => {
                this.rowsApi.syncRows('header');
                this.plugin.emitEvent({ source: 'grid', kind: 'onResizeRow' });
            });
        });
    }
    get cdkTable() { return this._cdkTable; }
    get contextApi() { return this._contextApi || (this._contextApi = new ContextApi(this)); }
    get viewport() { return this._viewPort; }
    get pluginCtrl() { return this.plugin.controller; }
    getDirection() {
        var _a, _b;
        return (_b = (_a = this.dir) === null || _a === void 0 ? void 0 : _a.value) !== null && _b !== void 0 ? _b : 'ltr';
    }
    directionChange() {
        var _a, _b;
        return (_b = (_a = this.dir) === null || _a === void 0 ? void 0 : _a.change.asObservable()) !== null && _b !== void 0 ? _b : EMPTY;
    }
    onConstructed(fn) {
        if (!this._create) {
            of(false);
        }
        else {
            this.events.pipe(ON_CONSTRUCTED).subscribe(fn);
        }
    }
    onInit(fn) {
        this.plugin.controller.onInit().subscribe(fn);
    }
    setCdkTable(cdkTable) {
        this._cdkTable = cdkTable;
        const globalCreateEvent = this._create;
        delete this._create;
        this.plugin.emitEvent({ source: 'grid', kind: 'onConstructed' });
        globalCreateEvent();
    }
    setViewport(viewport) {
        this._viewPort = viewport;
    }
    notifyPropChanged(source, key, prev, curr) {
        if (prev !== curr) {
            this._propChanged.next({ source, key, prev, curr });
        }
    }
    createPlugin(tokens) {
        // Create an injector for the extensions/plugins
        // This injector allow plugins (that choose so) to provide a factory function for runtime use.
        // I.E: as if they we're created by angular via template...
        // This allows seamless plugin-to-plugin dependencies without requiring specific template syntax.
        // And also allows auto plugin binding (app wide) without the need for template syntax.
        const pluginInjector = Injector.create({
            providers: [
                { provide: ViewContainerRef, useValue: tokens.vcRef },
                { provide: ElementRef, useValue: tokens.elRef },
                { provide: ChangeDetectorRef, useValue: tokens.cdRef },
            ],
            parent: tokens.injector,
        });
        return PblNgridPluginContext.create(pluginInjector, this);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL25ncmlkL3NyYy9saWIvZ3JpZC9hcGktZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFVLGdCQUFnQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR25ILE9BQU8sRUFBeUMsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBR3ZHLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTlELE9BQU8sRUFBRSxTQUFTLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDaEUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFHakYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHM0MsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUFFLE9BQU8sRUFBWSxNQUFNLGlCQUFpQixDQUFDO0FBYXBELE1BQU0sVUFBVSxVQUFVLENBQUksSUFBMEIsRUFBRSxNQUE2QjtJQUNyRixPQUFPLElBQUksb0JBQW9CLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ2hELENBQUM7QUFFRCxNQUFNLG9CQUFvQjtJQXlCeEIsWUFBNEIsSUFBMEIsRUFBRSxNQUE2QjtRQUF6RCxTQUFJLEdBQUosSUFBSSxDQUFzQjtRQUNwRCxJQUFJLENB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QUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQVEsQ0FBQyxDQUFDO1NBQzFEO0lBQ0gsQ0FBQztJQUVPLFlBQVksQ0FBQyxNQUE2QjtRQUNoRCxnREFBZ0Q7UUFDaEQsOEZBQThGO1FBQzlGLDJEQUEyRDtRQUMzRCxpR0FBaUc7UUFDakcsdUZBQXVGO1FBQ3ZGLE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7WUFDckMsU0FBUyxFQUFFO2dCQUNULEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFO2dCQUNyRCxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxLQUFLLEVBQUU7Z0JBQy9DLEVBQUUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFO2FBQ3ZEO1lBQ0QsTUFBTSxFQUFFLE1BQU0sQ0FBQyxRQUFRO1NBQ3hCLENBQUMsQ0FBQztRQUNILE9BQU8scUJBQXFCLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM1RCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCwgRU1QVFkgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IENoYW5nZURldGVjdG9yUmVmLCBFbGVtZW50UmVmLCBJbmplY3RvciwgSXRlcmFibGVEaWZmZXJzLCBOZ1pvbmUsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERpcmVjdGlvbiwgRGlyZWN0aW9uYWxpdHkgfSBmcm9tICdAYW5ndWxhci9jZGsvYmlkaSc7XG5cbmltcG9ydCB7IFBibE5ncmlkQ29uZmlnU2VydmljZSwgUGJsTmdyaWRFdmVudHMsIE9OX0RFU1RST1ksIE9OX0NPTlNUUlVDVEVEIH0gZnJvbSAnQHBlYnVsYS9uZ3JpZC9jb3JlJztcbmltcG9ydCB7IFBibE5ncmlkUmVnaXN0cnlTZXJ2aWNlIH0gZnJvbSAnLi9yZWdpc3RyeS9yZWdpc3RyeS5zZXJ2aWNlJztcbmltcG9ydCB7IFBibE5ncmlkSW50ZXJuYWxFeHRlbnNpb25BcGkgfSBmcm9tICcuLi9leHQvZ3JpZC1leHQtYXBpJztcbmltcG9ydCB7IFBibE5ncmlkUGx1Z2luQ29udGV4dCB9IGZyb20gJy4uL2V4dC9wbHVnaW4tY29udHJvbCc7XG5pbXBvcnQgeyBPblByb3BDaGFuZ2VkRXZlbnQgfSBmcm9tICcuLi9leHQvdHlwZXMnO1xuaW1wb3J0IHsgQ29sdW1uQXBpLCBQYmxDb2x1bW5TdG9yZSB9IGZyb20gJy4vY29sdW1uL21hbmFnZW1lbnQnO1xuaW1wb3J0IHsgUGJsTmdyaWRDb2x1bW5XaWR0aENhbGMgfSBmcm9tICcuL2NvbHVtbi93aWR0aC1sb2dpYy9jb2x1bW4td2lkdGgtY2FsYyc7XG5pbXBvcnQgeyBQYmxOZ3JpZENvbXBvbmVudCB9IGZyb20gJy4vbmdyaWQuY29tcG9uZW50JztcbmltcG9ydCB7IFBibENka1RhYmxlQ29tcG9uZW50IH0gZnJvbSAnLi9wYmwtY2RrLXRhYmxlL3BibC1jZGstdGFibGUuY29tcG9uZW50JztcbmltcG9ydCB7IFBibFJvd3NBcGkgfSBmcm9tICcuL3Jvdy9yb3dzLWFwaSc7XG5pbXBvcnQgeyBQYmxOZ3JpZENlbGxGYWN0b3J5UmVzb2x2ZXIgfSBmcm9tICcuL3Jvdy9jZWxsLWZhY3Rvcnkuc2VydmljZSc7XG5pbXBvcnQgeyBDb250ZXh0QXBpIH0gZnJvbSAnLi9jb250ZXh0L2FwaSc7XG5pbXBvcnQgeyBQYmxOZ3JpZE1ldGFSb3dTZXJ2aWNlIH0gZnJvbSAnLi9tZXRhLXJvd3MvbWV0YS1yb3cuc2VydmljZSc7XG5pbXBvcnQgeyBQYmxDZGtWaXJ0dWFsU2Nyb2xsVmlld3BvcnRDb21wb25lbnQgfSBmcm9tICcuL2ZlYXR1cmVzL3ZpcnR1YWwtc2Nyb2xsL3ZpcnR1YWwtc2Nyb2xsLXZpZXdwb3J0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBiaW5kR3JpZFRvRGF0YVNvdXJjZSB9IGZyb20gJy4vYmluZC1ncmlkLXRvLWRhdGFzb3VyY2UnO1xuaW1wb3J0IHsgbG9naWNhcCwgTG9naWNhcHMgfSBmcm9tICcuL2xvZ2ljYXAvaW5kZXgnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlcXVpcmVkQW5ndWxhclRva2VucyB7XG4gIG5nWm9uZTogTmdab25lO1xuICBpbmplY3RvcjogSW5qZWN0b3I7XG4gIHZjUmVmOiBWaWV3Q29udGFpbmVyUmVmO1xuICBjZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWY7XG4gIGVsUmVmOiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PjtcbiAgY29uZmlnOiBQYmxOZ3JpZENvbmZpZ1NlcnZpY2U7XG4gIHJlZ2lzdHJ5OiBQYmxOZ3JpZFJlZ2lzdHJ5U2VydmljZTtcbiAgZGlyPzogRGlyZWN0aW9uYWxpdHk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVBcGlzPFQ+KGdyaWQ6IFBibE5ncmlkQ29tcG9uZW50PFQ+LCB0b2tlbnM6IFJlcXVpcmVkQW5ndWxhclRva2Vucykge1xuICByZXR1cm4gbmV3IEludGVybmFsRXh0ZW5zaW9uQXBpKGdyaWQsIHRva2Vucyk7XG59XG5cbmNsYXNzIEludGVybmFsRXh0ZW5zaW9uQXBpPFQgPSBhbnk+IGltcGxlbWVudHMgUGJsTmdyaWRJbnRlcm5hbEV4dGVuc2lvbkFwaTxUPiB7XG4gIHJlYWRvbmx5IGNvbmZpZzogUGJsTmdyaWRDb25maWdTZXJ2aWNlO1xuICByZWFkb25seSByZWdpc3RyeTogUGJsTmdyaWRSZWdpc3RyeVNlcnZpY2U7XG4gIHJlYWRvbmx5IGVsZW1lbnQ6IEhUTUxFbGVtZW50O1xuICByZWFkb25seSBwcm9wQ2hhbmdlZDogT2JzZXJ2YWJsZTxPblByb3BDaGFuZ2VkRXZlbnQ+O1xuICByZWFkb25seSBjb2x1bW5TdG9yZTogUGJsQ29sdW1uU3RvcmU7XG4gIHJlYWRvbmx5IGNvbHVtbkFwaTogQ29sdW1uQXBpPFQ+O1xuICByZWFkb25seSByb3dzQXBpOiBQYmxSb3dzQXBpPFQ+O1xuICByZWFkb25seSBldmVudHM6IE9ic2VydmFibGU8UGJsTmdyaWRFdmVudHM+O1xuICByZWFkb25seSBwbHVnaW46IFBibE5ncmlkUGx1Z2luQ29udGV4dDtcbiAgcmVhZG9ubHkgd2lkdGhDYWxjOiBQYmxOZ3JpZENvbHVtbldpZHRoQ2FsYztcbiAgcmVhZG9ubHkgbG9naWNhcHM6IExvZ2ljYXBzO1xuXG4gIGdldCBjZGtUYWJsZSgpIHsgcmV0dXJuIHRoaXMuX2Nka1RhYmxlOyB9XG4gIGdldCBjb250ZXh0QXBpKCkgeyByZXR1cm4gdGhpcy5fY29udGV4dEFwaSB8fCAodGhpcy5fY29udGV4dEFwaSA9IG5ldyBDb250ZXh0QXBpPFQ+KHRoaXMpKTsgfVxuICBnZXQgdmlld3BvcnQoKTogUGJsQ2RrVmlydHVhbFNjcm9sbFZpZXdwb3J0Q29tcG9uZW50IHsgcmV0dXJuIHRoaXMuX3ZpZXdQb3J0OyB9XG4gIGdldCBwbHVnaW5DdHJsKCkgeyByZXR1cm4gdGhpcy5wbHVnaW4uY29udHJvbGxlcjsgfVxuXG4gIHByaXZhdGUgX2Nka1RhYmxlOiBQYmxDZGtUYWJsZUNvbXBvbmVudDxUPjtcbiAgcHJpdmF0ZSBfY29udGV4dEFwaTogQ29udGV4dEFwaTxUPjtcbiAgcHJpdmF0ZSBfdmlld1BvcnQ6IFBibENka1ZpcnR1YWxTY3JvbGxWaWV3cG9ydENvbXBvbmVudDtcbiAgcHJpdmF0ZSBfY3JlYXRlOiAoKSA9PiB2b2lkO1xuICBwcml2YXRlIGRpcj86IERpcmVjdGlvbmFsaXR5O1xuICBwcml2YXRlIHJlYWRvbmx5IF9wcm9wQ2hhbmdlZDogU3ViamVjdDxPblByb3BDaGFuZ2VkRXZlbnQ+O1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSBncmlkOiBQYmxOZ3JpZENvbXBvbmVudDxUPiwgdG9rZW5zOiBSZXF1aXJlZEFuZ3VsYXJUb2tlbnMpIHtcbiAgICB0aGlzLnByb3BDaGFuZ2VkID0gdGhpcy5fcHJvcENoYW5nZWQgPSBuZXcgU3ViamVjdDxPblByb3BDaGFuZ2VkRXZlbnQ+KCk7XG5cbiAgICB0aGlzLmNvbmZpZyA9IHRva2Vucy5jb25maWc7XG4gICAgdGhpcy5yZWdpc3RyeSA9IHRva2Vucy5yZWdpc3RyeTtcbiAgICB0aGlzLmVsZW1lbnQgPSB0b2tlbnMuZWxSZWYubmF0aXZlRWxlbWVudDtcbiAgICBpZiAodG9rZW5zLmRpcikge1xuICAgICAgdGhpcy5kaXIgPSB0b2tlbnMuZGlyO1xuICAgIH1cblxuICAgIGNvbnN0IHsgcGx1Z2luLCBpbml0IH0gPSB0aGlzLmNyZWF0ZVBsdWdpbih0b2tlbnMpO1xuICAgIHRoaXMuX2NyZWF0ZSA9IGluaXQ7XG4gICAgdGhpcy5wbHVnaW4gPSBwbHVnaW47XG4gICAgdGhpcy5ldmVudHMgPSBwbHVnaW4uZXZlbnRzO1xuICAgIHRoaXMuY29sdW1uU3RvcmUgPSBuZXcgUGJsQ29sdW1uU3RvcmUodGhpcywgdG9rZW5zLmluamVjdG9yLmdldChJdGVyYWJsZURpZmZlcnMpKTtcbiAgICB0aGlzLndpZHRoQ2FsYyA9IG5ldyBQYmxOZ3JpZENvbHVtbldpZHRoQ2FsYyh0aGlzKTtcblxuICAgIGNvbnN0IGNlbGxGYWN0b3J5ID0gdG9rZW5zLmluamVjdG9yLmdldChQYmxOZ3JpZENlbGxGYWN0b3J5UmVzb2x2ZXIpO1xuICAgIHRoaXMucm93c0FwaSA9IG5ldyBQYmxSb3dzQXBpPFQ+KHRoaXMsIHRva2Vucy5uZ1pvbmUsIGNlbGxGYWN0b3J5KTtcblxuICAgIHRoaXMuY29sdW1uQXBpID0gQ29sdW1uQXBpLmNyZWF0ZTxUPih0aGlzKTtcbiAgICB0aGlzLl9jb250ZXh0QXBpID0gbmV3IENvbnRleHRBcGk8VD4odGhpcyk7XG4gICAgdGhpcy5sb2dpY2FwcyA9IGxvZ2ljYXAodGhpcyk7XG5cbiAgICBiaW5kR3JpZFRvRGF0YVNvdXJjZSh0aGlzKTtcblxuICAgIHRoaXMuZXZlbnRzLnBpcGUoT05fREVTVFJPWSkuc3Vic2NyaWJlKCBlID0+IHRoaXMuX3Byb3BDaGFuZ2VkLmNvbXBsZXRlKCkgKTtcblxuICAgIHRoaXMud2lkdGhDYWxjXG4gICAgICAub25XaWR0aENhbGNcbiAgICAgIC5zdWJzY3JpYmUoIHJvd1dpZHRoID0+IHtcbiAgICAgICAgdGhpcy5fY2RrVGFibGUubWluV2lkdGggPSByb3dXaWR0aC5taW5pbXVtUm93V2lkdGg7XG5cbiAgICAgICAgdG9rZW5zLm5nWm9uZS5ydW4oICgpID0+IHtcbiAgICAgICAgICB0aGlzLnJvd3NBcGkuc3luY1Jvd3MoJ2hlYWRlcicpO1xuICAgICAgICAgIHRoaXMucGx1Z2luLmVtaXRFdmVudCh7IHNvdXJjZTogJ2dyaWQnLCBraW5kOiAnb25SZXNpemVSb3cnIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgZ2V0RGlyZWN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmRpcj8udmFsdWUgPz8gJ2x0cic7XG4gIH1cblxuICBkaXJlY3Rpb25DaGFuZ2UoKTogT2JzZXJ2YWJsZTxEaXJlY3Rpb24+IHtcbiAgICByZXR1cm4gdGhpcy5kaXI/LmNoYW5nZS5hc09ic2VydmFibGUoKSA/PyBFTVBUWTtcbiAgfVxuXG4gIG9uQ29uc3RydWN0ZWQoZm46ICgpID0+IHZvaWQpIHtcbiAgICBpZiAoIXRoaXMuX2NyZWF0ZSkge1xuICAgICAgb2YoZmFsc2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmV2ZW50cy5waXBlKE9OX0NPTlNUUlVDVEVEKS5zdWJzY3JpYmUoZm4pO1xuICAgIH1cbiAgfVxuXG4gIG9uSW5pdChmbjogKCkgPT4gdm9pZCkge1xuICAgIHRoaXMucGx1Z2luLmNvbnRyb2xsZXIub25Jbml0KCkuc3Vic2NyaWJlKGZuKTtcbiAgfVxuXG4gIHNldENka1RhYmxlKGNka1RhYmxlOiBQYmxDZGtUYWJsZUNvbXBvbmVudDxUPikge1xuICAgIHRoaXMuX2Nka1RhYmxlID0gY2RrVGFibGU7XG4gICAgY29uc3QgZ2xvYmFsQ3JlYXRlRXZlbnQgPSB0aGlzLl9jcmVhdGU7XG4gICAgZGVsZXRlIHRoaXMuX2NyZWF0ZTtcbiAgICB0aGlzLnBsdWdpbi5lbWl0RXZlbnQoeyBzb3VyY2U6ICdncmlkJywga2luZDogJ29uQ29uc3RydWN0ZWQnIH0pO1xuICAgIGdsb2JhbENyZWF0ZUV2ZW50KCk7XG4gIH1cblxuICBzZXRWaWV3cG9ydCh2aWV3cG9ydDogUGJsQ2RrVmlydHVhbFNjcm9sbFZpZXdwb3J0Q29tcG9uZW50KSB7XG4gICAgdGhpcy5fdmlld1BvcnQgPSB2aWV3cG9ydDtcbiAgfVxuXG4gIG5vdGlmeVByb3BDaGFuZ2VkKHNvdXJjZSwga2V5LCBwcmV2LCBjdXJyKSB7XG4gICAgaWYgKHByZXYgIT09IGN1cnIpIHtcbiAgICAgIHRoaXMuX3Byb3BDaGFuZ2VkLm5leHQoe3NvdXJjZSwga2V5LCBwcmV2LCBjdXJyfSBhcyBhbnkpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUGx1Z2luKHRva2VuczogUmVxdWlyZWRBbmd1bGFyVG9rZW5zKSB7XG4gICAgLy8gQ3JlYXRlIGFuIGluamVjdG9yIGZvciB0aGUgZXh0ZW5zaW9ucy9wbHVnaW5zXG4gICAgLy8gVGhpcyBpbmplY3RvciBhbGxvdyBwbHVnaW5zICh0aGF0IGNob29zZSBzbykgdG8gcHJvdmlkZSBhIGZhY3RvcnkgZnVuY3Rpb24gZm9yIHJ1bnRpbWUgdXNlLlxuICAgIC8vIEkuRTogYXMgaWYgdGhleSB3ZSdyZSBjcmVhdGVkIGJ5IGFuZ3VsYXIgdmlhIHRlbXBsYXRlLi4uXG4gICAgLy8gVGhpcyBhbGxvd3Mgc2VhbWxlc3MgcGx1Z2luLXRvLXBsdWdpbiBkZXBlbmRlbmNpZXMgd2l0aG91dCByZXF1aXJpbmcgc3BlY2lmaWMgdGVtcGxhdGUgc3ludGF4LlxuICAgIC8vIEFuZCBhbHNvIGFsbG93cyBhdXRvIHBsdWdpbiBiaW5kaW5nIChhcHAgd2lkZSkgd2l0aG91dCB0aGUgbmVlZCBmb3IgdGVtcGxhdGUgc3ludGF4LlxuICAgIGNvbnN0IHBsdWdpbkluamVjdG9yID0gSW5qZWN0b3IuY3JlYXRlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICB7IHByb3ZpZGU6IFZpZXdDb250YWluZXJSZWYsIHVzZVZhbHVlOiB0b2tlbnMudmNSZWYgfSxcbiAgICAgICAgeyBwcm92aWRlOiBFbGVtZW50UmVmLCB1c2VWYWx1ZTogdG9rZW5zLmVsUmVmIH0sXG4gICAgICAgIHsgcHJvdmlkZTogQ2hhbmdlRGV0ZWN0b3JSZWYsIHVzZVZhbHVlOiB0b2tlbnMuY2RSZWYgfSxcbiAgICAgIF0sXG4gICAgICBwYXJlbnQ6IHRva2Vucy5pbmplY3RvcixcbiAgICB9KTtcbiAgICByZXR1cm4gUGJsTmdyaWRQbHVnaW5Db250ZXh0LmNyZWF0ZShwbHVnaW5JbmplY3RvciwgdGhpcyk7XG4gIH1cbn1cbiJdfQ==