import { isObservable, of as obsOf, from as obsFrom } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { ON_INVALIDATE_HEADERS, unrx } from '@pebula/ngrid/core';
export const LOCAL_COLUMN_DEF = Symbol('LOCAL_COLUMN_DEF');
export const VIRTUAL_REFRESH = {};
export class TransposeTableSession {
    constructor(grid, pluginCtrl, updateColumns, sourceFactoryWrapper) {
        this.grid = grid;
        this.pluginCtrl = pluginCtrl;
        this.updateColumns = updateColumns;
        this.sourceFactoryWrapper = sourceFactoryWrapper;
        this.init();
        if (grid.columns && grid.columnApi.visibleColumns.length > 0) {
            this.onInvalidateHeaders();
        }
        this.onDataSource(this.grid.ds);
    }
    destroy(updateTable) {
        if (!this.destroyed) {
            this.destroyed = true;
            unrx.kill(this, this.grid);
            this.grid.showHeader = this.headerRow;
            this.grid.columns = this.columnsInput;
            if (updateTable) {
                this.grid.invalidateColumns();
                this.grid.ds.refresh(VIRTUAL_REFRESH);
            }
        }
    }
    init() {
        this.headerRow = this.grid.showHeader;
        this.grid.showHeader = false;
        this.pluginCtrl.events
            .pipe(ON_INVALIDATE_HEADERS, unrx(this, this.grid))
            .subscribe(e => this.onInvalidateHeaders());
        this.pluginCtrl.events
            .pipe(unrx(this, this.grid))
            .subscribe(e => e.kind === 'onDataSource' && this.onDataSource(e.curr));
    }
    onInvalidateHeaders() {
        if (!this.grid.columns[LOCAL_COLUMN_DEF]) {
            this.columnsInput = this.grid.columns;
            this.storeColumns = this.grid.columnApi.visibleColumns;
            this.updateColumns();
        }
    }
    onDataSource(ds) {
        this.unPatchDataSource();
        if (ds) {
            this.ds = ds;
            this.dsSourceFactory = ds.adapter.sourceFactory;
            this.ds.adapter.sourceFactory = (event) => {
                const rawSource = event.data.changed && event.data.curr === VIRTUAL_REFRESH
                    ? this.ds.source
                    : this.dsSourceFactory(event);
                if (rawSource === false) {
                    return rawSource;
                }
                else if (this.destroyed) {
                    this.unPatchDataSource();
                    return this.rawSource;
                }
                const obs = isObservable(rawSource)
                    ? rawSource
                    : Array.isArray(rawSource) ? obsOf(rawSource) : obsFrom(rawSource) // promise...
                ;
                return obs
                    .pipe(tap(source => this.rawSource = source), map(this.sourceFactoryWrapper));
            };
        }
    }
    unPatchDataSource() {
        if (this.ds) {
            this.ds.adapter.sourceFactory = this.dsSourceFactory;
            this.ds = this.dsSourceFactory = undefined;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNwb3NlLXRhYmxlLXNlc3Npb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL25ncmlkL3RyYW5zcG9zZS9zcmMvbGliL3RyYW5zcG9zZS10YWJsZS1zZXNzaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxZQUFZLEVBQUUsRUFBRSxJQUFJLEtBQUssRUFBRSxJQUFJLElBQUksT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlFLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFMUMsT0FBTyxFQUErQixxQkFBcUIsRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQVM5RixNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUMzRCxNQUFNLENBQUMsTUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDO0FBRWxDLE1BQU0sT0FBTyxxQkFBcUI7SUFVaEMsWUFBb0IsSUFBNEIsRUFDNUIsVUFBb0MsRUFDcEMsYUFBeUIsRUFDekIsb0JBQStDO1FBSC9DLFNBQUksR0FBSixJQUFJLENBQXdCO1FBQzVCLGVBQVUsR0FBVixVQUFVLENBQTBCO1FBQ3BDLGtCQUFhLEdBQWIsYUFBYSxDQUFZO1FBQ3pCLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBMkI7UUFDakUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1osSUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDNUQsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7U0FDNUI7UUFDRCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELE9BQU8sQ0FBQyxXQUFvQjtR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Q0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBTSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLGFBQWE7aUJBQ3RGO2dCQUNELE9BQU8sR0FBRztxQkFDUCxJQUFJLENBQ0gsR0FBRyxDQUFFLE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUUsRUFDeEMsR0FBRyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUMvQixDQUFDO1lBQ04sQ0FBQyxDQUFBO1NBQ0Y7SUFDSCxDQUFDO0lBRU8saUJBQWlCO1FBQ3ZCLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNYLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDO1lBQ3JELElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLGVBQWUsR0FBRyxTQUFTLENBQUM7U0FDNUM7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBpc09ic2VydmFibGUsIG9mIGFzIG9ic09mLCBmcm9tIGFzIG9ic0Zyb20gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBQYmxOZ3JpZENvbHVtbkRlZmluaXRpb25TZXQsIE9OX0lOVkFMSURBVEVfSEVBREVSUywgdW5yeCB9IGZyb20gJ0BwZWJ1bGEvbmdyaWQvY29yZSc7XG5pbXBvcnQge1xuICBQYmxOZ3JpZENvbXBvbmVudCxcbiAgUGJsTmdyaWRQbHVnaW5Db250cm9sbGVyLFxuICBQYmxEYXRhU291cmNlLFxuICBQYmxDb2x1bW4sXG4gIFBibERhdGFTb3VyY2VUcmlnZ2VyQ2hhbmdlZEV2ZW50LFxufSBmcm9tICdAcGVidWxhL25ncmlkJztcblxuZXhwb3J0IGNvbnN0IExPQ0FMX0NPTFVNTl9ERUYgPSBTeW1ib2woJ0xPQ0FMX0NPTFVNTl9ERUYnKTtcbmV4cG9ydCBjb25zdCBWSVJUVUFMX1JFRlJFU0ggPSB7fTtcblxuZXhwb3J0IGNsYXNzIFRyYW5zcG9zZVRhYmxlU2Vzc2lvbiB7XG4gIGRzU291cmNlRmFjdG9yeTogYW55O1xuICBkczogUGJsRGF0YVNvdXJjZTxhbnk+O1xuICBjb2x1bW5zSW5wdXQ6IFBibE5ncmlkQ29sdW1uRGVmaW5pdGlvblNldDtcbiAgc3RvcmVDb2x1bW5zOiBQYmxDb2x1bW5bXTtcbiAgaGVhZGVyUm93OiBib29sZWFuO1xuXG4gIHByaXZhdGUgZGVzdHJveWVkOiBib29sZWFuO1xuICBwcml2YXRlIHJhd1NvdXJjZTogYW55W107XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBncmlkOiBQYmxOZ3JpZENvbXBvbmVudDxhbnk+LFxuICAgICAgICAgICAgICBwcml2YXRlIHBsdWdpbkN0cmw6IFBibE5ncmlkUGx1Z2luQ29udHJvbGxlcixcbiAgICAgICAgICAgICAgcHJpdmF0ZSB1cGRhdGVDb2x1bW5zOiAoKSA9PiB2b2lkLFxuICAgICAgICAgICAgICBwcml2YXRlIHNvdXJjZUZhY3RvcnlXcmFwcGVyOiAocmVzdWx0czogYW55W10pID0+IGFueVtdKSB7XG4gICAgdGhpcy5pbml0KCk7XG4gICAgaWYgKGdyaWQuY29sdW1ucyAmJiBncmlkLmNvbHVtbkFwaS52aXNpYmxlQ29sdW1ucy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLm9uSW52YWxpZGF0ZUhlYWRlcnMoKTtcbiAgICB9XG4gICAgdGhpcy5vbkRhdGFTb3VyY2UodGhpcy5ncmlkLmRzKTtcbiAgfVxuXG4gIGRlc3Ryb3kodXBkYXRlVGFibGU6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuZGVzdHJveWVkKSB7XG4gICAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWU7XG4gICAgICB1bnJ4LmtpbGwodGhpcywgdGhpcy5ncmlkKTtcblxuICAgICAgdGhpcy5ncmlkLnNob3dIZWFkZXIgPSB0aGlzLmhlYWRlclJvdztcbiAgICAgIHRoaXMuZ3JpZC5jb2x1bW5zID0gdGhpcy5jb2x1bW5zSW5wdXQ7XG4gICAgICBpZiAodXBkYXRlVGFibGUpIHtcbiAgICAgICAgdGhpcy5ncmlkLmludmFsaWRhdGVDb2x1bW5zKCk7XG4gICAgICAgIHRoaXMuZ3JpZC5kcy5yZWZyZXNoKFZJUlRVQUxfUkVGUkVTSCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0KCk6IHZvaWQge1xuICAgIHRoaXMuaGVhZGVyUm93ID0gdGhpcy5ncmlkLnNob3dIZWFkZXI7XG4gICAgdGhpcy5ncmlkLnNob3dIZWFkZXIgPSBmYWxzZTtcbiAgICB0aGlzLnBsdWdpbkN0cmwuZXZlbnRzXG4gICAgICAucGlwZShPTl9JTlZBTElEQVRFX0hFQURFUlMsIHVucngodGhpcywgdGhpcy5ncmlkKSlcbiAgICAgIC5zdWJzY3JpYmUoIGUgPT4gdGhpcy5vbkludmFsaWRhdGVIZWFkZXJzKCkgKTtcblxuICAgIHRoaXMucGx1Z2luQ3RybC5ldmVudHNcbiAgICAgIC5waXBlKHVucngodGhpcywgdGhpcy5ncmlkKSlcbiAgICAgIC5zdWJzY3JpYmUoIGUgPT4gZS5raW5kID09PSAnb25EYXRhU291cmNlJyAmJiB0aGlzLm9uRGF0YVNvdXJjZShlLmN1cnIpICk7XG4gIH1cblxuICBwcml2YXRlIG9uSW52YWxpZGF0ZUhlYWRlcnMoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmdyaWQuY29sdW1uc1tMT0NBTF9DT0xVTU5fREVGXSkge1xuICAgICAgdGhpcy5jb2x1bW5zSW5wdXQgPSB0aGlzLmdyaWQuY29sdW1ucztcbiAgICAgIHRoaXMuc3RvcmVDb2x1bW5zID0gdGhpcy5ncmlkLmNvbHVtbkFwaS52aXNpYmxlQ29sdW1ucztcbiAgICAgIHRoaXMudXBkYXRlQ29sdW1ucygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25EYXRhU291cmNlKGRzPzogUGJsRGF0YVNvdXJjZSk6IHZvaWQge1xuICAgIHRoaXMudW5QYXRjaERhdGFTb3VyY2UoKTtcbiAgICBpZiAoZHMpIHtcbiAgICAgIHRoaXMuZHMgPSBkcztcbiAgICAgIHRoaXMuZHNTb3VyY2VGYWN0b3J5ID0gZHMuYWRhcHRlci5zb3VyY2VGYWN0b3J5O1xuICAgICAgdGhpcy5kcy5hZGFwdGVyLnNvdXJjZUZhY3RvcnkgPSAoZXZlbnQ6IFBibERhdGFTb3VyY2VUcmlnZ2VyQ2hhbmdlZEV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IHJhd1NvdXJjZSA9IGV2ZW50LmRhdGEuY2hhbmdlZCAmJiBldmVudC5kYXRhLmN1cnIgPT09IFZJUlRVQUxfUkVGUkVTSFxuICAgICAgICAgID8gdGhpcy5kcy5zb3VyY2VcbiAgICAgICAgICA6IHRoaXMuZHNTb3VyY2VGYWN0b3J5KGV2ZW50KVxuICAgICAgICA7XG5cbiAgICAgICAgaWYgKHJhd1NvdXJjZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICByZXR1cm4gcmF3U291cmNlO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZGVzdHJveWVkKSB7XG4gICAgICAgICAgdGhpcy51blBhdGNoRGF0YVNvdXJjZSgpO1xuICAgICAgICAgIHJldHVybiB0aGlzLnJhd1NvdXJjZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG9iczogT2JzZXJ2YWJsZTxhbnlbXT4gPSBpc09ic2VydmFibGUocmF3U291cmNlKVxuICAgICAgICAgID8gcmF3U291cmNlXG4gICAgICAgICAgOiBBcnJheS5pc0FycmF5KHJhd1NvdXJjZSkgPyBvYnNPZjxhbnk+KHJhd1NvdXJjZSkgOiBvYnNGcm9tKHJhd1NvdXJjZSkgLy8gcHJvbWlzZS4uLlxuICAgICAgICA7XG4gICAgICAgIHJldHVybiBvYnNcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIHRhcCggc291cmNlID0+IHRoaXMucmF3U291cmNlID0gc291cmNlICksXG4gICAgICAgICAgICBtYXAodGhpcy5zb3VyY2VGYWN0b3J5V3JhcHBlciksXG4gICAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVuUGF0Y2hEYXRhU291cmNlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmRzKSB7XG4gICAgICB0aGlzLmRzLmFkYXB0ZXIuc291cmNlRmFjdG9yeSA9IHRoaXMuZHNTb3VyY2VGYWN0b3J5O1xuICAgICAgdGhpcy5kcyA9IHRoaXMuZHNTb3VyY2VGYWN0b3J5ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxufVxuIl19