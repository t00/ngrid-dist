import { Subject } from 'rxjs';
import { map, mapTo, filter, take, skip, debounceTime } from 'rxjs/operators';
import { Directive, Injector, Input } from '@angular/core';
import { ON_INVALIDATE_HEADERS, ON_RESIZE_ROW, ON_DESTROY } from '@pebula/ngrid/core';
import { PblNgridComponent, PblNgridPluginController } from '@pebula/ngrid';
import { hasState, saveState, loadState } from './core/index';
import { userSessionPref } from './presets';
import * as i0 from "@angular/core";
import * as i1 from "@pebula/ngrid";
export const PLUGIN_KEY = 'state';
export class PblNgridStatePlugin {
    constructor(grid, injector, pluginCtrl) {
        this.grid = grid;
        this.injector = injector;
        this.pluginCtrl = pluginCtrl;
        this._events = new Subject();
        this._removePlugin = pluginCtrl.setPlugin(PLUGIN_KEY, this);
        this.afterLoadState = this._events.pipe(filter(e => e.phase === 'load' && e.position === 'after'), mapTo(undefined));
        this.afterSaveState = this._events.pipe(filter(e => e.phase === 'save' && e.position === 'after'), mapTo(undefined));
        this.onError = this._events.pipe(filter(e => !!e.error), map(e => ({ phase: e.phase, error: e.error })));
        pluginCtrl.events
            .pipe(ON_INVALIDATE_HEADERS, take(1))
            .subscribe(event => {
            const initialLoadOptions = Object.assign(Object.assign({}, (this.loadOptions || {})), { avoidRedraw: true });
            hasState(grid, initialLoadOptions)
                .then(value => {
                if (value) {
                    return this._load(initialLoadOptions);
                }
            })
                .then(() => {
                pluginCtrl.events
                    .pipe(ON_RESIZE_ROW, skip(1), debounceTime(500))
                    .subscribe(event => this.save());
            });
        });
        pluginCtrl.events
            .pipe(ON_DESTROY)
            .subscribe(event => {
            event.wait(this.save());
            this._events.complete();
        });
    }
    static create(table, injector) {
        const pluginCtrl = PblNgridPluginController.find(table);
        return new PblNgridStatePlugin(table, injector, pluginCtrl);
    }
    load() {
        return this._load(this.loadOptions);
    }
    save() {
        return saveState(this.grid, this.saveOptions)
            .then(() => this._events.next({ phase: 'save', position: 'after' }))
            .catch(error => this._events.next({ phase: 'save', position: 'after', error }));
    }
    destroy() {
        this._removePlugin(this.grid);
    }
    _load(loadOptions) {
        return loadState(this.grid, loadOptions)
            .then(() => this._events.next({ phase: 'load', position: 'after' }))
            .catch(error => this._events.next({ phase: 'load', position: 'after', error }));
    }
}
export class PblNgridStatePluginDirective extends PblNgridStatePlugin {
    constructor(grid, injector, pluginCtrl) {
        super(grid, injector, pluginCtrl);
        this.loadOptions = { include: userSessionPref() };
        this.saveOptions = { include: userSessionPref() };
    }
    ngOnDestroy() {
        this.destroy();
    }
}
/** @nocollapse */ PblNgridStatePluginDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.0", ngImport: i0, type: PblNgridStatePluginDirective, deps: [{ token: i1.PblNgridComponent }, { token: i0.Injector }, { token: i1.PblNgridPluginController }], target: i0.ɵɵFactoryTarget.Directive });
/** @nocollapse */ PblNgridStatePluginDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.0.0", type: PblNgridStatePluginDirective, selector: "pbl-ngrid[persistState]", inputs: { loadOptions: "loadOptions", saveOptions: "saveOptions" }, outputs: { afterLoadState: "afterLoadState", afterSaveState: "afterSaveState", onError: "onError" }, usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.0", ngImport: i0, type: PblNgridStatePluginDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'pbl-ngrid[persistState]',
                    outputs: ['afterLoadState', 'afterSaveState', 'onError'],
                }]
        }], ctorParameters: function () { return [{ type: i1.PblNgridComponent }, { type: i0.Injector }, { type: i1.PblNgridPluginController }]; }, propDecorators: { loadOptions: [{
                type: Input
            }], saveOptions: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtcGx1Z2luLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3JpZC9zdGF0ZS9zcmMvbGliL3N0YXRlLXBsdWdpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlFLE9BQU8sRUFBRSxTQUFTLEVBQWEsUUFBUSxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV0RSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSx3QkFBd0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1RSxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQXNELE1BQU0sY0FBYyxDQUFDO0FBRWxILE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxXQUFXLENBQUM7OztBQWlDNUMsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFZLE9BQU8sQ0FBQztBQUUzQyxNQUFNLE9BQU8sbUJBQW1CO0lBWTlCLFlBQW1CLElBQTRCLEVBQVksUUFBa0IsRUFBWSxVQUFvQztRQUExRyxTQUFJLEdBQUosSUFBSSxDQUF3QjtRQUFZLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBWSxlQUFVLEdBQVYsVUFBVSxDQUEwQjtRQUZySCxZQUFPLEdBQUcsSUFBSSxPQUFPLEVBQTZCLENBQUM7UUFHekQsSUFBSSxDQUFDLGFBQWEsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUU1RCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxPQUFP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QUNULFFBQVEsRUFBRSx5QkFBeUI7b0JBQ25DLE9BQU8sRUFBRSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLFNBQVMsQ0FBQztpQkFDekQ7c0tBR1UsV0FBVztzQkFBbkIsS0FBSztnQkFDRyxXQUFXO3NCQUFuQixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBtYXBUbywgZmlsdGVyLCB0YWtlLCBza2lwLCBkZWJvdW5jZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBEaXJlY3RpdmUsIE9uRGVzdHJveSwgSW5qZWN0b3IsIElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IE9OX0lOVkFMSURBVEVfSEVBREVSUywgT05fUkVTSVpFX1JPVywgT05fREVTVFJPWSB9IGZyb20gJ0BwZWJ1bGEvbmdyaWQvY29yZSc7XG5pbXBvcnQgeyBQYmxOZ3JpZENvbXBvbmVudCwgUGJsTmdyaWRQbHVnaW5Db250cm9sbGVyIH0gZnJvbSAnQHBlYnVsYS9uZ3JpZCc7XG5pbXBvcnQgeyBoYXNTdGF0ZSwgc2F2ZVN0YXRlLCBsb2FkU3RhdGUsIFBibE5ncmlkU3RhdGVMb2FkT3B0aW9ucywgUGJsTmdyaWRTdGF0ZVNhdmVPcHRpb25zIH0gZnJvbSAnLi9jb3JlL2luZGV4JztcblxuaW1wb3J0IHsgdXNlclNlc3Npb25QcmVmIH0gZnJvbSAnLi9wcmVzZXRzJztcblxuZGVjbGFyZSBtb2R1bGUgJ0BwZWJ1bGEvbmdyaWQvY29yZS9saWIvY29uZmlndXJhdGlvbi90eXBlJyB7XG4gIGludGVyZmFjZSBQYmxOZ3JpZENvbmZpZyB7XG4gICAgc3RhdGU/OiB7XG4gICAgICAvKiogV2hlbiBzZXQgdG8gdHJ1ZSB3aWxsIGVuYWJsZSB0aGUgc3RhdGUgcGx1Z2luIG9uIGFsbCB0YWJsZSBpbnN0YW5jZXMgYnkgZGVmYXVsdC4gKi9cbiAgICAgIGF1dG9FbmFibGU/OiBib29sZWFuO1xuICAgICAgLyoqXG4gICAgICAgKiBPcHRpb25zIHRvIHVzZSB3aGVuIGF1dG8tbG9hZGluZyB0aGUgcGx1Z2luXG4gICAgICAgKi9cbiAgICAgIGF1dG9FbmFibGVPcHRpb25zPzoge1xuICAgICAgICBsb2FkT3B0aW9ucz86IFBibE5ncmlkU3RhdGVMb2FkT3B0aW9ucztcbiAgICAgICAgc2F2ZU9wdGlvbnM/OiBQYmxOZ3JpZFN0YXRlU2F2ZU9wdGlvbnM7XG4gICAgICB9XG4gICAgfTtcbiAgfVxufVxuXG5kZWNsYXJlIG1vZHVsZSAnQHBlYnVsYS9uZ3JpZC9saWIvZXh0L3R5cGVzJyB7XG4gIGludGVyZmFjZSBQYmxOZ3JpZFBsdWdpbkV4dGVuc2lvbiB7XG4gICAgc3RhdGU/OiBQYmxOZ3JpZFN0YXRlUGx1Z2luO1xuICB9XG4gIGludGVyZmFjZSBQYmxOZ3JpZFBsdWdpbkV4dGVuc2lvbkZhY3RvcmllcyB7XG4gICAgc3RhdGU6IGtleW9mIHR5cGVvZiBQYmxOZ3JpZFN0YXRlUGx1Z2luO1xuICB9XG59XG5cbmludGVyZmFjZSBJbnRlcm5hbFN0YXRlUGx1Z2luRXZlbnRzIHtcbiAgcGhhc2U6ICdsb2FkJyB8ICdzYXZlJztcbiAgcG9zaXRpb246ICdiZWZvcmUnIHwgJ2FmdGVyJztcbiAgZXJyb3I/OiBFcnJvcjtcbn1cblxuZXhwb3J0IGNvbnN0IFBMVUdJTl9LRVk6ICdzdGF0ZScgPSAnc3RhdGUnO1xuXG5leHBvcnQgY2xhc3MgUGJsTmdyaWRTdGF0ZVBsdWdpbiB7XG5cbiAgbG9hZE9wdGlvbnM/OiBQYmxOZ3JpZFN0YXRlTG9hZE9wdGlvbnM7XG4gIHNhdmVPcHRpb25zPzogUGJsTmdyaWRTdGF0ZVNhdmVPcHRpb25zO1xuXG4gIGFmdGVyTG9hZFN0YXRlOiBPYnNlcnZhYmxlPHZvaWQ+O1xuICBhZnRlclNhdmVTdGF0ZTogT2JzZXJ2YWJsZTx2b2lkPjtcbiAgb25FcnJvcjogT2JzZXJ2YWJsZTx7IHBoYXNlOiAnc2F2ZScgfCAnbG9hZCc7IGVycm9yOiBFcnJvcjsgfT47XG5cbiAgcHJpdmF0ZSBfcmVtb3ZlUGx1Z2luOiAodGFibGU6IFBibE5ncmlkQ29tcG9uZW50PGFueT4pID0+IHZvaWQ7XG4gIHByaXZhdGUgX2V2ZW50cyA9IG5ldyBTdWJqZWN0PEludGVybmFsU3RhdGVQbHVnaW5FdmVudHM+KCk7XG5cbiAgY29uc3RydWN0b3IocHVibGljIGdyaWQ6IFBibE5ncmlkQ29tcG9uZW50PGFueT4sIHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IsIHByb3RlY3RlZCBwbHVnaW5DdHJsOiBQYmxOZ3JpZFBsdWdpbkNvbnRyb2xsZXIpIHtcbiAgICB0aGlzLl9yZW1vdmVQbHVnaW4gPSBwbHVnaW5DdHJsLnNldFBsdWdpbihQTFVHSU5fS0VZLCB0aGlzKTtcblxuICAgIHRoaXMuYWZ0ZXJMb2FkU3RhdGUgPSB0aGlzLl9ldmVudHMucGlwZShmaWx0ZXIoIGUgPT4gZS5waGFzZSA9PT0gJ2xvYWQnICYmIGUucG9zaXRpb24gPT09ICdhZnRlcicpLCBtYXBUbyh1bmRlZmluZWQpICk7XG4gICAgdGhpcy5hZnRlclNhdmVTdGF0ZSA9IHRoaXMuX2V2ZW50cy5waXBlKGZpbHRlciggZSA9PiBlLnBoYXNlID09PSAnc2F2ZScgJiYgZS5wb3NpdGlvbiA9PT0gJ2FmdGVyJyksIG1hcFRvKHVuZGVmaW5lZCkgKTtcbiAgICB0aGlzLm9uRXJyb3IgPSB0aGlzLl9ldmVudHMucGlwZShmaWx0ZXIoIGUgPT4gISFlLmVycm9yICksIG1hcCggZSA9PiAoeyBwaGFzZTogZS5waGFzZSwgZXJyb3I6IGUuZXJyb3IgfSkpICk7XG5cbiAgICBwbHVnaW5DdHJsLmV2ZW50c1xuICAgICAgLnBpcGUoT05fSU5WQUxJREFURV9IRUFERVJTLCB0YWtlKDEpKVxuICAgICAgLnN1YnNjcmliZSggZXZlbnQgPT4ge1xuICAgICAgICBjb25zdCBpbml0aWFsTG9hZE9wdGlvbnMgPSB7IC4uLih0aGlzLmxvYWRPcHRpb25zIHx8IHt9KSwgYXZvaWRSZWRyYXc6IHRydWUgfTtcbiAgICAgICAgaGFzU3RhdGUoZ3JpZCwgaW5pdGlhbExvYWRPcHRpb25zKVxuICAgICAgICAgIC50aGVuKCB2YWx1ZSA9PiB7XG4gICAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xvYWQoaW5pdGlhbExvYWRPcHRpb25zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC50aGVuKCAoKSA9PiB7XG4gICAgICAgICAgICBwbHVnaW5DdHJsLmV2ZW50c1xuICAgICAgICAgICAgICAucGlwZShPTl9SRVNJWkVfUk9XLCBza2lwKDEpLCBkZWJvdW5jZVRpbWUoNTAwKSlcbiAgICAgICAgICAgICAgLnN1YnNjcmliZSggZXZlbnQgPT4gdGhpcy5zYXZlKCkgKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgcGx1Z2luQ3RybC5ldmVudHNcbiAgICAgIC5waXBlKE9OX0RFU1RST1kpXG4gICAgICAuc3Vic2NyaWJlKCBldmVudCA9PiB7XG4gICAgICAgIGV2ZW50LndhaXQodGhpcy5zYXZlKCkpO1xuICAgICAgICB0aGlzLl9ldmVudHMuY29tcGxldGUoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIGNyZWF0ZSh0YWJsZTogUGJsTmdyaWRDb21wb25lbnQ8YW55PiwgaW5qZWN0b3I6IEluamVjdG9yKTogUGJsTmdyaWRTdGF0ZVBsdWdpbiB7XG4gICAgY29uc3QgcGx1Z2luQ3RybCA9IFBibE5ncmlkUGx1Z2luQ29udHJvbGxlci5maW5kKHRhYmxlKTtcbiAgICByZXR1cm4gbmV3IFBibE5ncmlkU3RhdGVQbHVnaW4odGFibGUsIGluamVjdG9yLCBwbHVnaW5DdHJsKTtcbiAgfVxuXG4gIGxvYWQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuX2xvYWQodGhpcy5sb2FkT3B0aW9ucyk7XG4gIH1cblxuICBzYXZlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBzYXZlU3RhdGUodGhpcy5ncmlkLCB0aGlzLnNhdmVPcHRpb25zKVxuICAgICAgLnRoZW4oICgpID0+IHRoaXMuX2V2ZW50cy5uZXh0KHtwaGFzZTogJ3NhdmUnLCBwb3NpdGlvbjogJ2FmdGVyJ30pIClcbiAgICAgIC5jYXRjaCggZXJyb3IgPT4gdGhpcy5fZXZlbnRzLm5leHQoe3BoYXNlOiAnc2F2ZScsIHBvc2l0aW9uOiAnYWZ0ZXInLCBlcnJvciB9KSApO1xuICB9XG5cbiAgZGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLl9yZW1vdmVQbHVnaW4odGhpcy5ncmlkKTtcbiAgfVxuXG4gIHByaXZhdGUgX2xvYWQobG9hZE9wdGlvbnM6IFBibE5ncmlkU3RhdGVMb2FkT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBsb2FkU3RhdGUodGhpcy5ncmlkLCBsb2FkT3B0aW9ucylcbiAgICAgIC50aGVuKCAoKSA9PiB0aGlzLl9ldmVudHMubmV4dCh7cGhhc2U6ICdsb2FkJywgcG9zaXRpb246ICdhZnRlcid9KSApXG4gICAgICAuY2F0Y2goIGVycm9yID0+IHRoaXMuX2V2ZW50cy5uZXh0KHtwaGFzZTogJ2xvYWQnLCBwb3NpdGlvbjogJ2FmdGVyJywgZXJyb3IgfSkgKTtcbiAgfVxuXG59XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ3BibC1uZ3JpZFtwZXJzaXN0U3RhdGVdJywgLy8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3JcbiAgb3V0cHV0czogWydhZnRlckxvYWRTdGF0ZScsICdhZnRlclNhdmVTdGF0ZScsICdvbkVycm9yJ10sXG59KVxuZXhwb3J0IGNsYXNzIFBibE5ncmlkU3RhdGVQbHVnaW5EaXJlY3RpdmUgZXh0ZW5kcyBQYmxOZ3JpZFN0YXRlUGx1Z2luIGltcGxlbWVudHMgT25EZXN0cm95IHtcblxuICBASW5wdXQoKSBsb2FkT3B0aW9uczogUGJsTmdyaWRTdGF0ZUxvYWRPcHRpb25zID0geyBpbmNsdWRlOiB1c2VyU2Vzc2lvblByZWYoKSB9O1xuICBASW5wdXQoKSBzYXZlT3B0aW9uczogUGJsTmdyaWRTdGF0ZVNhdmVPcHRpb25zID0geyBpbmNsdWRlOiB1c2VyU2Vzc2lvblByZWYoKSB9O1xuXG4gIGNvbnN0cnVjdG9yKGdyaWQ6IFBibE5ncmlkQ29tcG9uZW50PGFueT4sIGluamVjdG9yOiBJbmplY3RvciwgcGx1Z2luQ3RybDogUGJsTmdyaWRQbHVnaW5Db250cm9sbGVyKSB7XG4gICAgc3VwZXIoZ3JpZCwgaW5qZWN0b3IsIHBsdWdpbkN0cmwpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95KCk7XG4gIH1cblxufVxuIl19