!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@pebula/ngrid"),require("rxjs"),require("rxjs/operators"),require("@angular/core"),require("@pebula/utils"),require("@angular/common")):"function"==typeof define&&define.amd?define("@pebula/ngrid/state",["exports","@pebula/ngrid","rxjs","rxjs/operators","@angular/core","@pebula/utils","@angular/common"],r):r(((e=e||self).pebula=e.pebula||{},e.pebula.ngrid=e.pebula.ngrid||{},e.pebula.ngrid.state={}),e.pebula.ngrid,e.rxjs,e.rxjs.operators,e.ng.core,e.pebula.utils,e.ng.common)}(this,function(e,r,t,n,o,i,a){"use strict";var u=function(e,r){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};var l=function(){return(l=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)};function s(e,r,t,n){var o,i=arguments.length,a=i<3?r:null===n?n=Object.getOwnPropertyDescriptor(r,t):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,r,t,n);else for(var u=e.length-1;u>=0;u--)(o=e[u])&&(a=(i<3?o(a):i>3?o(r,t,a):o(r,t))||a);return i>3&&a&&Object.defineProperty(r,t,a),a}function c(e,r){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,r)}function f(e){var r="function"==typeof Symbol&&e[Symbol.iterator],t=0;return r?r.call(e):{next:function(){return e&&t>=e.length&&(e=void 0),{value:e&&e[t++],done:!e}}}}function d(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,o,i=t.call(e),a=[];try{for(;(void 0===r||r-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return a}function p(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(d(arguments[r]));return e}var h=function(){function r(){this.rootChunkSections=new Map,this.chunkHandlers=new Map}return r.get=function(){return e.ɵa||(e.ɵa=new r)},r.prototype.registerRootChunkSection=function(e,r){this.rootChunkSections.has(e)||this.rootChunkSections.set(e,r)},r.prototype.registerChunkHandlerDefinition=function(e){var r=e.chunkId,t=this.chunkHandlers.get(r)||[];t.push(e),this.chunkHandlers.set(r,t)},r.prototype.getRootSections=function(){return Array.from(this.rootChunkSections.entries())},r.prototype.getDefinitionsForSection=function(e){return this.chunkHandlers.get(e)||[]},r}();var v=h.get(),y=function(){function e(){}return e.prototype.save=function(e,r){try{var t=this.loadGlobalStateStore();return t[e]=r,r.__metadata__||(r.__metadata__={}),r.__metadata__.updatedAt=(new Date).toISOString(),this.saveGlobalStateStore(t),Promise.resolve()}catch(e){return Promise.reject(e)}},e.prototype.load=function(e){return Promise.resolve(this.loadGlobalStateStore()[e]||{})},e.prototype.exists=function(e){var r=this.loadGlobalStateStore()||{};return Promise.resolve(e in r)},e.prototype.loadGlobalStateStore=function(){var r=localStorage.getItem(e.globalStateKey);return r?JSON.parse(r):{}},e.prototype.saveGlobalStateStore=function(r){localStorage.setItem(e.globalStateKey,JSON.stringify(r))},e.globalStateKey="pebulaNgridState",e}();var m=function(){function e(e){this.chunkId=e,this.keys=new Set,this.rKeys=new Set}return e.prototype.handleKeys=function(){for(var e,r,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{for(var o=f(t),i=o.next();!i.done;i=o.next()){var a=i.value;this.keys.add(a)}}catch(r){e={error:r}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}return this},e.prototype.requiredKeys=function(){for(var e,r,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{for(var o=f(t),i=o.next();!i.done;i=o.next()){var a=i.value;this.keys.add(a),this.rKeys.add(a)}}catch(r){e={error:r}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}return this},e.prototype.serialize=function(e){return this.sFn=e,this},e.prototype.deserialize=function(e){return this.dFn=e,this},e.prototype.register=function(){if(0===this.keys.size)throw new Error("Invalid state chunk handler, no keys defined.");if(!this.sFn)throw new Error("Invalid state chunk handler, missing serialize handler.");if(!this.dFn)throw new Error("Invalid state chunk handler, missing deserialize handler.");v.registerChunkHandlerDefinition({chunkId:this.chunkId,keys:Array.from(this.keys.values()),rKeys:Array.from(this.rKeys.values()),serialize:this.sFn,deserialize:this.dFn})},e}();function g(e){return new m(e)}var b=function(){function e(){}return e.prototype.resolveId=function(e){return e.grid.id},e}();function w(e,r){var t=r.identResolver.resolveId(P(e,r));if(!t)throw new Error("Could not resolve a unique id for an ngrid instance, state is disabled");return t}function x(e,r,t){var n,o,i=I(e.chunkId,t.options);try{for(var a=f(e.keys),u=a.next();!u.done;u=a.next()){var l=u.value;(!i||e.rKeys.indexOf(l)>-1||i(l))&&(r[l]=e.serialize(l,t))}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}}function C(e,r,t){var n,o,i=I(e.chunkId,t.options);try{for(var a=f(e.keys),u=a.next();!u.done;u=a.next()){var l=u.value;l in r&&(!i||e.rKeys.indexOf(l)>-1||i(l))&&e.deserialize(l,r[l],t)}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}}function S(e,r){if(r||(r={}),r.persistenceAdapter||(r.persistenceAdapter=new y),r.identResolver||(r.identResolver=new b),"load"===e){var t=r;t.strategy||(t.strategy="overwrite")}return r}function k(e){var t=r.PblNgridPluginController.find(e);if(t)return t.extApi}function P(e,r){return{grid:e,extApi:k(e),options:r}}function O(e,r,t){return l({},e,{source:r.sourceMatcher(e),runChildChunk:function(r,n,o,i){var a,u,s=l({},e,{source:o,data:i}),c=v.getDefinitionsForSection(r),d="serialize"===t?x:C;try{for(var p=f(c),h=p.next();!h.done;h=p.next()){d(h.value,n,s)}}catch(e){a={error:e}}finally{try{h&&!h.done&&(u=p.return)&&u.call(p)}finally{if(a)throw a.error}}}})}function I(e,r,t){void 0===t&&(t=!1);var n=r.include||r.exclude;if(n){var o=n===r.include?1:-1,i=n[e];if("boolean"==typeof i)return 1===o?function(e){return i}:function(e){return!i};if(Array.isArray(i))return t?function(e){return!0}:1===o?function(e){return i.indexOf(e)>-1}:function(e){return-1===i.indexOf(e)};if(1===o)return function(e){return!1}}}function _(e,r){return Promise.resolve().then(function(){r=S("save",r);var t=w(e,r);return r.persistenceAdapter.exists(t)})}function A(e,r){return Promise.resolve().then(function(){var t,n,o,i;r=S("save",r);var a=w(e,r),u={},l=P(e,r);try{for(var s=f(v.getRootSections()),c=s.next();!c.done;c=s.next()){var p=d(c.value,2),h=p[0],y=p[1],m=I(h,r,!0);if(!m||m(h)){var g=y.stateMatcher(u),b=O(l,y,"serialize"),C=v.getDefinitionsForSection(h);try{for(var k=f(C),_=k.next();!_.done;_=k.next()){x(_.value,g,b)}}catch(e){o={error:e}}finally{try{_&&!_.done&&(i=k.return)&&i.call(k)}finally{if(o)throw o.error}}}}}catch(e){t={error:e}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}return r.persistenceAdapter.save(a,u)})}function z(e,r){return Promise.resolve().then(function(){r=S("load",r);var t=w(e,r);return r.persistenceAdapter.load(t).then(function(t){var n,o,i,a,u=P(e,r);try{for(var l=f(v.getRootSections()),s=l.next();!s.done;s=l.next()){var c=d(s.value,2),p=c[0],h=c[1],y=I(p,r,!0);if(!y||y(p)){var m=h.stateMatcher(t),g=O(u,h,"deserialize"),b=v.getDefinitionsForSection(p);try{for(var w=f(b),x=w.next();!x.done;x=w.next()){C(x.value,m,g)}}catch(e){i={error:e}}finally{try{x&&!x.done&&(a=w.return)&&a.call(w)}finally{if(i)throw i.error}}}}}catch(e){n={error:e}}finally{try{s&&!s.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}return t})})}function R(){v.registerRootChunkSection("grid",{sourceMatcher:function(e){return e.grid},stateMatcher:function(e){return e.grid||(e.grid={})}}),g("grid").handleKeys("showHeader","showFooter","focusMode","usePagination","hideColumns","fallbackMinHeight").serialize(function(e,r){return r.source[e]}).deserialize(function(e,r,t){t.source[e]=r}).register()}function j(e,r,t){var n,o,i=[];try{for(var a=f(t),u=a.next();!u.done;u=a.next()){var l=u.value,s={};r.runChildChunk(e,s,l),i.push(s)}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}return i}function K(e,r,t){var n,o,i=t.extApi.columnStore,a=t.source.table;try{for(var u=f(["header","footer"]),l=u.next();!l.done;l=u.next()){var s=l.value,c="s"===e?a:r,d=c===a?r:a;if(c[s]){var p="header"===s?i.headerColumnDef:i.footerColumnDef;d[s]||(d[s]={}),t.runChildChunk("dataMetaRow",r[s],a[s],{kind:s,active:p})}}}catch(e){n={error:e}}finally{try{l&&!l.done&&(o=u.return)&&o.call(u)}finally{if(n)throw n.error}}}function N(e,t,n){var o,i,a=n.source.table,u="s"===e?a:t,l=u===t?function(e){return{colState:e,pblColumn:a.cols.find(function(t){return r.utils.isPblColumn(t)&&t.orgProp===e.prop||t.id===e.id||t.prop===e.prop})}}:function(e){return{colState:t.cols[t.cols.push({})-1],pblColumn:r.utils.isPblColumn(e)&&e}};if(u.cols&&u.cols.length>0)try{for(var s=f(u.cols),c=s.next();!c.done;c=s.next()){var d=c.value,p=l(d),h=p.colState,v=p.pblColumn,y={pblColumn:r.utils.isPblColumn(v)&&v,activeColumn:n.grid.columnApi.findColumn(d.id||d.prop)};n.runChildChunk("dataColumn",h,v,y)}}catch(e){o={error:e}}finally{try{c&&!c.done&&(i=s.return)&&i.call(s)}finally{if(o)throw o.error}}}function M(){v.registerRootChunkSection("columns",{sourceMatcher:function(e){return e.grid.columns},stateMatcher:function(e){return e.columns||(e.columns={table:{cols:[]},header:[],footer:[],headerGroup:[]})}}),g("columns").handleKeys("table","header","headerGroup","footer").serialize(function(e,r){var t,n,o,i;switch(e){case"table":var a={cols:[]};return K("s",a,r),N("s",a,r),a;case"header":case"footer":var u=r.source[e];if(u&&u.length>0){var l=[],s=function(t){r.extApi.columnStore.metaColumnIds[e].find(function(e){return!e.isGroup&&e.rowDef.rowIndex===t.rowIndex});var n={};r.runChildChunk("metaRow",n,t),n.cols=j("metaColumn",r,t.cols),l.push(n)};try{for(var c=f(u),d=c.next();!d.done;d=c.next()){s(d.value)}}catch(e){t={error:e}}finally{try{d&&!d.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}return l}break;case"headerGroup":var p=r.source.headerGroup;if(p&&p.length>0){l=[];var h=function(e){r.extApi.columnStore.metaColumnIds.header.find(function(r){return!r.isGroup&&r.rowDef.rowIndex===e.rowIndex});var t={};r.runChildChunk("metaGroupRow",t,e),t.cols=j("metaColumn",r,e.cols),l.push(t)};try{for(var v=f(p),y=v.next();!y.done;y=v.next()){h(y.value)}}catch(e){o={error:e}}finally{try{y&&!y.done&&(i=v.return)&&i.call(v)}finally{if(o)throw o.error}}return l}}}).deserialize(function(e,r,t){var n,o;switch(e){case"table":var i=r;K("d",i,t),N("d",i,t);break;case"header":case"footer":var a=t.source[e],u=r;if(u&&u.length>0){var l=function(r){var n,o,i=a.find(function(e){return e.rowIndex===r.rowIndex});if(i){t.extApi.columnStore.metaColumnIds[e].find(function(e){return!e.isGroup&&e.rowDef.rowIndex===r.rowIndex});t.runChildChunk("metaRow",r,i);var u=function(e){var r=i.cols.find(function(r){return r.id===e.id});if(r){var n=t.extApi.columnStore.find(e.id);n&&n.header;t.runChildChunk("metaColumn",e,r)}};try{for(var l=f(r.cols),s=l.next();!s.done;s=l.next()){u(s.value)}}catch(e){n={error:e}}finally{try{s&&!s.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}}};try{for(var s=f(u),c=s.next();!c.done;c=s.next()){l(c.value)}}catch(e){n={error:e}}finally{try{c&&!c.done&&(o=s.return)&&o.call(s)}finally{if(n)throw n.error}}}}}).register(),g("dataColumn").requiredKeys("id","prop").handleKeys("label","css","type","width","minWidth","maxWidth","headerType","footerType","sort","sortAlias","editable","pin").serialize(function(e,r){var t=r.data.activeColumn||r.data.pblColumn;if(t)switch(e){case"prop":return t.orgProp}var n=t?t[e]:r.source[e];switch(e){case"sort":return"boolean"==typeof n?n:void 0}return n}).deserialize(function(e,r,t){var n=t.data.activeColumn;if(n)switch(e){case"width":n.updateWidth(!0,r)}if(t.source){switch(e){case"prop":return;case"type":case"headerType":case"footerType":var o=t.source[e],i=r;if(i&&"string"!=typeof i&&o&&"string"!=typeof o)return o.name=i.name,void(i.data&&(o.data=Object.assign(o.data||{},i.data)))}t.source[e]=r}}).register(),g("dataMetaRow").handleKeys("rowClassName","type").serialize(function(e,r){var t=r.data.active||r.source;if(t)return t[e]}).deserialize(function(e,r,t){t.source[e]=r}).register(),g("metaRow").handleKeys("rowClassName","type","rowIndex").serialize(function(e,r){return r.source[e]}).deserialize(function(e,r,t){}).register(),g("metaGroupRow").handleKeys("rowClassName","type","rowIndex").serialize(function(e,r){return r.source[e]}).deserialize(function(e,r,t){}).register(),g("metaColumn").requiredKeys("kind","rowIndex").handleKeys("id","label","css","type","width","minWidth","maxWidth").serialize(function(e,r){return r.source[e]}).deserialize(function(e,r,t){}).register(),g("metaGroupColumn").requiredKeys("prop","rowIndex","span").handleKeys("id","label","css","type","width","minWidth","maxWidth").serialize(function(e,r){return r.source[e]}).deserialize(function(e,r,t){}).register()}function D(){v.registerRootChunkSection("columnOrder",{sourceMatcher:function(e){return e.grid.columnApi},stateMatcher:function(e){return e.columnOrder||(e.columnOrder=[]),e}}),g("columnOrder").handleKeys("columnOrder").serialize(function(e,r){return r.source.visibleColumnIds.slice()}).deserialize(function(e,r,t){var n,o=t.extApi,i=t.grid,a=i.columnApi.visibleColumnIds;if(r&&r.length===a.length)for(var u=0,l=r.length;u<l;u++)if(r[u]!==a[u]){var s=i.columnApi.findColumn(r[u]);if(!s)return;var c=i.columnApi.findColumn(a[u]);n=[s,c],i.columnApi.moveColumn(s,c,!0),o.columnStore.updateGroups()}n&&(i.columnApi.moveColumn(n[1],n[0],!0),i.columnApi.moveColumn(n[0],n[1],t.options.avoidRedraw))}).register()}function G(){for(var e,r,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var o={grid:["hideColumns","showFooter","showHeader"],columnOrder:!0,columns:["table"],dataColumn:["width"]};if(t.length>0)try{for(var i=f(t),a=i.next();!a.done;a=i.next()){H(o,a.value)}}catch(r){e={error:r}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return o}function H(e,r){var t,n;try{for(var o=f(Object.keys(r)),i=o.next();!i.done;i=o.next()){var a=i.value,u=r[a];if(a in e){var l=e[a];if(Array.isArray(l)&&Array.isArray(u)){var s=new Set(p(l,u));e[a]=Array.from(s.values())}}else e[a]=r[a]}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}}function F(){R(),D(),M()}var q="state",E=function(){function e(e,r,o){var i=this;this.grid=e,this.injector=r,this.pluginCtrl=o,this._events=new t.Subject,this._removePlugin=o.setPlugin(q,this),this.afterLoadState=this._events.pipe(n.filter(function(e){return"load"===e.phase&&"after"===e.position}),n.mapTo(void 0)),this.afterSaveState=this._events.pipe(n.filter(function(e){return"save"===e.phase&&"after"===e.position}),n.mapTo(void 0)),this.onError=this._events.pipe(n.filter(function(e){return!!e.error}),n.map(function(e){return{phase:e.phase,error:e.error}})),o.events.pipe(n.filter(function(e){return"onInvalidateHeaders"===e.kind}),n.take(1)).subscribe(function(r){var t=l({},i.loadOptions||{},{avoidRedraw:!0});_(e,t).then(function(e){if(e)return i._load(t)}).then(function(){o.events.pipe(n.filter(function(e){return"onResizeRow"===e.kind}),n.skip(1),n.debounceTime(500)).subscribe(function(e){return i.save()})})}),o.events.subscribe(function(e){"onDestroy"===e.kind&&(e.wait(i.save()),i._events.complete())})}var a;return a=e,e.create=function(e,t){var n=r.PblNgridPluginController.find(e);return new a(e,t,n)},e.prototype.load=function(){return this._load(this.loadOptions)},e.prototype.save=function(){var e=this;return A(this.grid,this.saveOptions).then(function(){return e._events.next({phase:"save",position:"after"})}).catch(function(r){return e._events.next({phase:"save",position:"after",error:r})})},e.prototype.destroy=function(){this._removePlugin(this.grid)},e.prototype._load=function(e){var r=this;return z(this.grid,e).then(function(){return r._events.next({phase:"load",position:"after"})}).catch(function(e){return r._events.next({phase:"load",position:"after",error:e})})},e=a=s([r.TablePlugin({id:q,factory:"create",runOnce:F}),i.UnRx(),c("design:paramtypes",[r.PblNgridComponent,o.Injector,r.PblNgridPluginController])],e)}();var T=function(e){function t(r,t,n){var o=e.call(this,r,t,n)||this;return o.loadOptions={include:G()},o.saveOptions={include:G()},o}return function(e,r){function t(){this.constructor=e}u(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}(t,e),t.prototype.ngOnDestroy=function(){this.destroy()},t.decorators=[{type:o.Directive,args:[{selector:"pbl-ngrid[persistState]",outputs:["afterLoadState","afterSaveState","onError"]}]}],t.ctorParameters=function(){return[{type:r.PblNgridComponent},{type:o.Injector},{type:r.PblNgridPluginController}]},t.propDecorators={loadOptions:[{type:o.Input}],saveOptions:[{type:o.Input}]},t=s([i.UnRx(),c("design:paramtypes",[r.PblNgridComponent,o.Injector,r.PblNgridPluginController])],t)}(E);var W=function(){function e(e,t){e||r.PblNgridPluginController.created.subscribe(function(e){var r=t.get(q);if(r&&!0===r.autoEnable)var n=e.controller,o=n.events.subscribe(function(e){if("onInit"===e.kind){if(!n.hasPlugin(q)){var t=n.createPlugin(q);r.autoEnableOptions&&(t.loadOptions=r.autoEnableOptions.loadOptions,t.saveOptions=r.autoEnableOptions.saveOptions)}o.unsubscribe(),o=void 0}})})}return e.decorators=[{type:o.NgModule,args:[{imports:[a.CommonModule,r.PblNgridModule],declarations:[T],exports:[T],providers:[],entryComponents:[]}]}],e.ctorParameters=function(){return[{type:e,decorators:[{type:o.Optional},{type:o.SkipSelf}]},{type:r.PblNgridConfigService}]},e}();e.PblNgridLocalStoragePersistAdapter=y,e.PblNgridStatePlugin=E,e.PblNgridStatePluginModule=W,e.StateVisor=h,e.createStateChunkHandler=g,e.hasState=_,e.loadState=z,e.registerColumnDefHandlers=M,e.registerColumnOrderHandlers=D,e.registerGridHandlers=R,e.saveState=A,e.stateVisor=v,e.userSessionPref=G,e.ɵb=m,e.ɵc=q,e.ɵd=T,e.ɵe=F,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=pebula-ngrid-state.umd.min.js.map