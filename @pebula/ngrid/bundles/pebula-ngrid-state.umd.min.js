!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@pebula/ngrid"),require("rxjs"),require("rxjs/operators"),require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("@pebula/ngrid/state",["exports","@pebula/ngrid","rxjs","rxjs/operators","@angular/core","@angular/common"],r):r(((e=e||self).pebula=e.pebula||{},e.pebula.ngrid=e.pebula.ngrid||{},e.pebula.ngrid.state={}),e.pebula.ngrid,e.rxjs,e.rxjs.operators,e.ng.core,e.ng.common)}(this,(function(e,r,t,n,o,i){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var a=function(e,r){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};var u=function(){return(u=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e}).apply(this,arguments)};function s(e){var r="function"==typeof Symbol&&Symbol.iterator,t=r&&e[r],n=0;if(t)return t.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}function l(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,o,i=t.call(e),a=[];try{for(;(void 0===r||r-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return a}function c(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(l(arguments[r]));return e}var d=function(){function r(){this.rootChunkSections=new Map,this.chunkHandlers=new Map}return r.get=function(){return e.ɵa||(e.ɵa=new r)},r.prototype.registerRootChunkSection=function(e,r){this.rootChunkSections.has(e)||this.rootChunkSections.set(e,r)},r.prototype.registerChunkHandlerDefinition=function(e){var r=e.chunkId,t=this.chunkHandlers.get(r)||[];t.push(e),this.chunkHandlers.set(r,t)},r.prototype.getRootSections=function(){return Array.from(this.rootChunkSections.entries())},r.prototype.getDefinitionsForSection=function(e){return this.chunkHandlers.get(e)||[]},r}();var f=d.get(),h=function(){function e(){}return e.prototype.save=function(e,r){try{var t=this.loadGlobalStateStore();return t[e]=r,r.__metadata__||(r.__metadata__={}),r.__metadata__.updatedAt=(new Date).toISOString(),this.saveGlobalStateStore(t),Promise.resolve()}catch(e){return Promise.reject(e)}},e.prototype.load=function(e){return Promise.resolve(this.loadGlobalStateStore()[e]||{})},e.prototype.exists=function(e){var r=this.loadGlobalStateStore()||{};return Promise.resolve(e in r)},e.prototype.loadGlobalStateStore=function(){var r=localStorage.getItem(e.globalStateKey);return r?JSON.parse(r):{}},e.prototype.saveGlobalStateStore=function(r){localStorage.setItem(e.globalStateKey,JSON.stringify(r))},e.globalStateKey="pebulaNgridState",e}();var p=function(){function e(e){this.chunkId=e,this.keys=new Set,this.rKeys=new Set}return e.prototype.handleKeys=function(){for(var e,r,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{for(var o=s(t),i=o.next();!i.done;i=o.next()){var a=i.value;this.keys.add(a)}}catch(r){e={error:r}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}return this},e.prototype.requiredKeys=function(){for(var e,r,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];try{for(var o=s(t),i=o.next();!i.done;i=o.next()){var a=i.value;this.keys.add(a),this.rKeys.add(a)}}catch(r){e={error:r}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}return this},e.prototype.serialize=function(e){return this.sFn=e,this},e.prototype.deserialize=function(e){return this.dFn=e,this},e.prototype.register=function(){if(0===this.keys.size)throw new Error("Invalid state chunk handler, no keys defined.");if(!this.sFn)throw new Error("Invalid state chunk handler, missing serialize handler.");if(!this.dFn)throw new Error("Invalid state chunk handler, missing deserialize handler.");f.registerChunkHandlerDefinition({chunkId:this.chunkId,keys:Array.from(this.keys.values()),rKeys:Array.from(this.rKeys.values()),serialize:this.sFn,deserialize:this.dFn})},e}();function v(e){return new p(e)}var y=function(){function e(){}return e.prototype.resolveId=function(e){return e.grid.id},e}();function m(e,r){var t=r.identResolver.resolveId(C(e,r));if(!t)throw new Error("Could not resolve a unique id for an ngrid instance, state is disabled");return t}function g(e,r,t){var n,o,i=k(e.chunkId,t.options);try{for(var a=s(e.keys),u=a.next();!u.done;u=a.next()){var l=u.value;(!i||e.rKeys.indexOf(l)>-1||i(l))&&(r[l]=e.serialize(l,t))}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}}function b(e,r,t){var n,o,i=k(e.chunkId,t.options);try{for(var a=s(e.keys),u=a.next();!u.done;u=a.next()){var l=u.value;l in r&&(!i||e.rKeys.indexOf(l)>-1||i(l))&&e.deserialize(l,r[l],t)}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}}function w(e,r){if(r||(r={}),r.persistenceAdapter||(r.persistenceAdapter=new h),r.identResolver||(r.identResolver=new y),"load"===e){var t=r;t.strategy||(t.strategy="overwrite")}return r}function x(e){var t=r.PblNgridPluginController.find(e);if(t)return t.extApi}function C(e,r){return{grid:e,extApi:x(e),options:r}}function S(e,r,t){return u(u({},e),{source:r.sourceMatcher(e),runChildChunk:function(r,n,o,i){var a,l,c=u(u({},e),{source:o,data:i}),d=f.getDefinitionsForSection(r),h="serialize"===t?g:b;try{for(var p=s(d),v=p.next();!v.done;v=p.next()){h(v.value,n,c)}}catch(e){a={error:e}}finally{try{v&&!v.done&&(l=p.return)&&l.call(p)}finally{if(a)throw a.error}}}})}function k(e,r,t){void 0===t&&(t=!1);var n=r.include||r.exclude;if(n){var o=n===r.include?1:-1,i=n[e];if("boolean"==typeof i)return 1===o?function(e){return i}:function(e){return!i};if(Array.isArray(i))return t?function(e){return!0}:1===o?function(e){return i.indexOf(e)>-1}:function(e){return-1===i.indexOf(e)};if(1===o)return function(e){return!1}}}function P(e,r){return Promise.resolve().then((function(){r=w("save",r);var t=m(e,r);return r.persistenceAdapter.exists(t)}))}function O(e,r){return Promise.resolve().then((function(){var t,n,o,i;r=w("save",r);var a=m(e,r),u={},c=C(e,r);try{for(var d=s(f.getRootSections()),h=d.next();!h.done;h=d.next()){var p=l(h.value,2),v=p[0],y=p[1],b=k(v,r,!0);if(!b||b(v)){var x=y.stateMatcher(u),P=S(c,y,"serialize"),O=f.getDefinitionsForSection(v);try{for(var I=(o=void 0,s(O)),_=I.next();!_.done;_=I.next()){g(_.value,x,P)}}catch(e){o={error:e}}finally{try{_&&!_.done&&(i=I.return)&&i.call(I)}finally{if(o)throw o.error}}}}}catch(e){t={error:e}}finally{try{h&&!h.done&&(n=d.return)&&n.call(d)}finally{if(t)throw t.error}}return r.persistenceAdapter.save(a,u)}))}function I(e,r){return Promise.resolve().then((function(){r=w("load",r);var t=m(e,r);return r.persistenceAdapter.load(t).then((function(t){var n,o,i,a,u=C(e,r);try{for(var c=s(f.getRootSections()),d=c.next();!d.done;d=c.next()){var h=l(d.value,2),p=h[0],v=h[1],y=k(p,r,!0);if(!y||y(p)){var m=v.stateMatcher(t),g=S(u,v,"deserialize"),w=f.getDefinitionsForSection(p);try{for(var x=(i=void 0,s(w)),P=x.next();!P.done;P=x.next()){b(P.value,m,g)}}catch(e){i={error:e}}finally{try{P&&!P.done&&(a=x.return)&&a.call(x)}finally{if(i)throw i.error}}}}}catch(e){n={error:e}}finally{try{d&&!d.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}return t}))}))}function _(){f.registerRootChunkSection("grid",{sourceMatcher:function(e){return e.grid},stateMatcher:function(e){return e.grid||(e.grid={})}}),v("grid").handleKeys("showHeader","showFooter","focusMode","usePagination","hideColumns","fallbackMinHeight").serialize((function(e,r){return r.source[e]})).deserialize((function(e,r,t){t.source[e]=r})).register()}function A(e,r,t){var n,o,i=[];try{for(var a=s(t),u=a.next();!u.done;u=a.next()){var l=u.value,c={};r.runChildChunk(e,c,l),i.push(c)}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}return i}function z(e,r,t){var n,o,i=t.extApi.columnStore,a=t.source.table;try{for(var u=s(["header","footer"]),l=u.next();!l.done;l=u.next()){var c=l.value,d="s"===e?a:r,f=d===a?r:a;if(d[c]){var h="header"===c?i.headerColumnDef:i.footerColumnDef;f[c]||(f[c]={}),t.runChildChunk("dataMetaRow",r[c],a[c],{kind:c,active:h})}}}catch(e){n={error:e}}finally{try{l&&!l.done&&(o=u.return)&&o.call(u)}finally{if(n)throw n.error}}}function K(e,t,n){var o,i,a=n.source.table,u="s"===e?a:t,l=u===t?function(e){return{colState:e,pblColumn:a.cols.find((function(t){return r.utils.isPblColumn(t)&&t.orgProp===e.prop||t.id===e.id||t.prop===e.prop}))}}:function(e){return{colState:t.cols[t.cols.push({})-1],pblColumn:r.utils.isPblColumn(e)&&e}};if(u.cols&&u.cols.length>0)try{for(var c=s(u.cols),d=c.next();!d.done;d=c.next()){var f=d.value,h=l(f),p=h.colState,v=h.pblColumn,y={pblColumn:r.utils.isPblColumn(v)&&v,activeColumn:n.grid.columnApi.findColumn(f.id||f.prop)};n.runChildChunk("dataColumn",p,v,y)}}catch(e){o={error:e}}finally{try{d&&!d.done&&(i=c.return)&&i.call(c)}finally{if(o)throw o.error}}}function R(){f.registerRootChunkSection("columns",{sourceMatcher:function(e){return e.grid.columns},stateMatcher:function(e){return e.columns||(e.columns={table:{cols:[]},header:[],footer:[],headerGroup:[]})}}),v("columns").handleKeys("table","header","headerGroup","footer").serialize((function(e,r){var t,n,o,i;switch(e){case"table":var a={cols:[]};return z("s",a,r),K("s",a,r),a;case"header":case"footer":var u=r.source[e];if(u&&u.length>0){var l=[],c=function(t){r.extApi.columnStore.metaColumnIds[e].find((function(e){return!e.isGroup&&e.rowDef.rowIndex===t.rowIndex}));var n={};r.runChildChunk("metaRow",n,t),n.cols=A("metaColumn",r,t.cols),l.push(n)};try{for(var d=s(u),f=d.next();!f.done;f=d.next()){c(f.value)}}catch(e){t={error:e}}finally{try{f&&!f.done&&(n=d.return)&&n.call(d)}finally{if(t)throw t.error}}return l}break;case"headerGroup":var h=r.source.headerGroup;if(h&&h.length>0){l=[];var p=function(e){r.extApi.columnStore.metaColumnIds.header.find((function(r){return!r.isGroup&&r.rowDef.rowIndex===e.rowIndex}));var t={};r.runChildChunk("metaGroupRow",t,e),t.cols=A("metaColumn",r,e.cols),l.push(t)};try{for(var v=s(h),y=v.next();!y.done;y=v.next()){p(y.value)}}catch(e){o={error:e}}finally{try{y&&!y.done&&(i=v.return)&&i.call(v)}finally{if(o)throw o.error}}return l}}})).deserialize((function(e,r,t){var n,o;switch(e){case"table":var i=r;z("d",i,t),K("d",i,t);break;case"header":case"footer":var a=t.source[e],u=r;if(u&&u.length>0){var l=function(r){var n,o,i=a.find((function(e){return e.rowIndex===r.rowIndex}));if(i){t.extApi.columnStore.metaColumnIds[e].find((function(e){return!e.isGroup&&e.rowDef.rowIndex===r.rowIndex}));t.runChildChunk("metaRow",r,i);var u=function(e){var r=i.cols.find((function(r){return r.id===e.id}));if(r){var n=t.extApi.columnStore.find(e.id);n&&n.header;t.runChildChunk("metaColumn",e,r)}};try{for(var l=(n=void 0,s(r.cols)),c=l.next();!c.done;c=l.next()){u(c.value)}}catch(e){n={error:e}}finally{try{c&&!c.done&&(o=l.return)&&o.call(l)}finally{if(n)throw n.error}}}};try{for(var c=s(u),d=c.next();!d.done;d=c.next()){l(d.value)}}catch(e){n={error:e}}finally{try{d&&!d.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}}}})).register(),v("dataColumn").requiredKeys("id","prop").handleKeys("label","css","type","width","minWidth","maxWidth","headerType","footerType","sort","sortAlias","editable","pin").serialize((function(e,r){var t=r.data.activeColumn||r.data.pblColumn;if(t)switch(e){case"prop":return t.orgProp}var n=t?t[e]:r.source[e];switch(e){case"sort":return"boolean"==typeof n?n:void 0}return n})).deserialize((function(e,r,t){var n=t.data.activeColumn;if(n)switch(e){case"width":n.updateWidth(r)}if(t.source){switch(e){case"prop":return;case"type":case"headerType":case"footerType":var o=t.source[e],i=r;if(i&&"string"!=typeof i&&o&&"string"!=typeof o)return o.name=i.name,void(i.data&&(o.data=Object.assign(o.data||{},i.data)))}t.source[e]=r}})).register(),v("dataMetaRow").handleKeys("rowClassName","type").serialize((function(e,r){var t=r.data.active||r.source;if(t)return t[e]})).deserialize((function(e,r,t){t.source[e]=r})).register(),v("metaRow").handleKeys("rowClassName","type","rowIndex").serialize((function(e,r){return r.source[e]})).deserialize((function(e,r,t){})).register(),v("metaGroupRow").handleKeys("rowClassName","type","rowIndex").serialize((function(e,r){return r.source[e]})).deserialize((function(e,r,t){})).register(),v("metaColumn").requiredKeys("kind","rowIndex").handleKeys("id","label","css","type","width","minWidth","maxWidth").serialize((function(e,r){return r.source[e]})).deserialize((function(e,r,t){})).register(),v("metaGroupColumn").requiredKeys("prop","rowIndex","span").handleKeys("id","label","css","type","width","minWidth","maxWidth").serialize((function(e,r){return r.source[e]})).deserialize((function(e,r,t){})).register()}function G(){f.registerRootChunkSection("columnOrder",{sourceMatcher:function(e){return e.grid.columnApi},stateMatcher:function(e){return e.columnOrder||(e.columnOrder=[]),e}}),v("columnOrder").handleKeys("columnOrder").serialize((function(e,r){return r.source.visibleColumnIds.slice()})).deserialize((function(e,r,t){var n,o=t.extApi,i=t.grid,a=i.columnApi.visibleColumnIds;if(r&&r.length===a.length)for(var u=0,s=r.length;u<s;u++)if(r[u]!==a[u]){var l=i.columnApi.findColumn(r[u]);if(!l)return;var c=i.columnApi.findColumn(a[u]);n=[l,c],i.columnApi.moveColumn(l,c,!0),o.columnStore.updateGroups()}n&&(i.columnApi.moveColumn(n[1],n[0],!0),i.columnApi.moveColumn(n[0],n[1],t.options.avoidRedraw))})).register()}function M(){for(var e,r,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var o={grid:["hideColumns","showFooter","showHeader"],columnOrder:!0,columns:["table"],dataColumn:["width"]};if(t.length>0)try{for(var i=s(t),a=i.next();!a.done;a=i.next()){var u=a.value;j(o,u)}}catch(r){e={error:r}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return o}function j(e,r){var t,n;try{for(var o=s(Object.keys(r)),i=o.next();!i.done;i=o.next()){var a=i.value,u=r[a];if(a in e){var l=e[a];if(Array.isArray(l)&&Array.isArray(u)){var d=new Set(c(l,u));e[a]=Array.from(d.values())}}else e[a]=r[a]}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}}var N=function(){function e(e,r,o){var i=this;this.grid=e,this.injector=r,this.pluginCtrl=o,this._events=new t.Subject,this._removePlugin=o.setPlugin("state",this),this.afterLoadState=this._events.pipe(n.filter((function(e){return"load"===e.phase&&"after"===e.position})),n.mapTo(void 0)),this.afterSaveState=this._events.pipe(n.filter((function(e){return"save"===e.phase&&"after"===e.position})),n.mapTo(void 0)),this.onError=this._events.pipe(n.filter((function(e){return!!e.error})),n.map((function(e){return{phase:e.phase,error:e.error}}))),o.events.pipe(n.filter((function(e){return"onInvalidateHeaders"===e.kind})),n.take(1)).subscribe((function(r){var t=u(u({},i.loadOptions||{}),{avoidRedraw:!0});P(e,t).then((function(e){if(e)return i._load(t)})).then((function(){o.events.pipe(n.filter((function(e){return"onResizeRow"===e.kind})),n.skip(1),n.debounceTime(500)).subscribe((function(e){return i.save()}))}))})),o.events.subscribe((function(e){"onDestroy"===e.kind&&(e.wait(i.save()),i._events.complete())}))}return e.create=function(t,n){return new e(t,n,r.PblNgridPluginController.find(t))},e.prototype.load=function(){return this._load(this.loadOptions)},e.prototype.save=function(){var e=this;return O(this.grid,this.saveOptions).then((function(){return e._events.next({phase:"save",position:"after"})})).catch((function(r){return e._events.next({phase:"save",position:"after",error:r})}))},e.prototype.destroy=function(){this._removePlugin(this.grid)},e.prototype._load=function(e){var r=this;return I(this.grid,e).then((function(){return r._events.next({phase:"load",position:"after"})})).catch((function(e){return r._events.next({phase:"load",position:"after",error:e})}))},e}();var D=function(e){function t(r,t,n){var o=e.call(this,r,t,n)||this;return o.loadOptions={include:M()},o.saveOptions={include:M()},o}return function(e,r){function t(){this.constructor=e}a(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}(t,e),t.prototype.ngOnDestroy=function(){this.destroy()},t.decorators=[{type:o.Directive,args:[{selector:"pbl-ngrid[persistState]",outputs:["afterLoadState","afterSaveState","onError"]}]}],t.ctorParameters=function(){return[{type:r.PblNgridComponent},{type:o.Injector},{type:r.PblNgridPluginController}]},t.propDecorators={loadOptions:[{type:o.Input}],saveOptions:[{type:o.Input}]},t}(N);function H(){_(),G(),R()}var F=function(){function e(e,t){e||r.PblNgridPluginController.created.subscribe((function(e){var r=t.get("state");if(r&&!0===r.autoEnable)var n=e.controller,o=n.events.subscribe((function(e){if("onInit"===e.kind){if(!n.hasPlugin("state")){var t=n.createPlugin("state");r.autoEnableOptions&&(t.loadOptions=r.autoEnableOptions.loadOptions,t.saveOptions=r.autoEnableOptions.saveOptions)}o.unsubscribe(),o=void 0}}))}))}return e.NGRID_PLUGIN=r.ngridPlugin({id:"state",factory:"create",runOnce:H},N),e.decorators=[{type:o.NgModule,args:[{imports:[i.CommonModule,r.PblNgridModule],declarations:[D],exports:[D],providers:[]}]}],e.ctorParameters=function(){return[{type:e,decorators:[{type:o.Optional},{type:o.SkipSelf}]},{type:r.PblNgridConfigService}]},e}();e.PblNgridLocalStoragePersistAdapter=h,e.PblNgridStatePlugin=N,e.PblNgridStatePluginModule=F,e.StateVisor=d,e.createStateChunkHandler=v,e.hasState=P,e.loadState=I,e.registerColumnDefHandlers=R,e.registerColumnOrderHandlers=G,e.registerGridHandlers=_,e.saveState=O,e.stateVisor=f,e.userSessionPref=M,e.ɵb=p,e.ɵc="state",e.ɵd=D,e.ɵe=H,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=pebula-ngrid-state.umd.min.js.map