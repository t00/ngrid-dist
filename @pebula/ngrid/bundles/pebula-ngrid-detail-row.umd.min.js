!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/cdk/coercion"),require("@pebula/utils"),require("@pebula/ngrid"),require("@angular/cdk/table"),require("@angular/common"),require("@pebula/ngrid/target-events"),require("@angular/cdk/keycodes")):"function"==typeof define&&define.amd?define("@pebula/ngrid/detail-row",["exports","@angular/core","@angular/cdk/coercion","@pebula/utils","@pebula/ngrid","@angular/cdk/table","@angular/common","@pebula/ngrid/target-events","@angular/cdk/keycodes"],t):t(((e=e||self).pebula=e.pebula||{},e.pebula.ngrid=e.pebula.ngrid||{},e.pebula.ngrid["detail-row"]={}),e.ng.core,e.ng.cdk.coercion,e.pebula.utils,e.pebula.ngrid,e.ng.cdk.table,e.ng.common,e.pebula.ngrid["target-events"],e.ng.cdk.keycodes)}(this,(function(e,t,o,n,i,r,a,l,s){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var c=function(e,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};function p(e,t){function o(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}function u(e,t,o,n){var i,r=arguments.length,a=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,n);else for(var l=e.length-1;l>=0;l--)(i=e[l])&&(a=(r<3?i(a):r>3?i(t,o,a):i(t,o))||a);return r>3&&a&&Object.defineProperty(t,o,a),a}function d(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function g(e){var t="function"==typeof Symbol&&e[Symbol.iterator],o=0;return t?t.call(e):{next:function(){return e&&o>=e.length&&(e=void 0),{value:e&&e[o++],done:!e}}}}var f=function(e){function o(t,o){var n=e.call(this,t,o)||this;return n.kind="detailRow",n}return p(o,e),o.decorators=[{type:t.Directive,args:[{selector:"[pblNgridDetailRowDef]"}]}],o.ctorParameters=function(){return[{type:t.TemplateRef},{type:i.PblNgridRegistryService}]},o}(i.PblNgridSingleTemplateRegistry);var h=function(e){function o(t,o,n){var i=e.call(this,t,o)||this;return i.registry=n,i}return p(o,e),o.prototype.clone=function(){var e=Object.create(this);return this._columnsDiffer=this.columns=void 0,e},o.prototype.ngOnInit=function(){this.registry.setSingle("detailRowParent",this)},o.prototype.ngOnDestroy=function(){this.registry.setSingle("detailRowParent",void 0)},o.decorators=[{type:t.Directive,args:[{selector:"[pblNgridDetailRowParentRef]",inputs:["columns: pblNgridDetailRowParentRef","when: pblNgridDetailRowParentRefWhen"]}]}],o.ctorParameters=function(){return[{type:t.TemplateRef},{type:t.IterableDiffers},{type:i.PblNgridRegistryService}]},o}(r.CdkRowDef);var w=function(){function e(){}return e.decorators=[{type:t.Component,args:[{selector:"pbl-ngrid-default-detail-row-parent",template:'<pbl-ngrid-row *pblNgridDetailRowParentRef="let row; gridInstance as gridInstance" [grid]="gridInstance" [detailRow]="row"></pbl-ngrid-row>'}]}],e}(),R="detailRow",b=function(){return!0},y=function(){return!1};var v=function(){function e(e,o,n){var i=this;this.table=e,this.injector=n,this.whenContextChange="render",this.toggleChange=new t.EventEmitter,this.toggledRowContextChange=new t.EventEmitter,this._isSimpleRow=b,this._isDetailRow=y,this._detailRowRows=new Map,this._removePlugin=o.setPlugin(R,this);var r=o.events.subscribe((function(t){"onInit"===t.kind&&(r.unsubscribe(),r=void 0,o.hasPlugin("targetEvents")||o.createPlugin("targetEvents"),e.registry.changes.subscribe((function(t){var o,n;try{for(var r=g(t),a=r.next();!a.done;a=r.next()){var l=a.value;switch(l.type){case"detailRowParent":"remove"===l.op&&(e._cdkTable.removeRowDef(l.value),i._detailRowDef=void 0),i.setupDetailRowParent()}}}catch(e){o={error:e}}finally{try{a&&!a.done&&(n=r.return)&&n.call(r)}finally{if(o)throw o.error}}})),i._detailRow?i.updateTable():i.setupDetailRowParent())}))}return Object.defineProperty(e.prototype,"detailRow",{get:function(){return this._detailRow},set:function(e){if(this._detailRow!==e){var t=this.table;"function"==typeof e?(this._isSimpleRow=function(t,o){return!e(t,o)},this._isDetailRow=e):(e=o.coerceBooleanProperty(e),this._isDetailRow=e?b:y,this._isSimpleRow=e?y:b),this._detailRow=e,t.isInit&&this.updateTable()}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"singleDetailRow",{set:function(e){var t=this;e=o.coerceBooleanProperty(e),this._forceSingle!==e&&(this._forceSingle=e,e&&this._openedRow&&this._openedRow.expended&&this._detailRowRows.forEach((function(e){e.row!==t._openedRow.row&&e.toggle(!1)})))},enumerable:!0,configurable:!0}),e.prototype.addDetailRow=function(e){this._detailRowRows.set(e.row,e)},e.prototype.removeDetailRow=function(e){this._detailRowRows.delete(e.row)},e.prototype.toggleDetailRow=function(e,t){var o=this._detailRowRows.get(e);if(o)return o.toggle(t),o.expended},e.prototype.ngOnDestroy=function(){this._defaultParentRef&&this._defaultParentRef.destroy(),this._removePlugin(this.table)},e.prototype.detailRowToggled=function(e){var t=this._openedRow&&this._openedRow.row===e.row;e.expended?(this._forceSingle&&this._openedRow&&this._openedRow.expended&&!t&&this._openedRow.toggle(),this._openedRow=e):t&&(this._openedRow=void 0),this.toggleChange.emit(e)},e.prototype.setupDetailRowParent=function(){var e=this,o=this.table,n=o._cdkTable;if(this._detailRowDef&&(n.removeRowDef(this._detailRowDef),this._detailRowDef=void 0),this.detailRow){var i=o.registry.getSingle("detailRowParent");if(i)this._detailRowDef=i=i.clone(),Object.defineProperty(i,"columns",{enumerable:!0,get:function(){return o.columnApi.visibleColumnIds}}),Object.defineProperty(i,"when",{enumerable:!0,get:function(){return e._isDetailRow}}),i.ngOnChanges({columns:{isFirstChange:function(){return!0},firstChange:!0,currentValue:i.columns,previousValue:null}});else if(!this._defaultParentRef)return this._defaultParentRef=this.injector.get(t.ComponentFactoryResolver).resolveComponentFactory(w).create(this.injector),void this._defaultParentRef.changeDetectorRef.detectChanges()}this.resetTableRowDefs()},e.prototype.resetTableRowDefs=function(){var e=this.table;this._detailRowDef&&(!1===this._detailRow?e._cdkTable.removeRowDef(this._detailRowDef):e._cdkTable.addRowDef(this._detailRowDef))},e.prototype.updateTable=function(){this.table._tableRowDef.when=this._isSimpleRow,this.setupDetailRowParent(),this.table._cdkTable.updateRowDefCache(),this.table._cdkTable.multiTemplateDataRows=!!this._detailRow},e.ctorParameters=function(){return[{type:i.PblNgridComponent},{type:i.PblNgridPluginController},{type:t.Injector}]},e.decorators=[{type:t.Directive,args:[{selector:"pbl-ngrid[detailRow]",exportAs:"pblNgridDetailRow"}]}],e.ctorParameters=function(){return[{type:i.PblNgridComponent},{type:i.PblNgridPluginController},{type:t.Injector}]},e.propDecorators={detailRow:[{type:t.Input}],singleDetailRow:[{type:t.Input}],excludeToggleFrom:[{type:t.Input}],whenContextChange:[{type:t.Input}],toggleChange:[{type:t.Output}],toggledRowContextChange:[{type:t.Output}]},e=u([i.TablePlugin({id:R}),n.UnRx(),d("design:paramtypes",[i.PblNgridComponent,i.PblNgridPluginController,t.Injector])],e)}();var m=function(e){function o(t,o,n){var i=e.call(this,t,o)||this;return i.vcRef=n,i.opened=!1,i}var a;return p(o,e),a=o,Object.defineProperty(o.prototype,"expended",{get:function(){return this.opened},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"row",{set:function(e){this.updateRow()},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"_element",{get:function(){return this.el.nativeElement},enumerable:!0,configurable:!0}),o.prototype.ngOnInit=function(){var e=this,t=i.PblNgridPluginController.find(this.extApi.table);this.plugin=t.getPlugin(R),this.plugin.addDetailRow(this);var o=t.getPlugin("targetEvents");o.cellClick.pipe(n.UnRx(this)).subscribe((function(t){if("data"===t.type&&t.row===e.context.$implicit){var o=e.plugin.excludeToggleFrom;o&&o.some((function(e){return t.column.id===e}))||e.toggle()}})),o.rowClick.pipe(n.UnRx(this)).subscribe((function(t){t.root||"data"!==t.type||t.row!==e.context.$implicit||e.toggle()}))},o.prototype.ngOnDestroy=function(){this.plugin.removeDetailRow(this)},o.prototype.updateRow=function(){var t=this.context&&this.context.$implicit;if(e.prototype.updateRow.call(this),this.opened){var o=this.context&&this.context.$implicit;if(o!==t&&o){switch(this.plugin.whenContextChange){case"render":this.render();break;case"close":this.toggle(!1)}this.plugin.toggledRowContextChange.next(this.createEvent())}}},o.prototype.toggle=function(e){this.opened!==e&&(this.opened?(this.vcRef.clear(),this._element.classList.remove("pbl-row-detail-opened")):this.render(),this.opened=this.vcRef.length>0,this.opened&&this._element.classList.add("pbl-row-detail-opened"),this.plugin.detailRowToggled(this.createEvent()))},o.prototype.handleKeydown=function(e){if(e.target===this._element){var t=e.keyCode;(t===s.ENTER||t===s.SPACE)&&(e.preventDefault(),this.toggle())}},o.prototype.createEvent=function(){var e=Object.create(this);return Object.defineProperty(e,"row",{value:this.context.$implicit}),e},o.prototype.render=function(){if(this.vcRef.clear(),this.context.$implicit){var e=this.context.table.registry.getSingle("detailRow");e&&this.vcRef.createEmbeddedView(e.tRef,this.context)}},o.ctorParameters=function(){return[{type:void 0},{type:t.ElementRef},{type:t.ViewContainerRef}]},o.decorators=[{type:t.Component,args:[{selector:"pbl-ngrid-row[detailRow]",exportAs:"pblNgridDetailRow",host:{class:"pbl-ngrid-row pbl-row-detail-parent",role:"row","[attr.tabindex]":"grid?.rowFocus","(keydown)":"handleKeydown($event)"},template:r.CDK_ROW_TEMPLATE,providers:[{provide:r.CdkRow,useExisting:a}],changeDetection:t.ChangeDetectionStrategy.OnPush,encapsulation:t.ViewEncapsulation.None,styles:[".pbl-row-detail-parent { position: relative; cursor: pointer; }"]}]}],o.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Optional},{type:t.Inject,args:[i.EXT_API_TOKEN]}]},{type:t.ElementRef},{type:t.ViewContainerRef}]},o.propDecorators={row:[{type:t.Input,args:["detailRow"]}]},o=a=u([n.UnRx(),d("design:paramtypes",[Object,t.ElementRef,t.ViewContainerRef])],o)}(i.PblNgridRowComponent);var _=[v,m,h,f],P=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{imports:[a.CommonModule,r.CdkTableModule,i.PblNgridModule,l.PblNgridTargetEventsModule],declarations:[_,w],exports:[_],entryComponents:[m,w]}]}],e}();e.PblNgridDetailRowModule=P,e.toggleDetailRow=function(e,t,o){var n=i.PblNgridPluginController.find(e);if(n){var r=n.getPlugin(R);if(r)return r.toggleDetailRow(t,o)}},e.ɵa=R,e.ɵb=v,e.ɵc=m,e.ɵd=f,e.ɵe=h,e.ɵf=w,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=pebula-ngrid-detail-row.umd.min.js.map