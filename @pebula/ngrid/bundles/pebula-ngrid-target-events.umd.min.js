!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs"),require("rxjs/operators"),require("@angular/core"),require("@pebula/utils"),require("@pebula/ngrid"),require("@angular/cdk/keycodes"),require("@angular/common"),require("@angular/cdk/table"),require("@angular/cdk/coercion")):"function"==typeof define&&define.amd?define("@pebula/ngrid/target-events",["exports","rxjs","rxjs/operators","@angular/core","@pebula/utils","@pebula/ngrid","@angular/cdk/keycodes","@angular/common","@angular/cdk/table","@angular/cdk/coercion"],t):t(((e=e||self).pebula=e.pebula||{},e.pebula.ngrid=e.pebula.ngrid||{},e.pebula.ngrid["target-events"]={}),e.rxjs,e.rxjs.operators,e.ng.core,e.pebula.utils,e.pebula.ngrid,e.ng.cdk.keycodes,e.ng.common,e.ng.cdk.table,e.ng.cdk.coercion)}(this,(function(e,t,r,n,o,i,l,c,a,u){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var d=function(){return(d=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function p(e,t,r,n){var o,i=arguments.length,l=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(o=e[c])&&(l=(i<3?o(l):i>3?o(t,r,l):o(t,r))||l);return i>3&&l&&Object.defineProperty(t,r,l),l}function f(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function g(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function y(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),l=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)l.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return l}function v(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(y(arguments[t]));return e}function b(e){return!!e.cellTarget}function w(e){return b(e)&&!!e.context}function h(e){return"row"===e.getAttribute("role")}function m(e){for(;e.parentElement;){if(h(e.parentElement))return e;e=e.parentElement}}function C(e,t){var r=e.getAttribute("data-rowtype")||"data",n=0;switch(r){case"data":for(var o=e;e.previousElementSibling;)n++,e=e.previousElementSibling;for(n=Math.min(n,t.length-1);n>-1;){if(t.get(n).rootNodes[0]===o)return{type:"data",subType:"data",rowIndex:n};n--}return;case"header":case"footer":return{type:r,subType:"data",rowIndex:n};default:for(;e.previousElementSibling&&e.previousElementSibling.getAttribute("data-rowtype")===r;)n++,e=e.previousElementSibling;return({type:"meta-footer"===r?"footer":"header",subType:"meta",rowIndex:n})}}function x(e,t,r){var n,o,i,l,c=[];try{for(var a=g(r),u=a.next();!u.done;u=a.next()){var s=u.value;try{for(var d=g(t),p=d.next();!p.done;p=d.next()){var f=p.value;e.findRowInCache(s.rowIdent).cells[f.colIndex]&&c.push({rowIdent:s.rowIdent,colIndex:f.colIndex})}}catch(e){i={error:e}}finally{try{p&&!p.done&&(l=d.return)&&l.call(d)}finally{if(i)throw i.error}}}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(n)throw n.error}}return c}var k=/^mac/.test(navigator.platform.toLowerCase()),I=function(e){return 0===e.source.button};function E(e){var t=function(){return"cell"===e.table.focusMode},n=function(e){var t=e.table.contextApi;function r(e){var r,n,o=e.context,i=t.focusedCell||{rowIdent:o.rowContext.identity,colIndex:o.index},l=t.findRowInCache(i.rowIdent),c=[],a=[];try{for(var u=g(function(e,t){for(var r=Math.min(e,t),n=r===e?t:e,o=[],i=r+1;i<n;i++)o.push(i);return o}(i.colIndex,o.index)),s=u.next();!s.done;s=u.next()){var d=s.value;c.push({rowIdent:i.rowIdent,colIndex:d})}}catch(e){r={error:e}}finally{try{s&&!s.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}c.push({rowIdent:i.rowIdent,colIndex:o.index});var p=Math.abs(o.rowContext.dataIndex-l.dataIndex),f=l.dataIndex>o.rowContext.dataIndex?-1:1;for(d=1;d<=p;d++){var y=t.findRowInCache(i.rowIdent,f*d,!0);a.push({rowIdent:y.identity,colIndex:i.colIndex})}var b=x(t,c,a);t.selectCells(v([i],c,a,b),!1,!0)}return{handleMouseDown:function(e){var n,o,i;t.focusedCell&&e.source.shiftKey?r(e):(k?e.source.metaKey:e.source.ctrlKey)?e.context.selected?t.unselectCells([e.context]):t.selectCells([e.context]):(n=e.context.rowContext.identity,o=e.context.index,t.focusCell({rowIdent:n,colIndex:o},i))},handleKeyDown:function(e){var r,n,o,i=e.source;if(b(e)){var c=e.cellTarget,a=1,u=void 0;switch(i.keyCode){case l.UP_ARROW:a=-1;case l.DOWN_ARROW:u="v";break;case l.LEFT_ARROW:a=-1;case l.RIGHT_ARROW:u="h";break;default:return}var s=t.getCell(c),d=t.focusedCell||{rowIdent:s.rowContext.identity,colIndex:s.index};i.shiftKey?function(e,r){var n=e.rowIdent,o=e.colIndex,i=t.findRowInCache(n),l=y(r,2),c=l[0],a=l[1],u=[i.cells[o-1],i.cells[o+1]],s=[t.findRowInCache(n,-1,!0),t.findRowInCache(n,1,!0)],d=(u[0]&&u[0].selected?-1:0)+(u[1]&&u[1].selected?1:0),p=(s[0]&&s[0].cells[o].selected?-1:0)+(s[1]&&s[1].cells[o].selected?1:0);0===d&&(d+=c);0===p&&(p+=a);var f=[];if(0!==d){for(var g=o,b=i.cells[o];b&&b.selected;)f.push({rowIdent:n,colIndex:g}),g+=d,b=i.cells[g];c&&(d===c?b&&f.push({rowIdent:n,colIndex:g}):f.pop())}var w=[];if(0!==p){for(var h=n,m=t.findRowInCache(h,p,!0);m&&m.cells[o].selected;)h=m.identity,w.push({rowIdent:h,colIndex:o}),m=t.findRowInCache(h,p,!0);a&&(p===a?m&&w.push({rowIdent:m.identity,colIndex:o}):w.pop())}var C=x(t,f,w);t.selectCells(v([e],f,w,C),!1,!0)}(d,"h"===u?[a,0]:[0,a]):(r=d,n="h"===u?[a,0]:[0,a],(o=t.findRowInCache(r.rowIdent,n[1],!0))&&t.focusCell({rowIdent:o.identity,colIndex:r.colIndex+n[0]},!0))}},handleSelectionChangeByMouseClickAndMove:r}}(e);e.keyDown.pipe(r.filter(t)).subscribe(n.handleKeyDown),e.mouseDown.pipe(r.filter(t),r.filter(w),r.filter(I),r.tap((function(e){e.source.stopPropagation(),e.source.preventDefault()})),r.tap(n.handleMouseDown),r.switchMap((function(){return e.cellEnter.pipe(r.takeUntil(e.mouseUp))})),r.filter(w),r.filter(I)).subscribe(n.handleSelectionChangeByMouseClickAndMove)}var P="targetEvents";function D(e){return e.observers.length>0}function R(){i.PblColumn.extendProperty("editable")}var T=function(){function e(e,r,o){var i=this;if(this.table=e,this.injector=r,this.pluginCtrl=o,this.rowClick=new n.EventEmitter,this.rowDblClick=new n.EventEmitter,this.rowEnter=new n.EventEmitter,this.rowLeave=new n.EventEmitter,this.cellClick=new n.EventEmitter,this.cellDblClick=new n.EventEmitter,this.cellEnter=new n.EventEmitter,this.cellLeave=new n.EventEmitter,this.mouseDown=new n.EventEmitter,this.mouseUp=new n.EventEmitter,this.keyUp=new n.EventEmitter,this.keyDown=new n.EventEmitter,this.destroyed=new t.ReplaySubject,this._removePlugin=o.setPlugin(P,this),this.cdr=r.get(n.ChangeDetectorRef),e.isInit)this.init();else var l=o.events.subscribe((function(e){"onInit"===e.kind&&(i.init(),l.unsubscribe(),l=void 0)}))}var o;return o=e,e.create=function(e,t){var r=i.PblNgridPluginController.find(e);return new o(e,t,r)},e.prototype.init=function(){this.setupDomEvents(),E(this)},e.prototype.setupDomEvents=function(){var e,n,o=this,i=this.table,l=i._cdkTable,c=l._element,a=function(e,t){var r,n,c=e.parentElement,a=C(c,l._rowOutlet.viewContainer);if(a){var u=d({},a,{source:t,cellTarget:e,rowTarget:c});if("data"===a.type)u.row=i.ds.renderedData[a.rowIndex];else if("meta"===u.subType){var s=o.pluginCtrl.extApi.metaRowService,p="header"===u.type?s.header:s.footer;try{for(var f=g([p.fixed,p.row,p.sticky]),y=f.next();!y.done;y=f.next()){var v=y.value.find((function(e){return e.el===u.rowTarget}));if(v){u.rowIndex=v.index;break}}}catch(e){r={error:e}}finally{try{y&&!y.done&&(n=f.return)&&n.call(f)}finally{if(r)throw r.error}}}if(u.colIndex=function(e){for(var t=0;e=e.previousElementSibling;)t++;return t}(e),"data"===a.subType){var b=o.table.columnApi.findColumnAt(u.colIndex),w=o.table.columnApi.indexOf(b);u.column=b,u.context=o.pluginCtrl.extApi.contextApi.getCell(u.rowIndex,w)}else{var h=o.pluginCtrl.extApi.columnStore,m=h.metaColumnIds[a.type][u.rowIndex],x=h.find(m.keys[u.colIndex]);m.isGroup?(u.subType="meta-group",u.column="header"===a.type?x.headerGroup:x.footerGroup):u.column="header"===a.type?x.header:x.footer}return u}},u=function(e,t,r){if(r){var n={source:t,rowTarget:e,type:r.type,subType:r.subType,rowIndex:r.rowIndex,root:r};return"data"===r.type&&(n.row=r.row,n.context=r.context.rowContext),n}var i=C(e,l._rowOutlet.viewContainer);if(i){var c=d({},i,{source:t,rowTarget:e});if("data"===i.type&&(c.context=o.pluginCtrl.extApi.contextApi.getRow(i.rowIndex),c.row=c.context.$implicit),"data"!==i.subType)o.pluginCtrl.extApi.columnStore.metaColumnIds[i.type][c.rowIndex].isGroup&&(c.subType="meta-group");return c}},s=function(t){if(e){var r=e;return o.cellLeave.emit(Object.assign({},r,{source:t})),e=void 0,r}},p=function(e){if(n){var t=n;return o.rowLeave.emit(Object.assign({},t,{source:e})),n=void 0,t}},f=function(e){var t,r,n=(r=m((t=e).target))?{type:"cell",target:r}:h(t.target)?{type:"cell",target:t.target}:void 0;if(n)if("cell"===n.type){var i=a(n.target,e);if(i)return{type:n.type,event:i,waitTime:D(o.cellDblClick)?250:1}}else if("row"===n.type){var l=u(n.target,e);if(l)return{type:n.type,event:l,waitTime:D(o.rowDblClick)?250:1}}},y=function(e){var t="cell"===e.type?e.event:void 0;return{cellEvent:t,rowEvent:t?u(t.rowTarget,t.source,t):e.event}},v=function(e,n){t.fromEvent(c,e).pipe(r.takeUntil(o.destroyed),r.filter((function(e){return D(n)})),r.map(f),r.filter((function(e){return!!e}))).subscribe((function(e){var t=y(e),r=t.cellEvent,i=t.rowEvent;n.emit(r||i),o.syncRow(r||i)}))};v("mouseup",this.mouseUp),v("mousedown",this.mouseDown),v("keyup",this.keyUp),v("keydown",this.keyDown);var b=t.fromEvent(c,"click").pipe(r.takeUntil(this.destroyed),r.filter((function(e){return D(o.cellClick)||D(o.cellDblClick)||D(o.rowClick)||D(o.rowDblClick)})),r.map(f),r.filter((function(e){return!!e})));b.pipe(r.bufferWhen((function(){return b.pipe(r.debounce((function(e){return t.timer(e.waitTime)})))})),r.filter((function(e){return e.length>0}))).subscribe((function(e){var t=e.shift(),r=1===e.length,n=y(t),i=n.cellEvent,l=n.rowEvent;r?(i&&o.cellDblClick.emit(i),o.rowDblClick.emit(l)):(i&&o.cellClick.emit(i),o.rowClick.emit(l)),o.syncRow(i||l)})),t.fromEvent(c,"mouseleave").pipe(r.takeUntil(this.destroyed)).subscribe((function(e){var t=s(e);(t=p(e)||t)&&o.syncRow(t)})),t.fromEvent(c,"mousemove").pipe(r.takeUntil(this.destroyed)).subscribe((function(t){var r,i,l=m(t.target),c=e&&e.cellTarget,d=n&&n.rowTarget;if(c!==l&&(i=s(t)||i),l){if(c===l)return;(r=a(l,t))&&o.cellEnter.emit(e=r)}var f=r&&r.rowTarget||h(t.target)&&t.target;if(d!==f&&(i=p(t)||i),f&&d!==f){var g=u(f,t,r);g&&o.rowEnter.emit(n=g)}i&&o.syncRow(i)}))},e.prototype.destroy=function(){this.destroyed.next(),this.destroyed.complete(),this._removePlugin(this.table)},e.prototype.syncRow=function(e){this.table._cdkTable.syncRows(e.type,e.rowIndex)},e.ctorParameters=function(){return[{type:i.PblNgridComponent},{type:n.Injector},{type:i.PblNgridPluginController}]},e=o=p([i.TablePlugin({id:P,factory:"create",runOnce:R}),f("design:paramtypes",[i.PblNgridComponent,n.Injector,i.PblNgridPluginController])],e)}();var j=function(e){function t(t,r,n){return e.call(this,t,r,n)||this}return function(e,t){function r(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}(t,e),t.prototype.ngOnDestroy=function(){this.destroy()},t.ctorParameters=function(){return[{type:i.PblNgridComponent},{type:n.Injector},{type:i.PblNgridPluginController}]},t.decorators=[{type:n.Directive,args:[{selector:"pbl-ngrid[targetEvents], pbl-ngrid[rowClick], pbl-ngrid[rowDblClick], pbl-ngrid[rowEnter], pbl-ngrid[rowLeave], pbl-ngrid[cellClick], pbl-ngrid[cellDblClick], pbl-ngrid[cellEnter], pbl-ngrid[cellLeave], pbl-ngrid[keyDown], pbl-ngrid[keyUp]",outputs:["rowClick","rowDblClick","rowEnter","rowLeave","cellClick","cellDblClick","cellEnter","cellLeave","keyDown","keyUp"]}]}],t.ctorParameters=function(){return[{type:i.PblNgridComponent},{type:n.Injector},{type:i.PblNgridPluginController}]},t=p([o.UnRx(),f("design:paramtypes",[i.PblNgridComponent,n.Injector,i.PblNgridPluginController])],t)}(T),_=function(){function e(e,t,r){var n=this;this._click=!1,this._dblClick=!1;var o=r.events.subscribe((function(e){"onInit"===e.kind&&(o.unsubscribe(),o=void 0,n.targetEventsPlugin=r.getPlugin("targetEvents")||r.createPlugin("targetEvents"),n.update())}))}return Object.defineProperty(e.prototype,"cellEditClick",{set:function(e){e=u.coerceBooleanProperty(e),this._click!==e&&(this._click=e,this.update())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cellEditDblClick",{set:function(e){e=u.coerceBooleanProperty(e),this._dblClick!==e&&(this._dblClick=e,this.update())},enumerable:!0,configurable:!0}),e.prototype.update=function(){this.targetEventsPlugin&&(o.UnRx.kill(this,this.targetEventsPlugin),this._click&&this.targetEventsPlugin.cellClick.pipe(o.UnRx(this,this.targetEventsPlugin)).subscribe((function(e){"data"===e.type&&e.column.editable&&e.context.startEdit(!0)})),this._dblClick&&this.targetEventsPlugin.cellDblClick.pipe(o.UnRx(this,this.targetEventsPlugin)).subscribe((function(e){"data"===e.type&&e.column.editable&&e.context.startEdit(!0)})))},e.ctorParameters=function(){return[{type:i.PblNgridComponent},{type:n.Injector},{type:i.PblNgridPluginController}]},e.decorators=[{type:n.Directive,args:[{selector:"pbl-ngrid[cellEditClick], pbl-ngrid[cellEditDblClick]"}]}],e.ctorParameters=function(){return[{type:i.PblNgridComponent},{type:n.Injector},{type:i.PblNgridPluginController}]},e.propDecorators={cellEditClick:[{type:n.Input}],cellEditDblClick:[{type:n.Input}]},e=p([o.UnRx(),f("design:paramtypes",[i.PblNgridComponent,n.Injector,i.PblNgridPluginController])],e)}();var O=function(){function e(e,t){e||i.PblNgridPluginController.created.subscribe((function(e){var r=t.get(P);if(r&&!0===r.autoEnable)var n=e.controller,o=n.events.subscribe((function(e){"onInit"===e.kind&&(n.hasPlugin(P)||n.createPlugin(P),o.unsubscribe(),o=void 0)}))}))}return e.decorators=[{type:n.NgModule,args:[{imports:[c.CommonModule,a.CdkTableModule,i.PblNgridModule],declarations:[j,_],exports:[j,_]}]}],e.ctorParameters=function(){return[{type:e,decorators:[{type:n.Optional},{type:n.SkipSelf}]},{type:i.PblNgridConfigService}]},e}();e.PblNgridTargetEventsModule=O,e.PblNgridTargetEventsPlugin=T,e.isCellEvent=b,e.isDataCellEvent=w,e.ɵa=P,e.ɵb=R,e.ɵc=j,e.ɵd=_,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=pebula-ngrid-target-events.umd.min.js.map